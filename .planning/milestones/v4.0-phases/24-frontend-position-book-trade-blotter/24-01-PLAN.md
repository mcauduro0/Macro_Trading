---
phase: 24-frontend-position-book-trade-blotter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/static/js/pms/pages/PositionBookPage.jsx
  - src/api/static/js/App.jsx
  - src/api/static/dashboard.html
autonomous: true
requirements:
  - PMS-FE-PB-01
  - PMS-FE-PB-02
  - PMS-FE-PB-03

must_haves:
  truths:
    - "Position Book page shows live positions grouped by asset class with collapsible sections and subtotals"
    - "Each position row shows Instrument, Direction, Size, Entry Price, Current Price, Unrealized P&L, DV01/Delta, VaR Contribution, Daily P&L, Holding Days"
    - "Clicking a position row expands to show strategy attribution, entry date, stop/target levels, and P&L spark chart"
    - "P&L summary cards display today, MTD, YTD, and total unrealized P&L"
    - "Equity curve chart shows cumulative P&L line, drawdown shaded overlay, and CDI benchmark with time range buttons"
    - "Inline close button on each position row opens confirmation dialog and calls close API"
  artifacts:
    - path: "src/api/static/js/pms/pages/PositionBookPage.jsx"
      provides: "Complete Position Book page with all sections"
      min_lines: 500
    - path: "src/api/static/js/App.jsx"
      provides: "PMS portfolio route wired to PositionBookPage"
    - path: "src/api/static/dashboard.html"
      provides: "PositionBookPage.jsx script tag in correct load order"
  key_links:
    - from: "PositionBookPage.jsx"
      to: "/api/v1/pms/book"
      via: "useFetch hook with 60s polling"
      pattern: "useFetch.*pms/book"
    - from: "PositionBookPage.jsx"
      to: "/api/v1/pms/pnl/equity-curve"
      via: "useFetch hook"
      pattern: "useFetch.*pms/pnl/equity-curve"
    - from: "PositionBookPage.jsx"
      to: "/api/v1/pms/book/positions/{id}/close"
      via: "fetch POST on close button click"
      pattern: "fetch.*positions.*close"
    - from: "App.jsx"
      to: "window.PositionBookPage"
      via: "Route element rendering"
      pattern: "PositionBookPage"
---

<objective>
Build the Position Book page for the PMS -- a Bloomberg PORT-style position viewer with asset class grouping, collapsible sections, P&L summary cards, equity curve chart with CDI benchmark, expandable position detail rows, and inline close actions.

Purpose: Give the portfolio manager a live view of all positions with P&L, risk metrics, and strategy attribution -- the core operational screen for position monitoring.
Output: PositionBookPage.jsx component with route wiring in App.jsx and script loading in dashboard.html.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-frontend-position-book-trade-blotter/24-CONTEXT.md
@.planning/phases/23-frontend-design-system-morning-pack-page/23-01-SUMMARY.md
@.planning/phases/23-frontend-design-system-morning-pack-page/23-02-SUMMARY.md

Key references (read these before implementing):
@src/api/static/js/pms/theme.jsx           — PMS_COLORS, PMS_TYPOGRAPHY, PMS_SPACING, helper functions
@src/api/static/js/pms/components.jsx       — PMSCard, PMSTable, PMSBadge, PMSGauge, PMSMetricCard, PMSSkeleton, PMSAlertBanner
@src/api/static/js/pms/pages/MorningPackPage.jsx — PMS page pattern (sample data, useFetch, window globals)
@src/api/static/js/pages/PortfolioPage.jsx  — ComposedChart equity curve + drawdown pattern (Recharts dual-axis)
@src/api/static/js/hooks.jsx                — useFetch hook
@src/api/static/js/App.jsx                  — Route wiring, PMSPlaceholder pattern
@src/api/static/dashboard.html              — Script loading order
@src/api/routes/pms_portfolio.py            — API endpoints for book, positions, close, equity-curve, pnl/summary
@src/api/schemas/pms_schemas.py             — PositionResponse, BookResponse, BookSummaryResponse, PnLPointResponse
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PositionBookPage.jsx with all sections</name>
  <files>src/api/static/js/pms/pages/PositionBookPage.jsx</files>
  <action>
Create PositionBookPage.jsx as a single-file PMS page component following the MorningPackPage.jsx pattern (window globals for React/Recharts/PMS design system, sample data fallback, useFetch polling).

**Data Fetching (3 endpoints, 60-second polling):**
- `useFetch('/api/v1/pms/book', 60000)` — full book with summary, positions, by_asset_class
- `useFetch('/api/v1/pms/pnl/equity-curve', 60000)` — timeseries for equity chart
- Each endpoint has comprehensive SAMPLE_* constants for fallback when API unavailable (seeded deterministic data)

**Sample Data Constants:**
- `SAMPLE_BOOK` — object with `summary` (aum: 150M, leverage: 1.2, open_positions: 12, pnl_today_brl: 245000, pnl_mtd_brl: 1820000, pnl_ytd_brl: 8450000, total_unrealized_pnl_brl: 3200000, total_realized_pnl_brl: 5250000), `positions` (12 sample positions across FX, Rates, Inflation, Cupom Cambial, Sovereign, Cross-Asset with realistic instruments: USDBRL NDF, DI1 Jan26, DI1 Jan27, NTN-B 2030, NTN-B 2035, DDI Jan26, CDS BR 5Y, IBOV FUT, DOL WDO, LTN 2025, UST 10Y, etc.), and `by_asset_class` (subtotals per group)
- `SAMPLE_EQUITY_CURVE` — 252 daily points (seeded PRNG, same pattern as PortfolioPage) with `snapshot_date`, `cumulative_pnl_brl`, `daily_pnl_brl`, plus CDI benchmark line (`cdi_cumulative`)
- Each position has: id, instrument, asset_class, direction, notional_brl, entry_price, current_price, unrealized_pnl_brl, entry_dv01, entry_delta, entry_var_contribution, entry_date, strategy_ids, notes (stop/target encoded), business_days (holding days)

**Section 1: P&L Summary Cards (horizontal strip)**
Use a horizontal row of compact metric cards (use inline PMS styles, not PMSMetricCard -- more control for dense layout). 5 cards:
- Today P&L (color-coded)
- MTD P&L (color-coded)
- YTD P&L (color-coded)
- Unrealized P&L (color-coded)
- AUM / Leverage (text)

Each card: small PMS_COLORS.bg.secondary box with PMS_TYPOGRAPHY.fontFamily, value in large font with pnlColor(), label in muted text above. Use flexbox row with gap.

**Section 2: Equity Curve Chart (full-width below cards, above table)**
Use Recharts ComposedChart with dual Y-axes (same pattern as v3 PortfolioPage):
- Left Y-axis: cumulative P&L (BRL) — `<Line>` component, blue (#58a6ff)
- Right Y-axis: drawdown % — `<Area>` component, red fill with transparency
- Additional `<Line>` for CDI benchmark cumulative return, dashed gray (#8b949e)
- X-axis: date labels
- Tooltip with dark PMS styling
- **Time range buttons**: 1M, 3M, 6M, YTD (default), 1Y, All — filter equity curve data by date range. Store selected range in useState. Filter logic: compute start date from range, slice data array.
- Chart container: PMS_COLORS.bg.secondary background, border, padding. Height ~220px via ResponsiveContainer.

**Section 3: Positions Table with Collapsible Asset Class Groups**
Bloomberg PORT-style grouped table. Implementation:
- Group positions by `asset_class` (FX, RATES, INFLATION, CUPOM_CAMBIAL, SOVEREIGN, CROSS_ASSET)
- Each group: clickable header row with asset class name + count + subtotal P&L. Clicking toggles visibility of that group's positions.
- useState for `expandedGroups` (Set of asset class names, all expanded by default)
- Column order (locked decision): Instrument | Direction | Size (notional_brl) | Entry Price | Current Price | Unrealized P&L | DV01/Delta | VaR Contribution | Daily P&L | Holding Days | Actions
- Direction column: PMSBadge with variant positive/negative for LONG/SHORT
- P&L columns: pnlColor() for text color, formatPnL() for formatting
- Size column: formatNumber() with abbreviated notation (e.g., 15.0M)
- DV01/Delta column: show entry_dv01 if set, else entry_delta, else '--'
- VaR Contribution: formatPercent() or formatNumber()
- Holding Days: business_days or compute from entry_date
- Actions column: inline "Close" button (small, PMS_COLORS.pnl.negative border). On click, show confirmation dialog.
- Group header row: darker bg (PMS_COLORS.bg.tertiary), semibold text, expand/collapse arrow icon, subtotal unrealized P&L
- Group subtotal computed: sum of unrealized_pnl_brl for positions in that group

**Section 3b: Expandable Row Detail**
Clicking a position row (not the close button) toggles an expanded detail section below that row. useState for `expandedRowId` (single row at a time).
- Show: Strategy IDs (comma-separated), Entry Date, Target Price (parsed from notes or position field), Stop Loss, Notes/Journal link
- Show a tiny inline SVG spark chart of recent P&L (last 10 data points from sample, use simple SVG polyline -- no Recharts for inline sparklines). Generate from seeded PRNG per position ID.
- Style: slightly indented, PMS_COLORS.bg.tertiary background, PMS_TYPOGRAPHY.sizes.xs font

**Section 4: Close Position Dialog**
Simple overlay dialog triggered by the close button:
- useState for `closingPosition` (position object or null)
- Dialog: centered modal overlay with semi-transparent backdrop
- Fields: Close Price (input, required), Manager Notes (textarea, optional)
- Buttons: "Confirm Close" (calls POST /api/v1/pms/book/positions/{id}/close), "Cancel"
- On success: remove position from local state or refetch. On error: show error message.
- Style: PMS_COLORS.bg.elevated background, PMS border, PMS font

**Window Global Exposure:**
```
window.PositionBookPage = PositionBookPage;
```

**Pattern Notes:**
- Access PMS theme via `window.PMS_THEME` destructured at top (same as MorningPackPage)
- Access Recharts via global `Recharts` object destructured at top
- Access React hooks via global `React` object
- Access useFetch via global `window.useFetch`
- All inline styles (no Tailwind classes for PMS-specific colors)
  </action>
  <verify>
File exists at src/api/static/js/pms/pages/PositionBookPage.jsx with 500+ lines. File includes:
- SAMPLE_BOOK and SAMPLE_EQUITY_CURVE constants
- useFetch calls to /api/v1/pms/book and /api/v1/pms/pnl/equity-curve
- ComposedChart with Line + Area + CDI benchmark
- Time range buttons (1M, 3M, 6M, YTD, 1Y, All)
- Asset class grouping with collapsible sections
- Expandable row detail with spark chart
- Close position dialog with confirmation
- window.PositionBookPage export
  </verify>
  <done>
PositionBookPage.jsx renders all 4 sections: P&L summary cards, equity curve with CDI benchmark and time range buttons, collapsible asset-class-grouped positions table with expandable detail rows and inline close buttons, and close confirmation dialog. Sample data fallback ensures page always renders without backend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire PositionBookPage into App.jsx routes and dashboard.html</name>
  <files>src/api/static/js/App.jsx, src/api/static/dashboard.html</files>
  <action>
**App.jsx changes:**
1. In the AppContent component, add below the MorningPackPage resolution line:
   ```
   const PositionBookPage = window.PositionBookPage;
   ```
2. Replace the PMS portfolio placeholder route:
   - Change: `<Route path="/pms/portfolio" element={<PMSPlaceholder title="Position Book" />} />`
   - To: `<Route path="/pms/portfolio" element={<PositionBookPage />} />`

**dashboard.html changes:**
1. Add a new script tag for PositionBookPage.jsx AFTER the MorningPackPage.jsx line and BEFORE Sidebar.jsx:
   ```
   <script type="text/babel" src="/static/js/pms/pages/PositionBookPage.jsx"></script>
   ```
   This goes between the MorningPackPage.jsx and Sidebar.jsx script tags to maintain the dependency order (PMS pages load after theme/components, before Sidebar and App).
  </action>
  <verify>
1. In App.jsx, grep for `PositionBookPage` — should appear in window resolution and Route element
2. In App.jsx, confirm no PMSPlaceholder for "Position Book" remains
3. In dashboard.html, grep for `PositionBookPage.jsx` — should appear as a script tag
4. Script loading order: theme.jsx → components.jsx → MorningPackPage.jsx → PositionBookPage.jsx → Sidebar.jsx → ... → App.jsx
  </verify>
  <done>
PositionBookPage renders at /pms/portfolio route when navigating via PMS sidebar. Script loads in correct order in dashboard.html. No placeholder remains for Position Book.
  </done>
</task>

</tasks>

<verification>
1. PositionBookPage.jsx file exists at src/api/static/js/pms/pages/PositionBookPage.jsx with 500+ lines
2. App.jsx has Route for /pms/portfolio pointing to PositionBookPage (not PMSPlaceholder)
3. dashboard.html has PositionBookPage.jsx script tag in correct order (after MorningPackPage, before Sidebar)
4. File references window.PMS_THEME for all color/typography tokens
5. File uses useFetch hook for 2 API endpoints with 60s polling
6. Sample data constants provide fallback for all endpoints
7. Equity curve uses Recharts ComposedChart with dual Y-axes (same pattern as v3 PortfolioPage)
8. Position table groups by asset class with collapsible sections
9. Expandable row detail shows strategy attribution, stop/target, spark chart
10. Close button triggers confirmation dialog calling POST close API
</verification>

<success_criteria>
- Position Book page renders with all 4 sections (P&L cards, equity chart, positions table, close dialog)
- Positions grouped by asset class with collapsible headers and subtotals
- Time range buttons filter equity curve chart data
- Expandable rows show position detail with spark chart
- Close dialog sends POST request to /api/v1/pms/book/positions/{id}/close
- All content styled with PMS_COLORS inline styles (Bloomberg-dense dark theme)
- Sample data fallback ensures page works without backend
</success_criteria>

<output>
After completion, create `.planning/phases/24-frontend-position-book-trade-blotter/24-01-SUMMARY.md`
</output>
