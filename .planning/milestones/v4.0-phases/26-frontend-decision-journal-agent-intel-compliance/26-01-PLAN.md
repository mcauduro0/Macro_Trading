---
phase: 26-frontend-decision-journal-agent-intel-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/static/js/pms/pages/DecisionJournalPage.jsx
autonomous: true
requirements:
  - PMS-FE-DJ-01
  - PMS-FE-DJ-02

must_haves:
  truths:
    - "Decision Journal page displays a vertical timeline of all decisions (OPEN, CLOSE, REJECT, NOTE) with date markers on the left and decision cards on the right"
    - "Each decision card shows collapsed headline (type badge, instrument, date, P&L outcome) and expands to show full context (rationale, macro snapshot, portfolio state, strategy, conviction)"
    - "Decision types have color-coded badges: OPEN = blue, CLOSE = green/red by P&L sign, REJECT = amber, NOTE = gray"
    - "Filter bar at top provides date range presets (Today, This Week, MTD, QTD, YTD, Custom), decision type multi-select, asset class dropdown, and text search for instrument"
    - "Journal uses infinite scroll to load more entries as user scrolls near bottom"
    - "Outcome tracking panel lets user record realized P&L assessment and lessons learned for any entry"
  artifacts:
    - path: "src/api/static/js/pms/pages/DecisionJournalPage.jsx"
      provides: "Complete Decision Journal page with timeline, filters, infinite scroll, outcome tracking"
      min_lines: 400
  key_links:
    - from: "src/api/static/js/pms/pages/DecisionJournalPage.jsx"
      to: "/api/v1/pms/journal/"
      via: "fetch with filter query params and pagination offset"
      pattern: "fetch.*pms/journal"
    - from: "src/api/static/js/pms/pages/DecisionJournalPage.jsx"
      to: "/api/v1/pms/journal/{entry_id}/outcome"
      via: "POST fetch for recording outcome assessment"
      pattern: "fetch.*pms/journal.*outcome"
    - from: "src/api/static/js/pms/pages/DecisionJournalPage.jsx"
      to: "/api/v1/pms/journal/stats/decision-analysis"
      via: "fetch for summary stats displayed at top of page"
      pattern: "fetch.*decision-analysis"
---

<objective>
Build the Decision Journal page -- a vertical timeline view of all trading decisions with expandable detail cards, filter bar, infinite scroll, and outcome tracking.

Purpose: The Decision Journal is the portfolio manager's primary tool for reviewing past decisions, learning from outcomes, and maintaining a complete audit trail of all trade actions. It must support rapid scanning (collapsed cards) and deep review (expanded context).

Output: `DecisionJournalPage.jsx` component exposed on `window.DecisionJournalPage`, fetching from existing PMS Journal API endpoints.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-frontend-decision-journal-agent-intel-compliance/26-CONTEXT.md
@.planning/phases/23-frontend-design-system-morning-pack-page/23-01-SUMMARY.md

Key existing files to reference for patterns:
@src/api/static/js/pms/theme.jsx
@src/api/static/js/pms/components.jsx
@src/api/static/js/pms/pages/PerformanceAttributionPage.jsx (period selector pattern)
@src/api/static/js/pms/pages/TradeBlotterPage.jsx (table + filter pattern)
@src/api/routes/pms_journal.py (API endpoints: GET /, GET /stats/decision-analysis, GET /{entry_id}, POST /{entry_id}/outcome)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DecisionJournalPage with vertical timeline, filter bar, and infinite scroll</name>
  <files>src/api/static/js/pms/pages/DecisionJournalPage.jsx</files>
  <action>
Create `src/api/static/js/pms/pages/DecisionJournalPage.jsx` implementing the full Decision Journal page. Use PMS_COLORS, PMS_TYPOGRAPHY, PMS_SPACING from `window.PMS_THEME` and reusable components from `window` (PMSCard, PMSBadge, PMSSkeleton, PMSLayout).

**Summary Stats Bar (top):**
- Fetch from `/api/v1/pms/journal/stats/decision-analysis` on mount
- Display 4-5 PMSMetricCard-style inline stats: Total Decisions, Approval Rate (%), Avg Holding Days, Open/Closed/Rejected counts
- Compact horizontal row above the filter bar

**Filter Bar (shared component `JournalFilterBar`):**
- Horizontal bar below stats, above timeline
- Controls:
  - Date range dropdown with presets: Today, This Week, MTD, QTD, YTD, Custom (when Custom is selected, show two date inputs)
  - Decision type multi-select buttons (toggleable): OPEN, CLOSE, REJECT, NOTE (each with its color badge)
  - Asset class dropdown: All, FX, Rates, Inflation, Sovereign, Cross-Asset
  - Text search input for instrument name (debounce 300ms)
- Filter state drives the API query params sent to `GET /api/v1/pms/journal/`
- Date range presets compute start_date/end_date relative to current date (Today = today, This Week = last Monday, MTD = 1st of month, QTD = 1st of quarter, YTD = Jan 1)

**Vertical Timeline Layout:**
- Left column (narrow, ~80px): date markers. Group entries by date. Show date label (e.g., "Feb 25") once per group with a vertical connecting line between dates.
- Right column: decision cards stacked vertically within each date group.
- Connecting line: 2px solid line in PMS_COLORS.border.default running down the left column, with small dot markers at each date.

**Decision Cards (collapsed state -- default):**
- Compact single row showing:
  - Color-coded type badge: OPEN = PMS_COLORS.border.accent (blue), CLOSE = pnlColor(realized_pnl), REJECT = PMS_COLORS.risk.warning (amber), NOTE = PMS_COLORS.text.muted (gray)
  - Instrument name (bold, monospace)
  - Direction indicator (LONG/SHORT with direction color)
  - Date + time (secondary text)
  - P&L outcome (if CLOSE type: formatted with pnlColor; otherwise dash)
  - Expand/collapse chevron icon on right
- ~10 entries visible per screen in collapsed state (compact padding)

**Decision Cards (expanded state):**
- Expand below the collapsed header on click (toggle)
- Show full context in organized sections:
  - **Rationale**: manager_notes and system_notes
  - **Macro Snapshot**: market_snapshot dict rendered as key-value pairs (if present)
  - **Portfolio State**: portfolio_snapshot dict rendered as key-value pairs (if present)
  - **Details**: strategy source, conviction, notional, entry price, content_hash (truncated)
- Include an "Record Outcome" button that opens a small inline form (textarea for outcome_notes + text input for realized_pnl_assessment + Submit button). POST to `/api/v1/pms/journal/{entry_id}/outcome`.

**Infinite Scroll:**
- Track `offset` state, initially 0, page size = 20
- Use IntersectionObserver on a sentinel div at the bottom of the list
- When sentinel becomes visible and not currently loading, fetch next page (offset += 20) and append to entries list
- Show loading skeleton at bottom while fetching
- Stop fetching when returned entries < page size (no more data)

**Sample Data Fallback:**
- If API fetch fails (network error or 500), generate deterministic sample journal entries (12-15 entries across OPEN/CLOSE/REJECT/NOTE types) for demo rendering.
- Sample data includes realistic instruments (DI1F26, USDBRL, NTN-B 2030, etc.), dates spanning last 30 days, and mock market/portfolio snapshots.

**Loading State:**
- Show PMSSkeleton cards while initial data loads
- Show inline spinner for infinite scroll loading

Expose component on `window.DecisionJournalPage`.
  </action>
  <verify>
File exists at `src/api/static/js/pms/pages/DecisionJournalPage.jsx` with 400+ lines. Contains: JournalFilterBar component, vertical timeline layout with date markers, collapsible DecisionCard component, infinite scroll via IntersectionObserver, outcome recording form, sample data fallback, and `window.DecisionJournalPage` assignment.
  </verify>
  <done>
Decision Journal page renders a vertical timeline of decision cards with date grouping, color-coded type badges (OPEN=blue, CLOSE=green/red, REJECT=amber, NOTE=gray), expandable detail cards showing full context, filter bar with date range presets and type/instrument filters, infinite scroll pagination, and outcome recording via POST to journal API.
  </done>
</task>

</tasks>

<verification>
1. File `src/api/static/js/pms/pages/DecisionJournalPage.jsx` exists and is >= 400 lines
2. Component uses PMS_COLORS for all styling (inline styles, not Tailwind color classes for PMS-specific colors)
3. Filter bar includes date range presets (Today, This Week, MTD, QTD, YTD, Custom), decision type toggles, asset class dropdown, instrument search
4. Timeline has vertical connecting line with date markers on left, cards on right
5. Cards expand/collapse on click showing full context sections
6. Infinite scroll loads more entries when scrolling near bottom
7. Outcome recording form POSTs to `/api/v1/pms/journal/{entry_id}/outcome`
8. Sample data fallback renders when API unavailable
</verification>

<success_criteria>
- DecisionJournalPage.jsx renders correctly with Bloomberg-dense dark styling matching existing PMS pages
- Vertical timeline with date grouping provides clear chronological view
- Filter bar controls correctly filter displayed entries
- Infinite scroll loads more entries seamlessly
- Expanded cards show all decision context (rationale, macro snapshot, portfolio state, details)
- Outcome recording creates NOTE entries via API
</success_criteria>

<output>
After completion, create `.planning/phases/26-frontend-decision-journal-agent-intel-compliance/26-01-SUMMARY.md`
</output>
