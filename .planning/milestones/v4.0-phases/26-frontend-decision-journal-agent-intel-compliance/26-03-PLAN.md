---
phase: 26-frontend-decision-journal-agent-intel-compliance
plan: 03
type: execute
wave: 2
depends_on:
  - 26-01
  - 26-02
files_modified:
  - src/api/static/js/pms/pages/ComplianceAuditPage.jsx
  - src/api/static/js/Sidebar.jsx
  - src/api/static/js/App.jsx
  - src/api/static/dashboard.html
autonomous: true
requirements:
  - PMS-FE-CO-01
  - PMS-FE-CO-02

must_haves:
  truths:
    - "Compliance & Audit page displays an audit trail log viewer with newest entries first showing timestamp, action, user, hash snippet, and verification status"
    - "Hash integrity verification runs automatically on page load -- green checkmark or red warning per visible entry"
    - "Export functionality supports both CSV and JSON formats for compliance data"
    - "Compliance page has its own filter bar with date range presets and decision type filters (shared filter component pattern from Decision Journal)"
    - "Sidebar navigation includes 3 new PMS items: Decision Journal, Agent Intel, Compliance -- replacing Strategies and Settings placeholders"
    - "App.jsx routes /pms/journal, /pms/agents, and /pms/compliance to actual page components"
    - "dashboard.html loads all 3 new page scripts in correct dependency order"
  artifacts:
    - path: "src/api/static/js/pms/pages/ComplianceAuditPage.jsx"
      provides: "Compliance & Audit page with audit trail, hash verification, CSV/JSON export"
      min_lines: 300
    - path: "src/api/static/js/Sidebar.jsx"
      provides: "Updated PMS sidebar navigation with Journal, Agent Intel, Compliance items"
    - path: "src/api/static/js/App.jsx"
      provides: "Updated PMS routes for journal, agents, and compliance pages"
    - path: "src/api/static/dashboard.html"
      provides: "Script loading for DecisionJournalPage, AgentIntelPage, ComplianceAuditPage"
  key_links:
    - from: "src/api/static/js/pms/pages/ComplianceAuditPage.jsx"
      to: "/api/v1/pms/journal/"
      via: "fetch for audit trail entries (same data source, compliance view)"
      pattern: "fetch.*pms/journal"
    - from: "src/api/static/js/App.jsx"
      to: "window.DecisionJournalPage"
      via: "window global resolution for route component"
      pattern: "window\\.DecisionJournalPage"
    - from: "src/api/static/js/App.jsx"
      to: "window.AgentIntelPage"
      via: "window global resolution for route component"
      pattern: "window\\.AgentIntelPage"
    - from: "src/api/static/js/App.jsx"
      to: "window.ComplianceAuditPage"
      via: "window global resolution for route component"
      pattern: "window\\.ComplianceAuditPage"
---

<objective>
Build the Compliance & Audit page and wire all 3 new Phase 26 pages (Decision Journal, Agent Intelligence Hub, Compliance) into the PMS sidebar navigation, App.jsx routing, and dashboard.html script loading.

Purpose: The Compliance page serves compliance officers with an audit trail of all decisions, automatic hash integrity verification, and data export. The routing wiring integrates all Phase 26 pages into the running application, replacing placeholder routes.

Output: `ComplianceAuditPage.jsx`, updated `Sidebar.jsx` (3 new nav items), updated `App.jsx` (3 new routes), updated `dashboard.html` (3 new script tags).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-frontend-decision-journal-agent-intel-compliance/26-CONTEXT.md
@.planning/phases/23-frontend-design-system-morning-pack-page/23-01-SUMMARY.md
@.planning/phases/25-frontend-risk-monitor-performance-attribution/25-02-SUMMARY.md

Key existing files to modify:
@src/api/static/js/Sidebar.jsx (PMS_NAV_ITEMS array to update)
@src/api/static/js/App.jsx (PMS routes section to update)
@src/api/static/dashboard.html (script loading order)
@src/api/static/js/pms/theme.jsx
@src/api/static/js/pms/components.jsx
@src/api/routes/pms_journal.py (API for audit trail data)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ComplianceAuditPage with audit trail, hash verification, and export</name>
  <files>src/api/static/js/pms/pages/ComplianceAuditPage.jsx</files>
  <action>
Create `src/api/static/js/pms/pages/ComplianceAuditPage.jsx` implementing the Compliance & Audit page. Use PMS_COLORS, PMS_TYPOGRAPHY, PMS_SPACING from `window.PMS_THEME` and reusable components from `window` (PMSCard, PMSTable, PMSBadge, PMSSkeleton).

**Page Header:**
- Title "Compliance & Audit" in PMS_TYPOGRAPHY.sizes['2xl']
- Subtitle "Audit trail, integrity verification, and data export" in secondary text
- Two export buttons in header row (right-aligned): "Export CSV" and "Export JSON" with download icons

**Filter Bar (reuse pattern from Decision Journal):**
- Horizontal filter bar above the audit log
- Controls: date range presets (Today, This Week, MTD, QTD, YTD, Custom), decision type multi-select (OPEN/CLOSE/REJECT/NOTE), text search for instrument
- Same date range preset computation logic as Decision Journal

**Audit Trail Log Viewer:**
- Table-style log viewer, newest entries first
- Each row displays:
  - **Timestamp**: created_at formatted as "YYYY-MM-DD HH:mm:ss" in monospace
  - **Action**: entry_type badge (same color coding as Decision Journal: OPEN=blue, CLOSE=green/red, REJECT=amber, NOTE=gray)
  - **Instrument**: instrument name
  - **User**: "Portfolio Manager" (single-user system per constraints)
  - **Hash**: First 12 characters of content_hash with copy-to-clipboard icon button
  - **Verification Status**: Auto-computed on page load. For each visible entry:
    - Recompute hash from entry data (entry_type + instrument + direction + notional_brl + entry_price + manager_notes + system_notes) using a client-side SHA-256 implementation (use Web Crypto API: `crypto.subtle.digest('SHA-256', ...)`)
    - Compare recomputed hash with stored content_hash
    - Show green checkmark icon + "Verified" text if match, red warning icon + "Mismatch" text if not
    - Note: since the server-side hash uses Python hashlib, perfect match depends on identical content assembly. For entries fetched from sample data, the hashes will match if computed identically. For the sample data fallback, pre-compute consistent hashes.
  - **Direction**: LONG/SHORT with direction color
  - **Notional**: formatted number

**Hash Verification Logic:**
- Run verification automatically on page load for all loaded entries
- Use `async function verifyHash(entry)` that assembles the content string from entry fields, hashes it with SHA-256 via Web Crypto API, and compares with stored content_hash
- Store verification results in a React state map: `{[entry_id]: 'verified' | 'mismatch' | 'pending'}`
- Show all entries as "pending" (neutral icon) initially, then update to verified/mismatch as async verification completes

**Export Functionality:**
- **Export CSV**: Generate CSV string from currently filtered entries. Headers: timestamp, entry_type, instrument, direction, notional_brl, entry_price, manager_notes, content_hash, verification_status. Trigger download via Blob + URL.createObjectURL + click on hidden anchor.
- **Export JSON**: Serialize currently filtered entries to pretty-printed JSON. Same download trigger mechanism.
- Both exports include verification status in output

**Pagination:**
- Client-side pagination with "Load More" button (same page size of 50 matching API default)
- Show total entry count from stats endpoint

**Sample Data Fallback:**
- If API fails, generate 20 sample audit trail entries with realistic data and pre-computed hashes
- Sample entries should have variety of types and instruments

**Loading State:**
- PMSSkeleton table rows while data loads
- Verification status shows "Verifying..." spinner while hash computation runs

Expose component on `window.ComplianceAuditPage`.
  </action>
  <verify>
File exists at `src/api/static/js/pms/pages/ComplianceAuditPage.jsx` with 300+ lines. Contains: filter bar, audit trail table, SHA-256 hash verification via Web Crypto API, CSV export function, JSON export function, sample data fallback, and `window.ComplianceAuditPage` assignment.
  </verify>
  <done>
Compliance & Audit page renders an audit trail log viewer with timestamp, action badge, instrument, user, hash snippet with copy button, and automatic hash verification status (green checkmark / red warning). Export buttons generate CSV and JSON downloads of filtered entries. Filter bar supports date range and type filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Decision Journal, Agent Intel, and Compliance into Sidebar, App routing, and dashboard.html</name>
  <files>src/api/static/js/Sidebar.jsx, src/api/static/js/App.jsx, src/api/static/dashboard.html</files>
  <action>
Update three files to integrate all Phase 26 pages into the running application.

**Sidebar.jsx -- Update PMS_NAV_ITEMS:**

Replace the current PMS_NAV_ITEMS array (7 items) with an updated 8-item array. Keep existing items and add 3 new ones, removing Strategies and Settings placeholders if needed, or rearranging to include the new pages. Final PMS navigation order:

```
1. Morning Pack    -> /pms/morning-pack   (existing, IconSunrise)
2. Portfolio       -> /pms/portfolio      (existing, IconBriefcase)
3. Risk            -> /pms/risk           (existing, IconShield)
4. Trade Blotter   -> /pms/blotter        (existing, IconList)
5. Attribution     -> /pms/attribution    (existing, IconPieChart)
6. Decision Journal -> /pms/journal       (NEW -- needs IconBook or similar icon)
7. Agent Intel     -> /pms/agents         (NEW -- IconCpu, reuse existing)
8. Compliance      -> /pms/compliance     (NEW -- needs IconClipboard or IconFileCheck icon)
```

Add 2 new SVG icon components for the new navigation items:
- `IconBook`: Simple book/journal icon (SVG, same pattern as existing icons)
- `IconClipboardCheck`: Clipboard with checkmark icon for Compliance

**App.jsx -- Add 3 new PMS routes:**

In the AppContent function, add window global resolutions for the 3 new page components (same pattern as existing pages):
```javascript
const DecisionJournalPage = window.DecisionJournalPage;
const AgentIntelPage = window.AgentIntelPage;
const ComplianceAuditPage = window.ComplianceAuditPage;
```

In the Routes section, replace the PMS Strategies and Settings placeholder routes and add the 3 new routes:
```jsx
<Route path="/pms/journal" element={<DecisionJournalPage />} />
<Route path="/pms/agents" element={<AgentIntelPage />} />
<Route path="/pms/compliance" element={<ComplianceAuditPage />} />
```

Keep the existing 5 PMS routes unchanged (morning-pack, portfolio, risk, blotter, attribution). Remove or keep the /pms/strategies and /pms/settings placeholders at your discretion -- if keeping, they remain as PMSPlaceholder.

**dashboard.html -- Add 3 new script tags:**

Add script loading for the 3 new page components in the correct dependency order. They must load AFTER theme.jsx and components.jsx but BEFORE App.jsx. Add them alongside the existing PMS page scripts:

```html
<script type="text/babel" src="/static/js/pms/pages/DecisionJournalPage.jsx"></script>
<script type="text/babel" src="/static/js/pms/pages/AgentIntelPage.jsx"></script>
<script type="text/babel" src="/static/js/pms/pages/ComplianceAuditPage.jsx"></script>
```

These go after the PerformanceAttributionPage.jsx script tag and before Sidebar.jsx.
  </action>
  <verify>
1. In Sidebar.jsx: PMS_NAV_ITEMS includes entries for /pms/journal (Decision Journal), /pms/agents (Agent Intel), and /pms/compliance (Compliance)
2. In App.jsx: window.DecisionJournalPage, window.AgentIntelPage, window.ComplianceAuditPage are resolved from window globals, and Routes section has 3 new Route elements
3. In dashboard.html: 3 new script tags load DecisionJournalPage.jsx, AgentIntelPage.jsx, ComplianceAuditPage.jsx before App.jsx
  </verify>
  <done>
Sidebar shows 8 PMS navigation items including Decision Journal, Agent Intel, and Compliance with appropriate icons. App.jsx routes /pms/journal, /pms/agents, and /pms/compliance to actual page components. Dashboard.html loads all 3 new page scripts in correct dependency order.
  </done>
</task>

</tasks>

<verification>
1. File `src/api/static/js/pms/pages/ComplianceAuditPage.jsx` exists and is >= 300 lines
2. Compliance page has audit trail with hash verification, CSV export, JSON export
3. Sidebar.jsx PMS_NAV_ITEMS has 8 entries including journal, agents, compliance
4. App.jsx has 8 PMS routes (5 existing + 3 new)
5. dashboard.html has 3 new script tags for Phase 26 pages
6. All 3 new pages accessible via sidebar navigation
7. Hash verification shows green/red status per entry
8. Export buttons generate downloadable CSV and JSON files
</verification>

<success_criteria>
- ComplianceAuditPage renders audit trail with automatic hash verification
- Export CSV downloads file with all visible filtered entries
- Export JSON downloads file with all visible filtered entries
- Sidebar navigation shows all 8 PMS pages with correct icons and routes
- App routing delivers correct page component for each URL
- All 3 new pages load and render via dashboard.html script tags
- No regressions to existing 5 PMS pages (Morning Pack, Portfolio, Risk, Blotter, Attribution)
</success_criteria>

<output>
After completion, create `.planning/phases/26-frontend-decision-journal-agent-intel-compliance/26-03-SUMMARY.md`
</output>
