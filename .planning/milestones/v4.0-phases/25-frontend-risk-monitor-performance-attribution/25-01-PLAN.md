---
phase: 25-frontend-risk-monitor-performance-attribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/static/js/pms/pages/RiskMonitorPage.jsx
autonomous: true
requirements:
  - PMS-FE-RM-01
  - PMS-FE-RM-02
  - PMS-FE-RM-03

must_haves:
  truths:
    - "Risk Monitor page displays 4 VaR gauges (Parametric 95%, Parametric 99%, MC 95%, MC 99%) as semi-circular SVG arcs with needles showing current vs limit"
    - "Stress test horizontal bar chart shows each scenario sorted by severity, color-coded green/yellow/red by magnitude"
    - "Risk limit utilization bars turn amber at 80% (WARNING) and red at 100% (BREACH) with brief pulse animation on breach"
    - "Concentration pie chart shows allocation by asset class using Recharts PieChart"
    - "Limit breach alerts appear as a summary line at top ('2 warnings, 1 breach') and clicking a breached bar expands detail showing limit name, current value, threshold, utilization, when last OK, trend"
    - "Historical VaR time-series chart below the 4-quadrant grid shows parametric VaR over time with 95%/99% lines and limit thresholds, with trailing window selector (30d, 60d, 90d, 1Y)"
  artifacts:
    - path: "src/api/static/js/pms/pages/RiskMonitorPage.jsx"
      provides: "Complete Risk Monitor page component"
      min_lines: 500
  key_links:
    - from: "src/api/static/js/pms/pages/RiskMonitorPage.jsx"
      to: "/api/v1/pms/risk/live"
      via: "window.useFetch"
      pattern: "useFetch.*pms/risk/live"
    - from: "src/api/static/js/pms/pages/RiskMonitorPage.jsx"
      to: "/api/v1/pms/risk/trend"
      via: "window.useFetch"
      pattern: "useFetch.*pms/risk/trend"
    - from: "src/api/static/js/pms/pages/RiskMonitorPage.jsx"
      to: "/api/v1/pms/risk/limits"
      via: "window.useFetch"
      pattern: "useFetch.*pms/risk/limits"
---

<objective>
Build the Risk Monitor page for the PMS frontend -- a Bloomberg PORT-dense 4-quadrant dashboard providing real-time risk oversight with VaR gauges, stress test visualization, limit utilization bars, and concentration charts.

Purpose: The portfolio manager needs a single-glance risk dashboard for daily risk oversight, replacing the placeholder currently at /pms/risk.
Output: RiskMonitorPage.jsx component exposed on window.RiskMonitorPage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key pattern references (read these files for implementation patterns):
@src/api/static/js/pms/theme.jsx           # PMS_COLORS, PMS_TYPOGRAPHY, PMS_SPACING, helper functions
@src/api/static/js/pms/components.jsx       # PMSCard, PMSTable, PMSBadge, PMSGauge, PMSLayout, PMSSkeleton, PMSAlertBanner
@src/api/static/js/pms/pages/PositionBookPage.jsx  # Pattern: useFetch, sample fallback, seededRng, formatting, Recharts ComposedChart
@src/api/static/js/pages/RiskPage.jsx       # Pattern: GaugeChart SVG arc, stress test BarChart, limits table, concentration PieChart
@src/api/routes/pms_risk.py                 # API: GET /pms/risk/live, GET /pms/risk/trend, GET /pms/risk/limits
@src/api/schemas/pms_schemas.py             # LiveRiskResponse, RiskTrendPointResponse, VaRSnapshotResponse, RiskAlertResponse
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RiskMonitorPage.jsx with 4-quadrant risk dashboard</name>
  <files>src/api/static/js/pms/pages/RiskMonitorPage.jsx</files>
  <action>
Create a new file `src/api/static/js/pms/pages/RiskMonitorPage.jsx` implementing the complete Risk Monitor page.

**Architecture: Follow exact PMS page pattern from PositionBookPage.jsx:**
- Access PMS_THEME via `window.PMS_THEME` destructuring (PMS_COLORS as _C, PMS_TYPOGRAPHY as _T, PMS_SPACING as _S, plus pnlColor, riskColor, formatPnL, formatNumber, formatPercent)
- Use `window.useFetch()` for all API calls with 30-second polling interval
- Include comprehensive SAMPLE data constants for fallback when API unavailable
- Use `seededRng()` function for deterministic sample data generation
- Expose component on `window.RiskMonitorPage = RiskMonitorPage`
- All styles inline using PMS design tokens (no Tailwind -- PMS pages use inline styles exclusively)

**Component Structure:**

1. **RiskMonitorPage (main)** — orchestrates all sections:
   - Fetches from 3 endpoints: `/api/v1/pms/risk/live` (30s poll), `/api/v1/pms/risk/trend?days=90` (60s poll), `/api/v1/pms/risk/limits` (60s poll)
   - Falls back to SAMPLE data when API unavailable (same pattern as PositionBookPage)
   - Page header: "Risk Monitor" title + date + update timestamp
   - Loading state: RiskMonitorSkeleton component using PMSSkeleton

2. **AlertSummaryBar** — breach/warning summary line at top of page:
   - Renders "X warnings, Y breaches" or "All clear" as a compact bar
   - Amber background for warnings-only, red for any breaches
   - Sits between page header and the 4-quadrant grid

3. **VaRGaugeRow** — 4 semi-circular SVG gauges in a horizontal row:
   - Gauges: Parametric 95%, Parametric 99%, MC 95%, MC 99%
   - Reuse the SVG arc math pattern from RiskPage.jsx GaugeChart but adapt to PMS inline styling:
     - Semi-circular arc (180 degrees) with background track in _C.bg.tertiary
     - Value arc colored by severity: green (<50%), amber (50-80%), red (>=80% of limit)
     - Needle line from center to arc position for current value
     - Center text showing percentage value
     - Label below: "Parametric 95%" etc.
     - Below each gauge: "Limit: X%" in muted text
   - Each gauge sized at ~130px width, arranged in a flex row with gap
   - Data from `risk.var` object: parametric_95, parametric_99, monte_carlo_95, monte_carlo_99
   - Limits from `risk.var`: limit_95_pct, limit_99_pct

4. **Four-Quadrant Grid** — CSS grid 2x2 layout:
   - **Top-Left: VaR Gauges** (VaRGaugeRow component)
   - **Top-Right: Stress Test Bars** — Recharts horizontal BarChart:
     - Each scenario as a horizontal bar showing portfolio impact in BRL
     - Sorted by severity (most negative first)
     - Color: green for positive, amber for -5% to 0%, red for < -5%
     - Data from `risk.stress_tests` array
     - Use `{ BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell }` from Recharts (same pattern as RiskPage.jsx)
     - Tooltip shows scenario name + BRL impact formatted with formatPnLShort
   - **Bottom-Left: Limit Utilization Bars** — custom component:
     - Each risk limit as a horizontal bar with label, value, and utilization %
     - Bar fill colored: green (<80%), amber (80-100%), red (>=100%)
     - Bars that hit BREACH severity pulse briefly (CSS animation: `@keyframes pulse-breach { 0%,100% { opacity: 1 } 50% { opacity: 0.7 } }` -- inject via style tag or inline)
     - Click handler on each bar: toggles expanded detail panel below the bar
     - Expanded detail shows: limit name, current value, threshold, % utilization, when last OK (from data or "--"), trend (improving/worsening based on value vs previous)
     - Data from `limits.config` and `limits.limits_summary`
   - **Bottom-Right: Concentration Pie Chart** — Recharts PieChart:
     - Donut chart (innerRadius) showing allocation by asset class
     - Data from `risk.concentration` object
     - Colors from PIE_COLORS array (same as RiskPage.jsx)
     - Labels showing asset class name + percentage
     - Legend below chart

5. **HistoricalVaRChart** — full-width section below the 4-quadrant grid:
   - Recharts ComposedChart (same pattern as PositionBookPage EquityCurveSection)
   - X-axis: dates, Y-axis: VaR percentage
   - Two Line series: VaR 95% (solid blue) and VaR 99% (solid purple/red)
   - Two ReferenceLine elements for limit thresholds (dashed)
   - Trailing window selector buttons: 30d | 60d | 90d | 1Y (default: 90d per Claude's discretion)
   - Data from `/api/v1/pms/risk/trend?days=N`
   - Chart height ~200px

6. **RiskMonitorSkeleton** — loading skeleton:
   - 4 PMSSkeleton blocks in 2x2 grid
   - 1 full-width PMSSkeleton below for historical chart

**Sample Data Constants:**
- SAMPLE_RISK_LIVE: complete mock LiveRiskResponse with var (parametric_95: 1.42, parametric_99: 2.15, mc_95: 1.38, mc_99: 2.08), leverage, drawdown, concentration (by asset class), stress_tests (6 scenarios matching Phase 17 defaults: Taper Tantrum, BR Crisis 2015, COVID 2020, Rate Shock 2022, BR Fiscal Crisis, Global Risk-Off), limits_summary (9 limits with utilization values, 2 in WARNING, 1 in BREACH), alerts (2 warnings, 1 breach)
- SAMPLE_RISK_TREND: 90 data points generated via seededRng, each with date, var_95, leverage_gross, drawdown_pct, alert_count
- SAMPLE_LIMITS: config with 9 limit names and thresholds, limits_summary with current values and utilization percentages

**Key Implementation Details:**
- Grid layout: `display: 'grid', gridTemplateColumns: '1fr 1fr', gap: _S.md` for 4-quadrant
- Each quadrant wrapped in PMSCard with title
- Stress test bar chart: `layout="vertical"` on BarChart for horizontal bars
- Limit bars: custom div-based horizontal bars (not PMSGauge -- those are too simple; build custom with click-to-expand)
- Pie chart colors: `const PIE_COLORS = ['#58a6ff', '#3fb950', '#d29922', '#f85149', '#a371f7', '#f0883e']`
- All formatting uses PMS_THEME helpers: formatPnL, formatPercent, formatNumber
- Breach pulse animation: add a `<style>` element via useEffect or inline in component for `@keyframes pulse-breach`
  </action>
  <verify>
1. File exists at `src/api/static/js/pms/pages/RiskMonitorPage.jsx`
2. `grep -c "window.RiskMonitorPage" src/api/static/js/pms/pages/RiskMonitorPage.jsx` returns 1
3. `grep -c "useFetch" src/api/static/js/pms/pages/RiskMonitorPage.jsx` shows 3 (one per endpoint)
4. `grep -c "pms/risk/live" src/api/static/js/pms/pages/RiskMonitorPage.jsx` shows 1
5. `grep -c "pms/risk/trend" src/api/static/js/pms/pages/RiskMonitorPage.jsx` shows 1
6. `grep -c "pms/risk/limits" src/api/static/js/pms/pages/RiskMonitorPage.jsx` shows 1
7. File contains GaugeChart/VaRGauge SVG arc implementation
8. File contains SAMPLE_RISK_LIVE, SAMPLE_RISK_TREND constants
9. File uses PMS_THEME design tokens (no Tailwind classes)
10. File contains pulse-breach animation for limit breach bars
  </verify>
  <done>
RiskMonitorPage.jsx exists with:
- 4 VaR gauges (Parametric 95/99, MC 95/99) as SVG semi-circular arcs
- Stress test horizontal bar chart (6 scenarios, sorted by severity, color-coded)
- Risk limit utilization bars with 2-tier alerting (WARNING amber at 80%, BREACH red at 100%), pulse animation on breach, click-to-expand detail
- Concentration pie chart by asset class
- Alert summary bar at top showing breach/warning counts
- Historical VaR chart below 4-quadrant grid with trailing window selector (30d/60d/90d/1Y)
- Fallback to comprehensive sample data when API unavailable
- All 3 API endpoints wired via window.useFetch
  </done>
</task>

</tasks>

<verification>
1. RiskMonitorPage.jsx renders without errors when loaded in browser (verify by navigating to #/pms/risk after wiring in Plan 02)
2. 4-quadrant layout visible with all 4 sections populated from sample data
3. VaR gauges display correct severity coloring
4. Limit bars show WARNING/BREACH states with expandable detail on click
5. Historical VaR chart renders with trailing window buttons
</verification>

<success_criteria>
- RiskMonitorPage.jsx component exists and is exposed on window.RiskMonitorPage
- Component fetches from 3 PMS risk endpoints and falls back to sample data
- 4-quadrant grid layout displays VaR gauges, stress tests, limit bars, and concentration pie
- Limit utilization bars implement 2-tier alerting with pulse animation and expandable breach detail
- Historical VaR chart shows time-series with trailing window selector
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-risk-monitor-performance-attribution/25-01-SUMMARY.md`
</output>
