---
phase: 25-frontend-risk-monitor-performance-attribution
plan: 02
type: execute
wave: 2
depends_on:
  - 25-01
files_modified:
  - src/api/static/js/pms/pages/PerformanceAttributionPage.jsx
  - src/api/static/js/App.jsx
  - src/api/static/dashboard.html
autonomous: true
requirements:
  - PMS-FE-PA-01
  - PMS-FE-PA-02

must_haves:
  truths:
    - "Performance Attribution page shows P&L waterfall chart with each strategy as a floating bar showing contribution, positive bars up, negative bars down, final total bar"
    - "Asset class attribution table shows asset class, P&L, % contribution, position count with inline horizontal bar for relative magnitude"
    - "Time-series P&L shows dual chart: daily P&L bars (color-coded) with cumulative P&L line on second Y-axis"
    - "Period selector (Daily, MTD, QTD, YTD, Custom) at top of page updates all charts simultaneously, default MTD"
    - "Dimension switcher tabs (By Strategy, By Asset Class, By Instrument) show waterfall + table for one dimension at a time"
    - "Risk Monitor page accessible at #/pms/risk and renders RiskMonitorPage component"
    - "Performance Attribution page accessible at #/pms/attribution and renders PerformanceAttributionPage component"
  artifacts:
    - path: "src/api/static/js/pms/pages/PerformanceAttributionPage.jsx"
      provides: "Complete Performance Attribution page component"
      min_lines: 400
    - path: "src/api/static/js/App.jsx"
      provides: "Updated routes for Risk Monitor and Attribution pages"
      contains: "RiskMonitorPage"
    - path: "src/api/static/dashboard.html"
      provides: "Script tags for new PMS page files"
      contains: "RiskMonitorPage.jsx"
  key_links:
    - from: "src/api/static/js/pms/pages/PerformanceAttributionPage.jsx"
      to: "/api/v1/pms/attribution"
      via: "window.useFetch with period parameter"
      pattern: "useFetch.*pms/attribution"
    - from: "src/api/static/js/pms/pages/PerformanceAttributionPage.jsx"
      to: "/api/v1/pms/attribution/equity-curve"
      via: "window.useFetch"
      pattern: "useFetch.*pms/attribution/equity-curve"
    - from: "src/api/static/js/App.jsx"
      to: "window.RiskMonitorPage"
      via: "Route element"
      pattern: "RiskMonitorPage"
    - from: "src/api/static/js/App.jsx"
      to: "window.PerformanceAttributionPage"
      via: "Route element"
      pattern: "PerformanceAttributionPage"
---

<objective>
Build the Performance Attribution page for the PMS frontend and wire both new pages (Risk Monitor from Plan 01 + Attribution) into the application routing and script loading.

Purpose: The portfolio manager needs multi-dimensional P&L decomposition to understand what is driving returns -- by strategy, asset class, instrument, and over time.
Output: PerformanceAttributionPage.jsx + updated App.jsx routes + updated dashboard.html script tags.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-frontend-risk-monitor-performance-attribution/25-01-SUMMARY.md

# Key pattern references:
@src/api/static/js/pms/theme.jsx
@src/api/static/js/pms/components.jsx
@src/api/static/js/pms/pages/PositionBookPage.jsx  # Pattern: ComposedChart, dual Y-axis, time range buttons
@src/api/static/js/App.jsx                          # Route definitions and window global resolution
@src/api/static/dashboard.html                      # Script load order for PMS pages
@src/api/routes/pms_attribution.py                  # API: GET /pms/attribution, GET /pms/attribution/equity-curve
@src/api/schemas/pms_schemas.py                     # AttributionResponse, EquityCurvePointResponse
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PerformanceAttributionPage.jsx with P&L decomposition</name>
  <files>src/api/static/js/pms/pages/PerformanceAttributionPage.jsx</files>
  <action>
Create `src/api/static/js/pms/pages/PerformanceAttributionPage.jsx` implementing the complete Performance Attribution page.

**Architecture: Follow PMS page pattern from PositionBookPage.jsx:**
- Access PMS_THEME via `window.PMS_THEME` destructuring
- Use `window.useFetch()` for API calls
- Comprehensive SAMPLE data constants for fallback
- Expose on `window.PerformanceAttributionPage`
- All styles inline using PMS design tokens (no Tailwind)

**Component Structure:**

1. **PerformanceAttributionPage (main)** — orchestrates all sections:
   - State: `period` (default "MTD"), `customStart`, `customEnd`, `dimension` (default "strategy")
   - Fetches attribution: `/api/v1/pms/attribution?period=${period}&start_date=${customStart}&end_date=${customEnd}` with 60s poll
   - Fetches equity curve: `/api/v1/pms/attribution/equity-curve` with 60s poll
   - Falls back to SAMPLE data when API unavailable
   - Page header: "Performance Attribution" title + period label + update timestamp
   - Loading state: AttributionSkeleton using PMSSkeleton

2. **PeriodSelector** — button group at top of page:
   - Buttons: Daily | MTD | QTD | YTD | Custom
   - Per user decision: single shared selector updates ALL charts simultaneously
   - Default on page load: MTD
   - "Custom" button opens two date inputs (start_date, end_date) inline to the right
   - Button styling: same range button pattern as PositionBookPage EquityCurveSection (active = _C.border.accent bg, inactive = transparent)
   - When period changes, re-fetch attribution data by updating the URL parameter

3. **DimensionSwitcher** — tabbed interface:
   - Tabs: "By Strategy" | "By Asset Class" | "By Instrument"
   - Per user decision: tabbed approach (one dimension at a time)
   - Tab styling: same as TradeBlotterPage tab pattern (underline active tab with _C.border.accent)
   - Each tab shows a WaterfallChart + AttributionTable for that dimension

4. **WaterfallChart** — classic floating-bar waterfall chart:
   - Recharts BarChart with custom rendering for waterfall effect:
     - Use a stacked bar approach: invisible base bar + visible contribution bar
     - For each strategy/asset/instrument: compute cumulative baseline, then show floating bar from baseline to baseline+contribution
     - Positive contributions: bars go up from cumulative baseline (green)
     - Negative contributions: bars go down from cumulative baseline (red)
     - Final bar: total P&L (blue accent color), starts from 0
   - Implementation approach: Transform data into [{name, invisible, value, total}] where `invisible` is the running sum baseline for non-total bars
   - Use BarChart with two stacked Bars: one with `fill="transparent"` for invisible base, one for the visible value
   - X-axis: strategy IDs / asset classes / instrument names (rotated labels if needed)
   - Y-axis: BRL value, formatted with formatPnLShort
   - Tooltip: shows name + P&L contribution + % of total
   - Height: 280px

5. **AttributionTable** — data table for the active dimension:
   - For "By Strategy": columns = Strategy ID, P&L (BRL), Return Contribution (%), Trades, Win Rate
   - For "By Asset Class": columns = Asset Class, P&L (BRL), Return Contribution (%), Avg Notional, Position Count + inline horizontal bar showing relative magnitude
   - For "By Instrument": columns = Instrument, P&L (BRL), Return Contribution (%, Trades
   - Use PMSTable component for consistent styling
   - Inline horizontal bar: a small div inside the cell showing relative P&L magnitude (width proportional to max absolute P&L in the set)
   - P&L values colored via pnlColor helper
   - Sorted by absolute P&L descending

6. **TimeSeriesDecomposition** — dual chart below dimension section:
   - Full-width Recharts ComposedChart (same pattern as PositionBookPage equity curve)
   - Left Y-axis: daily P&L (BRL) for bars
   - Right Y-axis: cumulative P&L (BRL) for line
   - Bar series: daily P&L bars, each colored green (positive) or red (negative) via Cell
   - Line series: cumulative P&L as a solid blue line
   - X-axis: dates
   - Data from `/api/v1/pms/attribution/equity-curve` response
   - Height: 220px
   - Chart header: "P&L Time Series" with optional date range subtitle

7. **AttributionSkeleton** — loading skeleton

**Sample Data Constants:**
- SAMPLE_ATTRIBUTION: complete mock AttributionResponse with:
  - period: { label: "MTD", start: "2026-02-01", end: "2026-02-25" }
  - total_pnl_brl: 1820000, total_return_pct: 0.0121
  - by_strategy: 8 entries with strategy_id, pnl_brl (mix of positive/negative), return_contribution_pct, trades_count, win_rate_pct
  - by_asset_class: 6 entries (FX, RATES, INFLATION, CUPOM_CAMBIAL, SOVEREIGN, CROSS_ASSET) with pnl_brl, return_contribution_pct, avg_notional_brl
  - by_instrument: 12 entries matching PositionBookPage sample positions
  - by_time_period: 18 daily entries with period_start, pnl_brl
- SAMPLE_EQUITY_CURVE: 60 daily points (MTD scope) generated via seededRng with date, equity_brl, return_pct_daily, return_pct_cumulative, drawdown_pct

**Key Implementation Details:**
- Waterfall chart: The key trick is computing the invisible base for each bar. For each item sorted by contribution order: `base[i] = sum(positive_values_before[i])` adjusted for negative bars going below baseline. Use running sum pattern.
- Period selector state drives the fetch URL -- use useMemo or useCallback to build the URL string
- Custom date range: show two `<input type="date">` elements when "Custom" is selected, with onChange triggering a re-fetch
- Dimension tabs: simple state toggle, no re-fetch needed (all dimensions come in the same AttributionResponse)
- For inline magnitude bars in the table: compute `maxAbsPnl = Math.max(...data.map(d => Math.abs(d.pnl_brl)))`, then each bar width is `(Math.abs(d.pnl_brl) / maxAbsPnl) * 100 + '%'`
  </action>
  <verify>
1. File exists at `src/api/static/js/pms/pages/PerformanceAttributionPage.jsx`
2. `grep -c "window.PerformanceAttributionPage" src/api/static/js/pms/pages/PerformanceAttributionPage.jsx` returns 1
3. `grep -c "useFetch" src/api/static/js/pms/pages/PerformanceAttributionPage.jsx` shows 2 (attribution + equity-curve)
4. `grep -c "pms/attribution" src/api/static/js/pms/pages/PerformanceAttributionPage.jsx` shows at least 2
5. File contains SAMPLE_ATTRIBUTION and SAMPLE_EQUITY_CURVE constants
6. File contains PeriodSelector, WaterfallChart, AttributionTable, TimeSeriesDecomposition components
7. File uses PMS_THEME design tokens (no Tailwind classes)
  </verify>
  <done>
PerformanceAttributionPage.jsx exists with:
- Period selector (Daily, MTD, QTD, YTD, Custom) at top, default MTD, custom opens date inputs
- Dimension switcher tabs (By Strategy, By Asset Class, By Instrument)
- P&L waterfall chart with floating bars showing strategy/asset/instrument contributions
- Attribution table with inline magnitude bars and P&L coloring
- Time-series decomposition: daily P&L bars + cumulative P&L line (ComposedChart dual Y-axis)
- Fallback to comprehensive sample data when API unavailable
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Risk Monitor and Attribution pages into App routing and script loading</name>
  <files>src/api/static/js/App.jsx, src/api/static/dashboard.html</files>
  <action>
**Update App.jsx:**
1. Add window global resolution for both new pages (after the existing TradeBlotterPage line inside AppContent):
   ```
   const RiskMonitorPage = window.RiskMonitorPage;
   const PerformanceAttributionPage = window.PerformanceAttributionPage;
   ```
2. Replace the two placeholder routes:
   - Change `<Route path="/pms/risk" element={<PMSPlaceholder title="Risk Monitor" />} />` to `<Route path="/pms/risk" element={<RiskMonitorPage />} />`
   - Change `<Route path="/pms/attribution" element={<PMSPlaceholder title="Performance Attribution" />} />` to `<Route path="/pms/attribution" element={<PerformanceAttributionPage />} />`

**Update dashboard.html:**
Add two new script tags after the existing TradeBlotterPage.jsx line (line 93), maintaining the same pattern:
```html
  <script type="text/babel" src="/static/js/pms/pages/RiskMonitorPage.jsx"></script>
  <script type="text/babel" src="/static/js/pms/pages/PerformanceAttributionPage.jsx"></script>
```
These must appear BEFORE the App.jsx script tag to ensure window globals are set before App resolves them.
  </action>
  <verify>
1. `grep -c "RiskMonitorPage" src/api/static/js/App.jsx` returns at least 2 (window resolution + route)
2. `grep -c "PerformanceAttributionPage" src/api/static/js/App.jsx` returns at least 2
3. `grep -c "PMSPlaceholder.*Risk Monitor" src/api/static/js/App.jsx` returns 0 (placeholder removed)
4. `grep -c "PMSPlaceholder.*Performance Attribution" src/api/static/js/App.jsx` returns 0 (placeholder removed)
5. `grep -c "RiskMonitorPage.jsx" src/api/static/dashboard.html` returns 1
6. `grep -c "PerformanceAttributionPage.jsx" src/api/static/dashboard.html` returns 1
  </verify>
  <done>
App.jsx routes updated: /pms/risk renders RiskMonitorPage, /pms/attribution renders PerformanceAttributionPage (no more PMSPlaceholder for these routes). Dashboard.html loads both new .jsx files before App.jsx.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `#/pms/risk` -- Risk Monitor page loads with sample data (4 quadrants, gauges, bars, pie, historical chart)
2. Navigate to `#/pms/attribution` -- Attribution page loads with sample data (waterfall, table, time-series chart)
3. Period selector on Attribution page changes data display (MTD default, Custom shows date pickers)
4. Dimension tabs on Attribution page switch between Strategy/Asset Class/Instrument views
5. No console errors from script loading order
6. Both pages use PMS dark theme styling consistent with Morning Pack, Position Book, and Trade Blotter
</verification>

<success_criteria>
- PerformanceAttributionPage.jsx exists and exposes window.PerformanceAttributionPage
- P&L waterfall chart shows floating bars for strategy contributions
- Attribution table displays with inline magnitude bars
- Time-series P&L dual chart works (daily bars + cumulative line)
- Period selector (Daily/MTD/QTD/YTD/Custom) updates all charts
- Dimension tabs switch between strategy/asset class/instrument views
- App.jsx routes /pms/risk and /pms/attribution to actual page components
- Dashboard.html loads both new page scripts before App.jsx
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-risk-monitor-performance-attribution/25-02-SUMMARY.md`
</output>
