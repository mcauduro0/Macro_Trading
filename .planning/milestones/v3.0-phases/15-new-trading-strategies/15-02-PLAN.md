---
phase: 15-new-trading-strategies
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/strategies/rates_03_br_us_spread.py
  - src/strategies/rates_04_term_premium.py
  - src/strategies/rates_05_fomc_event.py
  - src/strategies/rates_06_copom_event.py
  - tests/test_strategies/test_rates_new.py
autonomous: true
requirements: [RTST-01, RTST-02, RTST-03, RTST-04]

must_haves:
  truths:
    - "RATES-03 generates StrategySignal trading DI-UST spread adjusted for CDS, z-score mean reversion at 2Y and 5Y tenors"
    - "RATES-04 generates StrategySignal extracting term premium as DI(n) minus Focus-implied expected short rate, trading extreme z-scores"
    - "RATES-05 generates StrategySignal positioning around FOMC [-5,+2] days based on FFR implied vs Taylor Rule divergence, with adaptive post-event exit"
    - "RATES-06 generates StrategySignal positioning around COPOM [-5,+2] days based on divergence between DI1-implied Selic move and BCB reaction-function model estimate, with adaptive post-event exit"
    - "Event strategies (RATES-05/06) use market pricing only as expectation baseline -- DI1 curve for COPOM, Fed Funds futures for FOMC"
    - "All 4 rates strategies return empty list when data is missing (no forward-fill, no degraded models)"
  artifacts:
    - path: "src/strategies/rates_03_br_us_spread.py"
      provides: "RATES-03 BR-US Rate Spread strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/rates_04_term_premium.py"
      provides: "RATES-04 Term Premium Extraction strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/rates_05_fomc_event.py"
      provides: "RATES-05 FOMC Event Strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/rates_06_copom_event.py"
      provides: "RATES-06 COPOM Event Strategy"
      contains: "@StrategyRegistry.register"
    - path: "tests/test_strategies/test_rates_new.py"
      provides: "Unit tests for all 4 new rates strategies"
      min_lines: 120
  key_links:
    - from: "src/strategies/rates_05_fomc_event.py"
      to: "PointInTimeDataLoader"
      via: "get_curve, get_latest_macro_value for UST and FFR data"
      pattern: "self\\.data_loader\\.get_curve"
    - from: "src/strategies/rates_06_copom_event.py"
      to: "PointInTimeDataLoader"
      via: "get_curve for DI1, get_latest_macro_value for Selic/IPCA (BCB reaction function)"
      pattern: "self\\.data_loader\\."
---

<objective>
Implement 4 new rates trading strategies: RATES-03 (BR-US Rate Spread), RATES-04 (Term Premium Extraction), RATES-05 (FOMC Event), and RATES-06 (COPOM Event). Each registers via @StrategyRegistry.register, produces StrategySignal, and uses real data. Event strategies cover the full lifecycle (pre-event positioning + post-event adaptive exit).

Purpose: Expand rates coverage from 4 existing BR-only strategies to include cross-market spread trading and event-driven positioning around the two most important central bank meetings for the BR-US axis.

Output: 4 strategy files + 1 test file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-backtesting-engine-v2-strategy-framework/14-01-SUMMARY.md
@.planning/phases/15-new-trading-strategies/15-CONTEXT.md

# Key existing files to reference for patterns:
@src/strategies/base.py
@src/strategies/registry.py
@src/strategies/rates_br_01_carry.py
@src/strategies/rates_br_04_spillover.py
@src/agents/data_loader.py
@src/core/enums.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement RATES-03 BR-US Spread, RATES-04 Term Premium, and event strategies RATES-05/06</name>
  <files>
    src/strategies/rates_03_br_us_spread.py
    src/strategies/rates_04_term_premium.py
    src/strategies/rates_05_fomc_event.py
    src/strategies/rates_06_copom_event.py
  </files>
  <action>
Create 4 new rates strategy files following the established pattern from rates_br_01_carry.py and rates_br_04_spillover.py.

**RATES-03: BR-US Rate Spread** (`rates_03_br_us_spread.py`):
- Register with `@StrategyRegistry.register("RATES_03", asset_class=AssetClass.RATES_BR, instruments=["DI_PRE", "UST_NOM"])`
- Trade DI-UST spread adjusted for sovereign CDS at 2Y and 5Y tenors:
  1. Load DI curve via `data_loader.get_curve("DI_PRE", as_of_date)` and UST curve via `data_loader.get_curve("UST_NOM", as_of_date)`.
  2. Extract 2Y (504 days) and 5Y (1260 days) tenors (find closest available).
  3. Compute raw_spread = DI_rate - UST_rate at each tenor.
  4. CDS adjustment: Load `data_loader.get_latest_macro_value("BR_CDS_5Y", ...)`. If available, compute adjusted_spread = raw_spread - cds_spread_pct (convert CDS bps to %). If CDS unavailable, use raw_spread.
  5. Also load inflation differential: `get_latest_macro_value("BR_IPCA_12M", ...)` and `get_latest_macro_value("US_CPI_YOY", ...)`. Compute real_spread = adjusted_spread - (br_inflation - us_inflation).
  6. Build history using `data_loader.get_curve_history()` for both DI and UST at 504-day tenor, compute spread history, z-score current spread vs 504-day rolling window.
- Use the 2Y tenor as primary signal (more liquid), 5Y as confirmation.
- Direction: z > 0 (spread wide vs history) => expect mean reversion => SHORT spread (receive DI, pay UST) = LONG DI position. z < 0 => LONG spread = SHORT DI.
- Entry threshold: |z| >= 1.25
- Stop-loss: 2% (rates moves bounded)
- Take-profit: 3%
- holding_period_days: 21
- Return StrategySignal for DI_PRE instrument.

**RATES-04: Term Premium Extraction** (`rates_04_term_premium.py`):
- Register with `@StrategyRegistry.register("RATES_04", asset_class=AssetClass.RATES_BR, instruments=["DI_PRE"])`
- Estimate term premium as: TP = DI(n) - expected_short_rate_path
  1. Load DI curve via `data_loader.get_curve("DI_PRE", as_of_date)`. Use 2Y (504d) and 5Y (1260d) tenors.
  2. Load Focus Selic expectations: `data_loader.get_focus_expectations("SELIC", as_of_date)`. This gives the market-consensus expected Selic path.
  3. Implied expected rate = Focus Selic median (the average expected Selic over the tenor horizon).
  4. TP_2Y = DI_2Y - Focus_Selic_avg. TP_5Y = DI_5Y - Focus_Selic_avg.
  5. Build TP history: use curve_history for DI and macro_series for Focus, compute TP at each historical date, z-score current TP vs 252-day window.
- Direction: TP z > 0 (term premium elevated) => TP likely compresses => LONG DI (receive fixed). TP z < 0 (TP compressed) => SHORT DI.
- Entry threshold: |tp_z| >= 1.5
- Stop-loss: 1.5% (DI specific)
- Take-profit: 2.5%
- holding_period_days: 28 (term premium mean reversion is slow)

**RATES-05: FOMC Event Strategy** (`rates_05_fomc_event.py`):
- Register with `@StrategyRegistry.register("RATES_05", asset_class=AssetClass.RATES_US, instruments=["UST_NOM"])`
- Positioning around FOMC meetings [-5, +2] business days:
  1. Maintain a list of known FOMC meeting dates (hardcoded list of ~8 dates per year, covering 2015-2026). Method `_is_fomc_window(as_of_date)` returns (True, days_to_fomc) if within window.
  2. **Pre-event positioning** (days -5 to 0):
     - Market expectation: load UST curve `data_loader.get_curve("UST_NOM", as_of_date)`, extract short-end (2Y) rate as market-implied FFR path proxy.
     - Model expectation: simple Taylor rule using US CPI (`get_latest_macro_value("US_CPI_YOY", ...)`) and unemployment proxy (or use FFR level: `get_latest_macro_value("US_FED_FUNDS", ...)`). Taylor = r_star + inflation + 0.5*(inflation-2.0) + 0.5*(output_gap). Use r_star=2.5, output_gap approximation from unemployment or GDP proxy.
     - Divergence = market_implied - taylor_rule_rate
     - If divergence > 0: market pricing more hawkish than model => LONG UST (expect dovish surprise). If divergence < 0: SHORT UST.
     - Z-score divergence vs 504-day history of pre-FOMC divergences.
  3. **Post-event adaptive exit** (days +1, +2):
     - On day +1/+2 after FOMC: recalculate the divergence. If |divergence_z| has fallen below 0.5 (mispricing resolved), flatten position (return no signal). If still elevated, maintain position.
  4. **Outside FOMC window**: Return empty signal (no position).
- Entry threshold: |divergence_z| >= 1.0 during pre-event window
- Stop-loss: 1.5% (fixed, short-duration trade)
- Take-profit: 2.0%
- holding_period_days: 7 (event-driven, shorter than default)
- Per locked decision: Market pricing only for expectation baseline (no Focus survey data).

**RATES-06: COPOM Event Strategy** (`rates_06_copom_event.py`):
- Register with `@StrategyRegistry.register("RATES_06", asset_class=AssetClass.RATES_BR, instruments=["DI_PRE"])`
- Positioning around COPOM meetings [-5, +2] business days:
  1. Maintain a list of known COPOM meeting dates (hardcoded list of ~8 dates per year, covering 2015-2026). Method `_is_copom_window(as_of_date)` returns (True, days_to_copom).
  2. **Pre-event positioning** (days -5 to 0):
     - Market expectation: Load DI curve `data_loader.get_curve("DI_PRE", as_of_date)`. Extract short-end rate (DI_30 or closest short tenor). The gap between DI short-end and current Selic = market-implied next move.
     - DI-implied Selic move = DI_short - current_Selic (from `get_latest_macro_value("BR_SELIC_TARGET", ...)`).
     - Model expectation: Use Focus Selic median from `data_loader.get_focus_expectations("SELIC", as_of_date)` as an independent (non-market) forecast. WAIT -- per locked decision, market pricing only for expectation baseline, no Focus survey data. So instead: compute a simple BCB reaction function estimate: if IPCA_12M > 4.5% (upper band), model expects hike; if < 3.0% (lower band), expects cut. Else neutral. Model_implied_move = reaction_function_output.
     - ACTUALLY per locked decision: "Market expectation baseline: market pricing only -- DI1 curve for COPOM". The strategy uses DI1 curve as the market pricing. The "divergence" is between what DI1 prices in vs what a simple BCB model (Taylor-like) suggests. No Focus data in the baseline.
     - Divergence = DI_implied_move - model_implied_move
     - Z-score divergence vs historical pre-COPOM divergences (252-day history)
  3. **Post-event adaptive exit**: Same pattern as RATES-05. Recalculate divergence after COPOM. If |z| < 0.5, exit. Else maintain.
  4. **Outside COPOM window**: No signal.
- Direction: divergence > 0 (DI pricing more hawkish than model) => LONG DI (expect dovish surprise = rates fall). divergence < 0 => SHORT DI.
- Entry threshold: |z| >= 1.0
- Stop-loss: 1.5%
- Take-profit: 2.0%
- holding_period_days: 7

All 4 strategies: define module-level `*_CONFIG = StrategyConfig(...)`, use `self.compute_z_score()`, `self.classify_strength()`, `self.size_from_conviction()` from BaseStrategy.
  </action>
  <verify>
    python -c "
from src.strategies.rates_03_br_us_spread import Rates03BrUsSpreadStrategy
from src.strategies.rates_04_term_premium import Rates04TermPremiumStrategy
from src.strategies.rates_05_fomc_event import Rates05FomcEventStrategy
from src.strategies.rates_06_copom_event import Rates06CopomEventStrategy
from src.strategies.registry import StrategyRegistry
for s in ['RATES_03', 'RATES_04', 'RATES_05', 'RATES_06']:
    assert s in StrategyRegistry.list_all(), f'{s} not registered'
print('All 4 rates strategies registered successfully')
"
  </verify>
  <done>RATES-03, RATES-04, RATES-05, RATES-06 strategy classes exist with generate_signals returning StrategySignal; event strategies implement pre-event/post-event lifecycle with adaptive exit</done>
</task>

<task type="auto">
  <name>Task 2: Tests for all 4 new rates strategies</name>
  <files>
    tests/test_strategies/test_rates_new.py
  </files>
  <action>
**Tests** (`tests/test_strategies/test_rates_new.py`):
- Use mock PointInTimeDataLoader with MagicMock/patch (established test pattern)
- **RATES-03 tests (4 tests)**:
  - Test registration in StrategyRegistry
  - Test signal generation with valid DI and UST curves returns StrategySignal with z_score
  - Test CDS adjustment reduces spread when CDS data available
  - Test empty list returned when curve data missing
- **RATES-04 tests (4 tests)**:
  - Test registration
  - Test term premium calculation: DI_2Y > Focus_Selic => positive TP => StrategySignal
  - Test extreme TP z-score produces STRONG signal
  - Test missing Focus data returns empty list
- **RATES-05 tests (5 tests)**:
  - Test registration
  - Test signal generated when as_of_date is within 5 days before an FOMC date
  - Test no signal when as_of_date is outside FOMC window
  - Test post-event exit: when z reverts below 0.5 after FOMC, no signal
  - Test missing UST curve returns empty list
- **RATES-06 tests (5 tests)**:
  - Test registration
  - Test signal generated during COPOM window
  - Test no signal outside COPOM window
  - Test direction: DI pricing more hawkish than model => LONG direction
  - Test missing DI curve returns empty list
- At least 18 tests total
  </action>
  <verify>
    python -m pytest tests/test_strategies/test_rates_new.py -v --tb=short 2>&1 | tail -25
  </verify>
  <done>>=18 tests pass confirming signal generation, event windowing, adaptive exit, and missing-data handling for all 4 rates strategies</done>
</task>

</tasks>

<verification>
1. `python -c "from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_all())"` shows RATES_03, RATES_04, RATES_05, RATES_06 alongside existing strategies
2. `python -c "from src.core.enums import AssetClass; from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_by_asset_class(AssetClass.RATES_BR))"` returns existing BR rates + new ones
3. `python -c "from src.core.enums import AssetClass; from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_by_asset_class(AssetClass.RATES_US))"` returns RATES_05
4. `python -m pytest tests/test_strategies/test_rates_new.py -v` — all tests pass
5. Event strategy files contain FOMC/COPOM date lists and `_is_*_window()` methods
6. Backtest smoke-test: `python -c "from src.strategies.rates_03_br_us_spread import Rates03BrUsSpreadStrategy; from src.strategies.rates_04_term_premium import Rates04TermPremiumStrategy; from src.strategies.rates_05_fomc_event import Rates05FomcEventStrategy; from src.strategies.rates_06_copom_event import Rates06CopomEventStrategy; from src.backtesting.engine import BacktestEngine; from src.backtesting.costs import TransactionCostModel; print('All 4 rates strategies compatible with BacktestEngine and TransactionCostModel')"` — confirms v2 framework compatibility
</verification>

<success_criteria>
- 4 new rates strategy files exist and are importable
- All 4 register via @StrategyRegistry.register with correct asset classes
- RATES-03 trades DI-UST spread with CDS adjustment and z-score mean reversion
- RATES-04 extracts term premium as DI minus Focus-implied expected rate
- RATES-05 positions around FOMC with pre/post-event logic and adaptive exit
- RATES-06 positions around COPOM with pre/post-event logic and adaptive exit
- Event strategies use market pricing only as expectation baseline (locked decision)
- All strategies return empty on missing data
- All tests pass (>=18)
</success_criteria>

<output>
After completion, create `.planning/phases/15-new-trading-strategies/15-02-SUMMARY.md`
</output>
