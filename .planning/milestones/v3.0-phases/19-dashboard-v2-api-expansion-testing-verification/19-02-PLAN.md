---
phase: 19-dashboard-v2-api-expansion-testing-verification
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/api/static/js/pages/StrategiesPage.jsx
  - src/api/static/js/pages/SignalsPage.jsx
  - src/api/static/js/pages/RiskPage.jsx
  - src/api/static/js/pages/PortfolioPage.jsx
  - src/api/static/js/pages/AgentsPage.jsx
  - src/api/static/dashboard.html
autonomous: true
requirements:
  - DSHV-01
  - DSHV-02
  - DSHV-03
  - DSHV-04
  - DSHV-05

must_haves:
  truths:
    - "StrategiesPage renders a table of 24+ strategies with expandable rows showing backtest metrics and equity curve"
    - "StrategiesPage has asset class filter tabs (All, FX, Rates, Inflation, Cupom, Sovereign, Cross-Asset)"
    - "SignalsPage shows a heatmap of strategies x time with color-coded direction/conviction"
    - "SignalsPage shows a signal flip timeline below the heatmap"
    - "RiskPage displays VaR gauges, stress test bar chart, limits panel, and concentration pie in a single view"
    - "PortfolioPage shows positions table, equity curve with drawdown overlay, monthly return heatmap, and strategy attribution"
    - "AgentsPage shows 5 agent cards with signal, confidence, drivers, and Cross-Asset narrative"
  artifacts:
    - path: "src/api/static/js/pages/StrategiesPage.jsx"
      provides: "Strategy table with expandable backtest rows and asset class filters"
      min_lines: 120
    - path: "src/api/static/js/pages/SignalsPage.jsx"
      provides: "Signal heatmap and flip timeline"
      min_lines: 100
    - path: "src/api/static/js/pages/RiskPage.jsx"
      provides: "VaR gauges, stress bars, limits panel, concentration pie"
      min_lines: 120
    - path: "src/api/static/js/pages/PortfolioPage.jsx"
      provides: "Positions, equity curve, monthly heatmap, attribution"
      min_lines: 100
    - path: "src/api/static/js/pages/AgentsPage.jsx"
      provides: "Agent cards with signal/confidence/drivers/narrative"
      min_lines: 80
  key_links:
    - from: "src/api/static/js/pages/StrategiesPage.jsx"
      to: "/api/v1/strategies"
      via: "useFetch hook"
      pattern: "useFetch.*strategies"
    - from: "src/api/static/js/pages/RiskPage.jsx"
      to: "/api/v1/risk/dashboard"
      via: "useFetch hook"
      pattern: "useFetch.*risk"
    - from: "src/api/static/js/pages/AgentsPage.jsx"
      to: "/api/v1/agents"
      via: "useFetch hook"
      pattern: "useFetch.*agents"
    - from: "src/api/static/js/pages/SignalsPage.jsx"
      to: "/api/v1/signals/dashboard"
      via: "useFetch hook"
      pattern: "useFetch.*signals"
    - from: "src/api/static/js/pages/PortfolioPage.jsx"
      to: "/api/v1/portfolio/current"
      via: "useFetch hook"
      pattern: "useFetch.*portfolio/current"
    - from: "src/api/static/js/pages/PortfolioPage.jsx"
      to: "/api/v1/portfolio/attribution"
      via: "useFetch hook"
      pattern: "useFetch.*portfolio/attribution"
    - from: "src/api/static/dashboard.html"
      to: "src/api/static/js/pages/*.jsx"
      via: "script tags loading page components"
      pattern: "pages/.*\\.jsx"
---

<objective>
Build the 5 dashboard page components: StrategiesPage (expandable table + asset class filters), SignalsPage (heatmap + flip timeline), RiskPage (VaR gauges + stress bars + limits + pie), PortfolioPage (positions + equity curve + monthly heatmap + attribution), and AgentsPage (5 agent cards + narrative).

Purpose: Delivers the complete visual dashboard experience, consuming data from existing API endpoints via useFetch hooks from Plan 19-01.
Output: 5 .jsx page files loaded by dashboard.html, each rendering interactive data visualizations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-dashboard-v2-api-expansion-testing-verification/19-CONTEXT.md
@.planning/phases/19-dashboard-v2-api-expansion-testing-verification/19-01-SUMMARY.md
@src/api/static/dashboard.html
@src/api/static/js/hooks.jsx
@src/api/routes/strategies_api.py
@src/api/routes/risk_api.py
@src/api/routes/portfolio_api.py
@src/api/routes/agents.py
@src/api/routes/signals.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: StrategiesPage, SignalsPage, and RiskPage components</name>
  <files>
    src/api/static/js/pages/StrategiesPage.jsx
    src/api/static/js/pages/SignalsPage.jsx
    src/api/static/js/pages/RiskPage.jsx
    src/api/static/dashboard.html
  </files>
  <action>
**StrategiesPage.jsx** — Create strategy table with expandable rows:
- Use `useFetch('/api/v1/strategies')` for strategy list data
- State: `expandedId` (string|null), `filter` (string, default 'All')
- Asset class filter tabs: All | FX | Rates | Inflation | Cupom | Sovereign | Cross-Asset — rendered as Tailwind-styled buttons, clicking filters the table
- Table columns: Strategy ID, Asset Class, Current Signal (color-coded arrow), Sharpe, MaxDD
- Clicking a row sets expandedId, showing an expanded section below that row with:
  - Backtest metrics grid: Ann.Ret, Sharpe, Sortino, MaxDD, Win Rate, Trades, Turnover (use `useFetch('/api/v1/backtest/results?strategy_id=${id}')` when expanded)
  - Equity curve via Recharts LineChart (from backtest data equity_curve array)
- Loading state: show skeleton/spinner when data is loading
- Error state: show error banner
- Color-code signals: green for LONG, red for SHORT, gray for NEUTRAL
- Expose `window.StrategiesPage = StrategiesPage`

**SignalsPage.jsx** — Create signal heatmap and flip timeline:
- Use `useFetch('/api/v1/signals/dashboard')` for signal data
- Heatmap section:
  - Y-axis: strategy IDs grouped by asset class
  - X-axis: last 30 days (dates)
  - Each cell colored: green shades for LONG (intensity = conviction), red shades for SHORT, gray for NEUTRAL
  - Implement as a CSS grid or HTML table with inline background-color styles (Recharts does not have a native heatmap; use a custom grid component)
- Signal flip timeline section below:
  - Chronological list of recent signal changes
  - Each entry: date, strategy ID, old direction -> new direction, conviction level
  - Use simple card/row layout with Tailwind
- Expose `window.SignalsPage = SignalsPage`

**RiskPage.jsx** — Create dense single-view risk dashboard:
- Use `useFetch('/api/v1/risk/dashboard')` for aggregated risk data (VaR, stress, limits)
- Top row: 3 gauge widgets for VaR 95%, VaR 99%, CVaR
  - Gauge: semi-circular SVG arc with value text in center, color changes by severity (green < 5%, yellow < 10%, red >= 10%)
  - Implement as a simple SVG-based component (GaugeChart) with arc path
- Left column: Stress test bar chart using Recharts BarChart
  - 6+ scenarios as horizontal bars showing P&L impact (negative = red, positive = green)
  - Use Recharts BarChart with layout="vertical" for horizontal bars
- Right column: Limits status panel
  - Table rows: Leverage, VaR, Drawdown, Concentration
  - Each row: limit name, current value, limit value, utilization %, status badge (OK green, WARN yellow, BREACH red)
- Bottom: Concentration pie chart using Recharts PieChart
  - Slices by asset class with percentages
- Use Tailwind grid layout: `grid grid-cols-2 gap-4` for the main layout
- Expose `window.RiskPage = RiskPage`
  </action>
  <verify>
Verify all 3 files exist and contain the expected components:
- StrategiesPage.jsx contains `useFetch`, filter tabs, expandable row logic
- SignalsPage.jsx contains heatmap grid and flip timeline
- RiskPage.jsx contains GaugeChart SVG, BarChart, PieChart
Check dashboard.html includes script tags for all 3 page files.
  </verify>
  <done>
Three page components created: StrategiesPage (expandable table with asset class filters, backtest metrics, equity curve), SignalsPage (color-coded heatmap grid + flip timeline), RiskPage (SVG gauge widgets, stress bar chart, limits panel, concentration pie). All use useFetch for data loading with 30s polling.
  </done>
</task>

<task type="auto">
  <name>Task 2: PortfolioPage and AgentsPage components</name>
  <files>
    src/api/static/js/pages/PortfolioPage.jsx
    src/api/static/js/pages/AgentsPage.jsx
    src/api/static/dashboard.html
  </files>
  <action>
**PortfolioPage.jsx** — Create portfolio dashboard with 4 sections:
- Use `useFetch('/api/v1/portfolio/current')` for positions and `useFetch('/api/v1/portfolio/attribution')` for attribution data
- Section 1 — Positions table:
  - Columns: Instrument, Direction, Size, PnL, Risk Contribution
  - Color PnL green/red based on sign
  - Suggested trades row at bottom (if available from API)
- Section 2 — Equity curve:
  - Recharts LineChart with equity value over time
  - Drawdown overlay using Recharts AreaChart (negative area below zero line, light red fill)
  - Compose both in a ComposedChart or stack vertically
- Section 3 — Monthly return heatmap:
  - Grid: months (Jan-Dec) as columns, years as rows
  - Cell color: green intensity for positive returns, red for negative
  - Implement as HTML table with inline bg colors (same pattern as SignalsPage heatmap)
- Section 4 — Strategy attribution:
  - Recharts horizontal BarChart showing each strategy's return contribution
  - Sorted by absolute contribution (largest first)
- Use Tailwind `grid grid-cols-2 gap-4` for 2x2 layout
- Expose `window.PortfolioPage = PortfolioPage`

**AgentsPage.jsx** — Create agent cards layout:
- Use `useFetch('/api/v1/agents/signals')` for agent signal data
- 5 agent cards in a responsive grid (`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`)
- Each card (Tailwind bg-gray-800 rounded-lg p-6):
  - Header: Agent name (e.g., "Inflation Agent") with icon
  - Signal direction badge: LONG (green), SHORT (red), NEUTRAL (gray)
  - Confidence bar: horizontal bar filled proportionally (0-100%), color matches direction
  - Key drivers: bulleted list of 3-5 key factors from agent report
  - Risks section: brief risk factors
- Cross-Asset Agent card (special):
  - Larger card (spans 2 columns on lg screens)
  - Shows regime classification (Goldilocks/Reflation/Stagflation/Deflation) with color badge
  - LLM narrative section: rendered as a blockquote with italic styling
  - If no narrative, show "Narrative unavailable — using template fallback" in muted text
- Expose `window.AgentsPage = AgentsPage`

**dashboard.html** — Update the shell to include script tags for all 5 page .jsx files:
- Add script tags BEFORE App.jsx (since App.jsx references page components):
  ```html
  <script type="text/babel" src="/static/js/pages/StrategiesPage.jsx"></script>
  <script type="text/babel" src="/static/js/pages/SignalsPage.jsx"></script>
  <script type="text/babel" src="/static/js/pages/RiskPage.jsx"></script>
  <script type="text/babel" src="/static/js/pages/PortfolioPage.jsx"></script>
  <script type="text/babel" src="/static/js/pages/AgentsPage.jsx"></script>
  ```
- Remove the inline placeholder page components that were in Plan 19-01 (they are now in separate files)
  </action>
  <verify>
Verify all 5 page files exist in src/api/static/js/pages/:
`ls -la src/api/static/js/pages/`
Verify dashboard.html has script tags for all 5 pages.
Verify PortfolioPage.jsx contains equity curve LineChart and monthly heatmap grid.
Verify AgentsPage.jsx contains agent cards with Cross-Asset narrative section.
  </verify>
  <done>
All 5 page components complete: PortfolioPage (positions table, equity/drawdown chart, monthly return heatmap, strategy attribution bars) and AgentsPage (5 agent cards with signal/confidence/drivers, Cross-Asset card with regime badge and LLM narrative). dashboard.html updated with all page script tags. Full dashboard operational with sidebar navigation between all 5 pages.
  </done>
</task>

</tasks>

<verification>
1. All 5 page .jsx files exist in src/api/static/js/pages/
2. dashboard.html loads all .jsx files in correct order (hooks -> Sidebar -> pages -> App)
3. StrategiesPage has expandable rows and asset class filter tabs
4. SignalsPage has color-coded heatmap and flip timeline
5. RiskPage has SVG gauges, stress bar chart, limits table, concentration pie
6. PortfolioPage has positions, equity curve, monthly heatmap, attribution
7. AgentsPage has 5 cards with Cross-Asset narrative support
8. All pages use useFetch for 30s polling data refresh
</verification>

<success_criteria>
- 5 page components render correctly within the HashRouter layout
- Each page fetches data from its respective API endpoint(s) via useFetch
- StrategiesPage filters by asset class and expands rows inline
- RiskPage displays all risk metrics in a single-view layout without scrolling
- AgentsPage Cross-Asset card shows regime and narrative
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-v2-api-expansion-testing-verification/19-02-SUMMARY.md`
</output>
