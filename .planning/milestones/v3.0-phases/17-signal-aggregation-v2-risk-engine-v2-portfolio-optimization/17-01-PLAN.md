---
phase: 17-signal-aggregation-v2-risk-engine-v2-portfolio-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/portfolio/signal_aggregator_v2.py
  - src/portfolio/signal_monitor.py
  - tests/test_signal_aggregator_v2.py
  - tests/test_signal_monitor.py
autonomous: true
requirements:
  - SAGG-01
  - SAGG-02
  - SAGG-03
  - SAGG-04

must_haves:
  truths:
    - "SignalAggregator v2 supports 3 aggregation methods: confidence-weighted average, rank-based, and Bayesian with regime prior"
    - "Bayesian is the default method; flat prior used when no regime context available"
    - "Crowding penalty applies a gentle 20% reduction when >80% of strategies agree on direction"
    - "Staleness discount linearly decays signal weight to zero over 5 business days"
    - "Regime prior tilts asset-class strategy weights based on HMM regime probabilities"
    - "SignalMonitor detects signal flips (any sign change), conviction surges (>0.3 absolute jump), and strategy divergence (>0.5 within asset class)"
    - "SignalMonitor generates a full daily summary grouped by asset class with regime context and triggered alerts"
  artifacts:
    - path: "src/portfolio/signal_aggregator_v2.py"
      provides: "Enhanced SignalAggregator with 3 methods, crowding, staleness, regime tilting"
      min_lines: 200
    - path: "src/portfolio/signal_monitor.py"
      provides: "SignalMonitor with flip/surge/divergence detection and daily summary"
      min_lines: 150
    - path: "tests/test_signal_aggregator_v2.py"
      provides: "Tests for all 3 methods, crowding penalty, staleness discount"
      min_lines: 100
    - path: "tests/test_signal_monitor.py"
      provides: "Tests for flip detection, surge detection, divergence, daily summary"
      min_lines: 80
  key_links:
    - from: "src/portfolio/signal_aggregator_v2.py"
      to: "src/agents/cross_asset_view.py"
      via: "CrossAssetView regime_probabilities for Bayesian prior"
      pattern: "regime_prob|CrossAssetView"
    - from: "src/portfolio/signal_aggregator_v2.py"
      to: "src/strategies/base.py"
      via: "StrategySignal inputs for aggregation"
      pattern: "StrategySignal"
    - from: "src/portfolio/signal_monitor.py"
      to: "src/portfolio/signal_aggregator_v2.py"
      via: "AggregatedSignalV2 for monitoring"
      pattern: "AggregatedSignalV2"
---

<objective>
Build the enhanced SignalAggregator v2 with three aggregation methods (confidence-weighted average, rank-based, Bayesian with regime prior), crowding penalty, staleness discount, and regime tilting. Also build SignalMonitor for detecting signal flips, conviction surges, strategy divergence, and generating comprehensive daily summaries.

Purpose: The existing SignalAggregator (Phase 12) uses simple weighted vote consensus from agent signals. The v2 replaces this with strategy-signal-level aggregation using Bayesian methods with regime-aware priors -- the quantitative core that determines WHAT the fund should trade and with HOW MUCH conviction.

Output: Two new modules (signal_aggregator_v2.py, signal_monitor.py) with comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/portfolio/signal_aggregator.py
@src/strategies/base.py
@src/agents/cross_asset_view.py
@src/core/enums.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: SignalAggregator v2 with 3 aggregation methods, crowding penalty, and staleness discount</name>
  <files>src/portfolio/signal_aggregator_v2.py, tests/test_signal_aggregator_v2.py</files>
  <action>
Create `src/portfolio/signal_aggregator_v2.py` — an enhanced signal aggregator that works on StrategySignal objects (from `src/strategies/base.py`) rather than AgentSignal. The existing `signal_aggregator.py` (Phase 12) is preserved for backward compatibility; this is a new module.

**AggregatedSignalV2 dataclass:**
- instrument: str — target instrument
- direction: SignalDirection (LONG/SHORT/NEUTRAL)
- conviction: float — [-1, +1] aggregate conviction score
- confidence: float — [0, 1] average confidence
- method: str — aggregation method used
- contributing_strategies: list[dict] — strategy_id, raw_signal, weight, staleness_days
- crowding_applied: bool — whether crowding penalty fired
- crowding_discount: float — 0.0 or 0.2
- staleness_adjustments: dict[str, float] — strategy_id -> staleness discount factor
- regime_context: str | None — regime name if Bayesian used
- timestamp: datetime

**SignalAggregatorV2 class:**
- `__init__(self, method="bayesian", staleness_max_days=5, crowding_threshold=0.8, crowding_discount=0.2)` — method is default aggregation method (one of "confidence_weighted", "rank_based", "bayesian"), staleness_max_days controls linear decay window
- `aggregate(self, signals: list[StrategySignal], regime_probs: dict[str, float] | None = None) -> list[AggregatedSignalV2]` — main entry point. Groups signals by instrument, applies staleness discount, runs chosen aggregation method, applies crowding penalty. regime_probs is optional dict like {"Goldilocks": 0.6, "Reflation": 0.2, "Stagflation": 0.1, "Deflation": 0.1} from CrossAssetView.

**Staleness discount (per user decision):**
- Each StrategySignal has a `timestamp` field. Compute staleness_days = business days between signal.timestamp and now (or a configurable as_of_date).
- Factor = max(0.0, 1.0 - staleness_days / staleness_max_days). So day 0 = 1.0, day 1 = 0.8, day 2 = 0.6, ..., day 5 = 0.0.
- Apply: adjusted_weight = original_weight * factor. Signals at zero weight are excluded from aggregation.

**Method 1: confidence_weighted_average:**
- For each instrument group: weighted_sum = sum(signal.conviction * signal.confidence * staleness_factor) / sum(signal.confidence * staleness_factor). Conviction is derived from the signal's z_score clamped to [-1, +1] (z_score / 2.0 clamped). Confidence comes from StrategySignal.confidence.

**Method 2: rank_based:**
- Rank signals by conviction magnitude (robust to outliers). Assign rank scores: top signal gets 1.0, bottom gets -1.0, intermediate linearly interpolated. Preserve direction. Final conviction = mean of rank-weighted scores.

**Method 3: bayesian (default, per user decision):**
- Prior: If regime_probs provided, use regime-aware strategy tilting. Define REGIME_STRATEGY_TILTS mapping: {"Goldilocks": {"RATES_": 1.0, "FX_": 1.0, "INF_": 0.8, ...}, "Stagflation": {"INF_": 1.5, "FX_": 0.7, ...}, ...}. Tilt = regime_prob * tilt_factor summed across regimes. This tilts WHICH strategies to trust based on regime (per user decision: "Regime determines WHICH strategies to trust, not overall conviction level").
- If no regime_probs: flat prior (all strategies equally weighted — Bayesian with flat prior per user decision).
- Posterior: For each instrument, posterior_conviction = sum(signal.conviction * signal.confidence * staleness_factor * regime_tilt) / sum(signal.confidence * staleness_factor * regime_tilt).

**Crowding penalty (per user decision):**
- After aggregation, for each instrument: count what fraction of contributing strategies agree on direction (positive/negative conviction). If agreement_fraction > crowding_threshold (default 0.80), apply a gentle 20% reduction: conviction *= (1.0 - crowding_discount). Set crowding_applied=True.

**Direction classification:**
- conviction > 0.05 -> LONG, conviction < -0.05 -> SHORT, else NEUTRAL. Threshold at 0.05 (half of the old 0.1) since we're working with strategy signals which are more granular.

**Tests (tests/test_signal_aggregator_v2.py):**
- Test confidence_weighted method produces correct conviction sign
- Test rank_based method is robust to an outlier signal
- Test bayesian method with flat prior equals confidence_weighted behavior
- Test bayesian method with Stagflation regime tilts inflation strategy weights higher
- Test crowding penalty fires at >80% agreement and reduces conviction by 20%
- Test staleness discount: day-0 signal full weight, day-3 signal 40% weight, day-5+ signal excluded
- Test empty signals list returns empty results
- Test single signal passes through unchanged (no crowding)
  </action>
  <verify>cd /home/user/Macro_Trading && python -m pytest tests/test_signal_aggregator_v2.py -v</verify>
  <done>SignalAggregatorV2 with 3 methods passes all tests; crowding penalty fires at >80% agreement; staleness linearly decays over 5 days; Bayesian regime tilting shifts strategy weights based on regime probabilities</done>
</task>

<task type="auto">
  <name>Task 2: SignalMonitor with flip detection, conviction surge, strategy divergence, and daily summary</name>
  <files>src/portfolio/signal_monitor.py, tests/test_signal_monitor.py</files>
  <action>
Create `src/portfolio/signal_monitor.py` — monitors aggregated signals for anomalies and generates comprehensive daily reports.

**SignalFlip dataclass:**
- instrument: str
- previous_direction: SignalDirection
- current_direction: SignalDirection
- previous_conviction: float
- current_conviction: float
- timestamp: datetime

**ConvictionSurge dataclass:**
- instrument: str
- previous_conviction: float
- current_conviction: float
- absolute_change: float
- timestamp: datetime

**StrategyDivergence dataclass:**
- asset_class: str
- strategy_a: str
- strategy_b: str
- conviction_a: float
- conviction_b: float
- divergence: float — absolute difference
- timestamp: datetime

**DailySignalSummary dataclass:**
- date: date
- active_signals: list[dict] — all non-zero conviction signals grouped by asset class
- regime_context: str — current regime name
- flips: list[SignalFlip]
- surges: list[ConvictionSurge]
- divergences: list[StrategyDivergence]
- weekly_flip_count: int — flips in last 7 calendar days (per user decision: track weekly)
- alert_count: int — total alerts (flips + surges + divergences)
- summary_text: str — formatted human-readable report

**SignalMonitor class:**
- `__init__(self, surge_threshold=0.3, divergence_threshold=0.5)` — configurable thresholds per user decisions
- Internal state: `_signal_history: dict[str, list[tuple[datetime, float]]]` — instrument -> [(timestamp, conviction)] for tracking changes over time. Also `_flip_history: list[SignalFlip]` for weekly flip count.

- `check_signal_flips(self, previous: list[AggregatedSignalV2], current: list[AggregatedSignalV2]) -> list[SignalFlip]` — detect any sign change in conviction between previous and current. Per user decision: "any sign change is flagged". Match by instrument. Record in _flip_history for weekly tracking.

- `check_conviction_surge(self, previous: list[AggregatedSignalV2], current: list[AggregatedSignalV2]) -> list[ConvictionSurge]` — detect when absolute change in conviction > surge_threshold (default 0.3, per user decision: "absolute jump >0.3"). Pure magnitude check (per user decision: "does not adapt to recent volatility").

- `check_strategy_divergence(self, signals: list[StrategySignal]) -> list[StrategyDivergence]` — per user decision: "pairwise within asset class" — group strategy signals by asset class (infer from strategy_id prefix), then check all pairs within each class. Flag when any 2 strategies disagree by >0.5. Use strategy_id prefix mapping: RATES_/CUPOM_/INF_/SOV_ -> FIXED_INCOME, FX_ -> FX, etc. "Names the specific conflicting strategies" per user decision.

- `generate_daily_summary(self, current_signals: list[AggregatedSignalV2], raw_signals: list[StrategySignal], regime: str = "Unknown", previous_signals: list[AggregatedSignalV2] | None = None) -> DailySignalSummary` — per user decision: "full report — all active signals grouped by asset class, regime context, and all triggered alerts". If previous_signals provided, also runs flip and surge detection. Always runs divergence detection on raw_signals.

  Summary text format (comprehensive dashboard-style):
  ```
  === DAILY SIGNAL SUMMARY (YYYY-MM-DD) ===
  Regime: {regime}
  Active Signals: {N} | Alerts: {M}

  FIXED_INCOME:
    DI_PRE: conviction=+0.45, confidence=0.72, direction=LONG
    NTN_B: conviction=-0.30, confidence=0.55, direction=SHORT

  FX:
    USDBRL: conviction=+0.62, confidence=0.81, direction=LONG

  ALERTS:
    [FLIP] USDBRL: SHORT -> LONG
    [SURGE] DI_PRE: conviction jumped +0.35 (from +0.10 to +0.45)
    [DIVERGENCE] FIXED_INCOME: RATES_BR_01 (+0.45) vs INF_BR_01 (-0.30) — divergence 0.75

  Weekly Flip Count: 3 (unstable signals may need investigation)
  ```

**Tests (tests/test_signal_monitor.py):**
- Test flip detection: signal goes from positive to negative conviction -> flip detected
- Test no flip when both signals same sign but different magnitude
- Test conviction surge: change > 0.3 triggers, change of 0.2 does not
- Test strategy divergence: two same-asset-class strategies disagreeing by >0.5 flagged
- Test divergence not flagged for cross-asset-class pairs
- Test daily summary includes all active signals, grouped correctly
- Test weekly flip count tracks flips over 7 days
- Test empty signals produce valid but empty summary
  </action>
  <verify>cd /home/user/Macro_Trading && python -m pytest tests/test_signal_monitor.py -v</verify>
  <done>SignalMonitor detects flips, surges (>0.3), and divergence (>0.5 within asset class), generates comprehensive daily summary with grouped signals and all alerts</done>
</task>

</tasks>

<verification>
```bash
cd /home/user/Macro_Trading && python -m pytest tests/test_signal_aggregator_v2.py tests/test_signal_monitor.py -v --tb=short
```

Additional checks:
- `python -c "from src.portfolio.signal_aggregator_v2 import SignalAggregatorV2, AggregatedSignalV2; print('Import OK')"` — module imports cleanly
- `python -c "from src.portfolio.signal_monitor import SignalMonitor, DailySignalSummary; print('Import OK')"` — module imports cleanly
- Verify existing signal_aggregator.py is untouched (backward compatibility preserved)
</verification>

<success_criteria>
- SignalAggregatorV2 supports 3 methods: confidence_weighted, rank_based, bayesian (default)
- Bayesian method uses regime probabilities to tilt strategy weights; flat prior when no regime context
- Crowding penalty reduces conviction by 20% when >80% of strategies agree
- Staleness discount linearly decays signal weight to zero over 5 business days
- SignalMonitor detects signal flips, conviction surges (>0.3), and strategy divergence (>0.5 within asset class)
- Daily summary is comprehensive with all active signals grouped by asset class, regime context, and all alerts
- All tests pass
- Existing signal_aggregator.py is not modified
</success_criteria>

<output>
After completion, create `.planning/phases/17-signal-aggregation-v2-risk-engine-v2-portfolio-optimization/17-01-SUMMARY.md`
</output>
