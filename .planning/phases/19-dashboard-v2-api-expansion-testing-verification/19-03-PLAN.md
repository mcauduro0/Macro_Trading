---
phase: 19-dashboard-v2-api-expansion-testing-verification
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/routes/backtest_api.py
  - src/api/routes/strategies_api.py
  - src/api/routes/websocket_api.py
  - src/api/main.py
autonomous: true
requirements:
  - APIV-01
  - APIV-02
  - APIV-03
  - APIV-04

must_haves:
  truths:
    - "POST /api/v1/backtest/run accepts strategy_id and returns 202 with job status"
    - "GET /api/v1/backtest/results returns backtest results for a strategy"
    - "POST /api/v1/backtest/portfolio accepts strategy_ids and weights for portfolio backtest"
    - "GET /api/v1/backtest/comparison returns side-by-side strategy comparison"
    - "GET /api/v1/strategies/{id} returns full strategy detail with parameters"
    - "GET /api/v1/strategies/{id}/signal/latest returns the latest signal"
    - "GET /api/v1/strategies/{id}/signal/history returns signal history for heatmap"
    - "PUT /api/v1/strategies/{id}/params accepts parameter updates"
    - "WebSocket connections accepted at ws://host/ws/signals, ws://host/ws/portfolio, ws://host/ws/alerts"
    - "main.py includes all routers with Swagger tags covering all 13 categories"
  artifacts:
    - path: "src/api/routes/backtest_api.py"
      provides: "4 backtest endpoints (run, results, portfolio, comparison)"
      min_lines: 80
    - path: "src/api/routes/strategies_api.py"
      provides: "Enhanced strategy endpoints (detail, signal/latest, signal/history, params update)"
      contains: "signal/latest"
    - path: "src/api/routes/websocket_api.py"
      provides: "ConnectionManager and 3 WebSocket channel endpoints"
      contains: "ConnectionManager"
    - path: "src/api/main.py"
      provides: "All routers mounted with comprehensive Swagger tags"
      contains: "backtest_api"
  key_links:
    - from: "src/api/routes/backtest_api.py"
      to: "src/backtesting/"
      via: "import BacktestEngine, StrategyRegistry"
      pattern: "BacktestEngine|StrategyRegistry"
    - from: "src/api/routes/strategies_api.py"
      to: "src/strategies/"
      via: "import StrategyRegistry"
      pattern: "StrategyRegistry"
    - from: "src/api/routes/websocket_api.py"
      to: "src/api/main.py"
      via: "router include"
      pattern: "websocket_api"
    - from: "src/api/main.py"
      to: "src/api/routes/backtest_api.py"
      via: "include_router"
      pattern: "backtest_api"
---

<objective>
Create the expanded API layer: backtest endpoints (run, results, portfolio, comparison), enhanced strategy detail endpoints (detail, signal/latest, signal/history, params), WebSocket ConnectionManager with 3 channels (signals, portfolio, alerts), and updated main.py integrating all routers with comprehensive Swagger tags.

Purpose: Provides the backend API surface that the dashboard (Plan 19-02) and integration tests (Plan 19-04) consume. WebSocket channels enable real-time alert delivery.
Output: 3 route modules (backtest_api.py, enhanced strategies_api.py, websocket_api.py) + updated main.py.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-dashboard-v2-api-expansion-testing-verification/19-CONTEXT.md
@src/api/main.py
@src/api/routes/strategies_api.py
@src/backtesting/engine.py
@src/strategies/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backtest API, enhanced Strategy API, and WebSocket endpoints</name>
  <files>
    src/api/routes/backtest_api.py
    src/api/routes/strategies_api.py
    src/api/routes/websocket_api.py
  </files>
  <action>
**backtest_api.py** — Create new file with 4 backtest endpoints:
- Router: `APIRouter(prefix="/backtest", tags=["Backtest"])`
- Use the standard response envelope: `{"status": "ok", "data": ..., "meta": {"timestamp": ...}}`

1. `POST /run` — Trigger backtest for a strategy:
   - Request body: `{"strategy_id": str, "start_date": str (optional), "end_date": str (optional)}`
   - Import StrategyRegistry, BacktestEngine, BacktestConfig
   - Validate strategy_id exists in StrategyRegistry
   - Run backtest via `asyncio.to_thread()` wrapping `BacktestEngine(config).run(strategy)`
   - Return 202 with backtest results (sharpe, annual_return, max_drawdown, total_trades, equity_curve as list)
   - On error: return sample/placeholder result with note field

2. `GET /results` — Retrieve backtest results:
   - Query params: `strategy_id` (required)
   - Try to fetch from backtest_results table via async session
   - Fallback to placeholder data if DB unavailable
   - Return result with metrics dict

3. `POST /portfolio` — Portfolio-level backtest:
   - Request body: `{"strategy_ids": list[str], "weights": dict[str, float] (optional)}`
   - Use BacktestEngine.run_portfolio() via asyncio.to_thread()
   - Return portfolio metrics (combined sharpe, equity curve, attribution, correlation matrix)
   - On error: return sample portfolio result

4. `GET /comparison` — Compare strategy backtests:
   - Query params: `strategy_ids` (comma-separated string)
   - For each strategy: fetch or compute backtest results
   - Return dict of strategy_id -> metrics for side-by-side comparison
   - Fallback to sample data per strategy

**strategies_api.py** — Enhance existing file with 3 new endpoints (keep existing endpoints):

1. `GET /{strategy_id}` — Full strategy detail:
   - Use StrategyRegistry to get strategy class and metadata
   - Return: strategy_id, class_name, asset_class, instruments, description, parameters (config dict), status
   - 404 if not found

2. `GET /{strategy_id}/signal/latest` — Latest signal:
   - Instantiate strategy, run generate_signals() via asyncio.to_thread()
   - Return: signal direction, strength, confidence, z_score, timestamp
   - Fallback to placeholder signal if strategy fails

3. `GET /{strategy_id}/signal/history` — Signal history for heatmap:
   - Query params: `days` (default 30)
   - Try to query strategy_signals table for historical data
   - Return list of {date, direction, conviction} entries
   - Fallback to sample history data

4. `PUT /{strategy_id}/params` — Update strategy parameters:
   - Request body: dict of parameter key-value pairs
   - Validate strategy exists
   - Return 200 with updated params (note: runtime params, not persisted)

**websocket_api.py** — Create new file with ConnectionManager and 3 WebSocket endpoints:
- `ConnectionManager` class:
  - `active: dict[str, set]` mapping channel names to sets of WebSocket connections
  - `async connect(websocket, channel)`: accept websocket, add to channel set
  - `disconnect(websocket, channel)`: remove from channel set
  - `async broadcast(channel, message)`: send JSON to all connected clients on channel, catch and remove disconnected clients
- Module-level singleton: `manager = ConnectionManager()`
- Router: `APIRouter(tags=["WebSocket"])`

1. `@router.websocket("/ws/signals")`:
   - Accept connection, register with manager on "signals" channel
   - Loop receiving messages (keepalive), catch WebSocketDisconnect to cleanup

2. `@router.websocket("/ws/portfolio")`:
   - Same pattern as signals, "portfolio" channel

3. `@router.websocket("/ws/alerts")`:
   - Same pattern as alerts, "alerts" channel

- Export `manager` so other modules can call `manager.broadcast("alerts", {...})` to push events
  </action>
  <verify>
Verify all 3 files exist and contain expected components:
- backtest_api.py has 4 endpoints (POST /run, GET /results, POST /portfolio, GET /comparison)
- strategies_api.py has new endpoints (/{id}, /{id}/signal/latest, /{id}/signal/history, PUT /{id}/params)
- websocket_api.py has ConnectionManager class and 3 websocket endpoints
Run: `python -c "from src.api.routes.backtest_api import router; print('backtest routes:', len(router.routes))"`
Run: `python -c "from src.api.routes.websocket_api import manager; print('manager channels:', type(manager.active))"`
  </verify>
  <done>
Three route modules created/updated: backtest_api.py (4 backtest endpoints with strategy/portfolio level analysis), strategies_api.py (4 new strategy detail endpoints for signals and params), websocket_api.py (ConnectionManager with broadcast support and 3 WebSocket channel endpoints).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update main.py with all routers and Swagger tags</name>
  <files>
    src/api/main.py
  </files>
  <action>
**main.py** — Update to include all new routers and organize Swagger tags:

1. Add imports for new route modules:
   ```python
   from src.api.routes.backtest_api import router as backtest_router
   from src.api.routes.websocket_api import router as websocket_router
   ```

2. Update the FastAPI app constructor with comprehensive `openapi_tags` metadata:
   ```python
   openapi_tags = [
       {"name": "Health", "description": "Health check endpoints"},
       {"name": "Macro", "description": "Macroeconomic data series"},
       {"name": "Curves", "description": "Yield curve data"},
       {"name": "Market Data", "description": "Market prices and indicators"},
       {"name": "Flows", "description": "Capital flows and positioning"},
       {"name": "Agents", "description": "Analytical agent signals and reports"},
       {"name": "Signals", "description": "Trading signal aggregation"},
       {"name": "Risk", "description": "VaR, stress testing, and risk limits"},
       {"name": "Portfolio", "description": "Portfolio positions and optimization"},
       {"name": "Backtest", "description": "Strategy backtesting endpoints"},
       {"name": "Strategies", "description": "Strategy management and configuration"},
       {"name": "Reports", "description": "Daily reports and notifications"},
       {"name": "Monitoring", "description": "System monitoring and alerts"},
       {"name": "WebSocket", "description": "Real-time WebSocket channels"},
   ]
   ```
   Pass `openapi_tags=openapi_tags` to FastAPI constructor.

3. Include new routers (add after existing router includes):
   ```python
   app.include_router(backtest_router, prefix="/api/v1")
   app.include_router(websocket_router)  # No prefix — ws:// paths are at root
   ```

4. Ensure the `/static` mount (from Plan 19-01) is present. If not already added, add:
   ```python
   from pathlib import Path
   from fastapi.staticfiles import StaticFiles
   app.mount("/static", StaticFiles(directory=str(Path(__file__).resolve().parent / "static")), name="static")
   ```

5. Keep ALL existing router includes unchanged. The final router list should be:
   - health (root), macro (/api/v1), curves (/api/v1), market_data (/api/v1), flows (/api/v1)
   - agents (/api/v1), signals (/api/v1), strategies_api (/api/v1), portfolio_api (/api/v1), risk_api (/api/v1), reports (/api/v1)
   - monitoring_router (/api/v1), reports_api_router (/api/v1)
   - backtest_router (/api/v1), websocket_router (root)
   - dashboard.router (root)
   - /static mount
  </action>
  <verify>
Run: `cd /home/user/Macro_Trading && python -c "
from src.api.main import app
routes = []
for r in app.routes:
    path = getattr(r, 'path', getattr(r, 'path_regex', ''))
    routes.append(str(path))
print('Total routes:', len(routes))
# Check key routes exist
for key in ['/health', '/api/v1/backtest', '/api/v1/strategies', '/ws/signals', '/ws/portfolio', '/ws/alerts']:
    found = any(key in r for r in routes)
    print(f'{key}: {\"FOUND\" if found else \"MISSING\"}')
"`
  </verify>
  <done>
main.py updated with all 14+ routers mounted, 14 Swagger tag categories, backtest and WebSocket routers included. GET /docs shows organized API documentation with all endpoint categories. WebSocket routes at /ws/signals, /ws/portfolio, /ws/alerts accept connections.
  </done>
</task>

</tasks>

<verification>
1. POST /api/v1/backtest/run returns 202 with backtest results
2. GET /api/v1/backtest/results returns strategy results
3. POST /api/v1/backtest/portfolio returns portfolio-level results
4. GET /api/v1/backtest/comparison returns multi-strategy comparison
5. GET /api/v1/strategies/{id} returns full strategy detail
6. GET /api/v1/strategies/{id}/signal/latest returns current signal
7. GET /api/v1/strategies/{id}/signal/history returns 30-day history
8. PUT /api/v1/strategies/{id}/params accepts parameter updates
9. WebSocket connections succeed at /ws/signals, /ws/portfolio, /ws/alerts
10. /docs shows all 14 Swagger tag categories
</verification>

<success_criteria>
- All 4 backtest endpoints respond with 200/202 status codes
- All 4 strategy detail endpoints respond with 200 status codes
- ConnectionManager tracks connections per channel and supports broadcast
- main.py includes all routers with organized Swagger tags
- No existing endpoints are broken by the additions
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-v2-api-expansion-testing-verification/19-03-SUMMARY.md`
</output>
