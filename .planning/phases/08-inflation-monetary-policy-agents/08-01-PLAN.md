---
phase: 08-inflation-monetary-policy-agents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agents/features/__init__.py
  - src/agents/features/inflation_features.py
  - src/agents/inflation_agent.py
autonomous: true
requirements:
  - INFL-01
  - INFL-02
  - INFL-03

must_haves:
  truths:
    - "InflationFeatureEngine.compute(data, as_of_date) returns a dict with all 30+ BR keys and 15+ US keys"
    - "PhillipsCurveModel fits OLS on 120-month trailing window and returns an AgentSignal with direction LONG when predicted core > BCB target"
    - "IpcaBottomUpModel returns an AgentSignal by aggregating 9 component seasonal forecasts against IBGE weights"
  artifacts:
    - path: "src/agents/features/__init__.py"
      provides: "Package init re-exporting InflationFeatureEngine, MonetaryFeatureEngine"
    - path: "src/agents/features/inflation_features.py"
      provides: "InflationFeatureEngine class with compute() method"
      contains: "class InflationFeatureEngine"
    - path: "src/agents/inflation_agent.py"
      provides: "PhillipsCurveModel, IpcaBottomUpModel classes"
      contains: "class PhillipsCurveModel"
  key_links:
    - from: "src/agents/inflation_agent.py"
      to: "src/agents/features/inflation_features.py"
      via: "import and instantiation of InflationFeatureEngine"
      pattern: "InflationFeatureEngine"
    - from: "src/agents/inflation_agent.py"
      to: "src/agents/base.py"
      via: "class InflationAgent(BaseAgent)"
      pattern: "class InflationAgent.*BaseAgent"
    - from: "src/agents/features/inflation_features.py"
      to: "src/agents/data_loader.py"
      via: "PointInTimeDataLoader passed into compute()"
      pattern: "PointInTimeDataLoader"
---

<objective>
Build InflationFeatureEngine (30 BR + 15 US features), PhillipsCurveModel (OLS on 10Y rolling window), and IpcaBottomUpModel (9-component seasonal aggregation with IBGE weights).

Purpose: This is the data and econometric foundation for the InflationAgent. Feature engine and models must be complete before Plan 08-02 orchestrates them and adds the remaining sub-models.
Output: src/agents/features/inflation_features.py, src/agents/features/__init__.py, and src/agents/inflation_agent.py (partial — InflationAgent stub + two models).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-agent-framework-data-loader/07-01-SUMMARY.md
@.planning/phases/07-agent-framework-data-loader/07-02-SUMMARY.md
@src/agents/base.py
@src/agents/data_loader.py
@src/core/enums.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InflationFeatureEngine with 30 BR + 15 US features</name>
  <files>
    src/agents/features/__init__.py
    src/agents/features/inflation_features.py
  </files>
  <action>
Create `src/agents/features/` directory with `__init__.py` (empty, will be extended in 08-03 for MonetaryFeatureEngine).

Create `src/agents/features/inflation_features.py` implementing `InflationFeatureEngine`:

```python
class InflationFeatureEngine:
    """Compute inflation features from raw PIT data for BR and US."""

    def compute(self, data: dict, as_of_date: date) -> dict[str, Any]:
        """Return flat dict of all inflation features."""
```

The `compute()` method receives a `data` dict (keyed as described below) and returns a flat dict. All features are computed from pandas DataFrames with `.iloc[-1]` for the most recent scalar, or rolling windows for derived metrics. Use `np.nan` as default for any missing series — never raise.

**BR features (~30 keys):**

IPCA headline:
- `ipca_yoy`: IPCA headline YoY % (trailing 12M cumulative)
- `ipca_mom`: IPCA MoM % (latest monthly)

IPCA cores (from macro_series, series codes: BCB-433 IPCA smoothed, BCB-4466 trimmed mean, BCB-11427 ex-food-energy):
- `ipca_core_smoothed`: smoothed core YoY
- `ipca_core_trimmed_mean`: trimmed mean YoY
- `ipca_core_ex_food_energy`: ex-food-energy YoY

IPCA 9 components (BCB series for each, raw MoM levels — use series for services, food-at-home, etc.):
- `ipca_food_home_mom`, `ipca_food_away_mom`, `ipca_housing_mom`,
  `ipca_clothing_mom`, `ipca_health_mom`, `ipca_personal_care_mom`,
  `ipca_education_mom`, `ipca_transport_mom`, `ipca_communication_mom`

Sub-indices:
- `ipca_services_yoy`: services IPCA YoY
- `ipca_industrial_yoy`: industrial goods IPCA YoY

IPCA diffusion index:
- `ipca_diffusion`: % of items with positive change (0-100), from BCB series or computed from component signs if unavailable

Focus expectations (from macro_series FOCUS table / BCB series):
- `focus_ipca_12m`: Focus median 12M-ahead IPCA expectation
- `focus_ipca_eoy`: Focus end-of-year IPCA expectation

Activity / output gap:
- `ibc_br_level`: IBC-Br monthly activity index latest level (BCB series 24363)
- `ibc_br_trend`: HP-filtered trend of IBC-Br (lambda=1600 for monthly, use `statsmodels.tsa.filters.hp_filter.hpfilter`)
- `ibc_br_output_gap`: (ibc_br_level - ibc_br_trend) / ibc_br_trend * 100

FX passthrough (USDBRL, from market_data):
- `usdbrl_yoy`: USDBRL YoY % change
- `usdbrl_3m`: USDBRL 3M % change (FX passthrough proxy — 3M lag reflects ~1 quarter import price lag)

Commodity driver:
- `crb_yoy`: CRB commodity index YoY % change (from market_data)

**US features (~15 keys):**

CPI/PCE (from FRED via macro_series):
- `us_cpi_core_yoy`: CPI core YoY
- `us_pce_core_yoy`: PCE core YoY
- `us_pce_core_3m_saar`: PCE core 3M SAAR — annualize 3M compounded return: ((1 + r3/100)^4 - 1)*100

Breakevens (from FRED or market_data):
- `us_breakeven_5y`: 5Y breakeven inflation
- `us_breakeven_10y`: 10Y breakeven inflation

Michigan survey:
- `us_michigan_1y`: U Michigan 1-year inflation expectation
- `us_michigan_5y`: U Michigan 5-year inflation expectation

Supercore:
- `us_pce_supercore_yoy`: PCE services ex-housing YoY (proxy: use PCE services series minus shelter if supercore unavailable, else use directly)

PCE target gap:
- `us_pce_target_gap`: us_pce_core_yoy - 2.0 (Fed target)
- `us_pce_supercore_mom_3m`: 3M average MoM PCE supercore (momentum indicator)

**Data keys expected in `data` dict (from InflationAgent.load_data):**
```
data["ipca"]         # DataFrame with IPCA headline monthly
data["ipca_cores"]   # dict: {"smoothed": df, "trimmed": df, "ex_fe": df}
data["ipca_components"]  # dict of 9 component DataFrames
data["focus"]        # DataFrame with Focus expectations
data["ibc_br"]       # DataFrame with IBC-Br monthly
data["usdbrl"]       # DataFrame with USDBRL daily (from market_data)
data["crb"]          # DataFrame with CRB index (from market_data)
data["us_cpi"]       # DataFrame with US CPI series
data["us_pce"]       # DataFrame with US PCE series
data["us_breakevens"]  # DataFrame with breakeven series
data["us_michigan"]  # DataFrame with Michigan survey
data["us_pce_supercore"]  # DataFrame with PCE supercore (may be None)
data["ipca_services"]    # DataFrame with services sub-index
data["ipca_industrial"]  # DataFrame with industrial goods sub-index
data["ipca_diffusion"]   # DataFrame with diffusion index (may be None)
```

For each data key, guard with `if data.get(key) is not None and not data[key].empty` before computing. Return `np.nan` for missing features.

For IBC-Br HP filter: apply `hpfilter(series.dropna(), lamb=1600)` from statsmodels, return cycle and trend components.

Imports needed: `pandas`, `numpy`, `statsmodels.tsa.filters.hp_filter.hpfilter`, `datetime.date`, `typing.Any`.
  </action>
  <verify>
    Run: `python -c "from src.agents.features.inflation_features import InflationFeatureEngine; print('OK')"`
    Run: `python -c "from src.agents.features import InflationFeatureEngine; print('import OK')"`
    Run: `ruff check src/agents/features/`
  </verify>
  <done>
    InflationFeatureEngine importable from src.agents.features, ruff passes with no errors,
    compute() method exists and accepts (data: dict, as_of_date: date) -> dict.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create InflationAgent stub, PhillipsCurveModel, and IpcaBottomUpModel</name>
  <files>
    src/agents/inflation_agent.py
  </files>
  <action>
Create `src/agents/inflation_agent.py` with:

1. **InflationAgent class** — inherits BaseAgent, stubs out all 4 abstract methods (load_data, compute_features, run_models, generate_narrative). load_data and compute_features are fully implemented; run_models and generate_narrative will be completed in Plan 08-02.

```python
class InflationAgent(BaseAgent):
    AGENT_ID = "inflation_agent"
    AGENT_NAME = "Inflation Agent"

    def __init__(self, loader: PointInTimeDataLoader) -> None:
        super().__init__(self.AGENT_ID, self.AGENT_NAME)
        self.loader = loader
        self.feature_engine = InflationFeatureEngine()

    def load_data(self, as_of_date: date) -> dict:
        """Load all inflation-relevant series from PointInTimeDataLoader."""
        # Load each series using self.loader methods
        # Return dict with keys matching InflationFeatureEngine expectations
        ...

    def compute_features(self, data: dict) -> dict:
        return self.feature_engine.compute(data, ...)

    def run_models(self, features: dict) -> list[AgentSignal]:
        # Implemented in Plan 08-02; returns empty list stub now
        return []

    def generate_narrative(self, signals, features) -> str:
        return ""
```

**load_data implementation detail:** Use `self.loader.get_macro_series(series_code, as_of_date, lookback_days=1825)` (5 years = 1825 days) for macro series, `self.loader.get_market_data(instrument, as_of_date)` for USDBRL and CRB. Series codes and instrument names to use:
- IPCA headline: `"BCB-433"` (IPCA MoM, BCB SGS series 433) with lookback 1825 days
- IPCA core smoothed: `"BCB-4466"` (smoothed core), trimmed mean: `"BCB-11427"`, ex-food-energy: `"BCB-16122"`
- IPCA 9 components: `"BCB-1637"` (food-home), `"BCB-7170"` (food-away), `"BCB-1638"` (housing), `"BCB-1639"` (clothing), `"BCB-7485"` (health), `"BCB-1640"` (personal-care), `"BCB-1641"` (education), `"BCB-1642"` (transport), `"BCB-1643"` (communication)
- IPCA services: `"BCB-10841"`, industrial goods: `"BCB-10844"`, diffusion: `"BCB-21379"`
- Focus IPCA 12M ahead median: `"FOCUS-IPCA-12M"`, end-of-year: `"FOCUS-IPCA-EOY"`
- IBC-Br: `"BCB-24363"` with lookback 3650 days (10Y for HP filter and OLS)
- USDBRL: instrument `"USDBRL"` from market_data
- CRB: instrument `"CRB"` from market_data
- US CPI core: `"FRED-CPILFESL"`, PCE core: `"FRED-PCEPILFE"`, PCE supercore: `"FRED-PCESV"` (services, proxy)
- US breakevens: `"FRED-T5YIE"` (5Y), `"FRED-T10YIE"` (10Y)
- Michigan: `"FRED-MICH"` (1Y expectation), `"FRED-MICH5YR"` (5Y)

Each loader call is wrapped in try/except, returning None on failure (consistent with no-fail policy). Return dict matching InflationFeatureEngine data key expectations.

2. **PhillipsCurveModel** class:

```python
class PhillipsCurveModel:
    """Expectations-augmented OLS Phillips Curve.

    Fits: core_inflation = α + β1*expectations_12m + β2*output_gap
                         + β3*fx_passthrough + β4*commodity_change
    on a rolling 120-month window. Predicts 12M core inflation.
    """
    SIGNAL_ID = "INFLATION_BR_PHILLIPS"
    MIN_OBS = 36  # minimum obs to fit
    WINDOW = 120  # 10Y monthly
    TARGET = 3.0  # BCB inflation target %

    def run(self, features: dict, as_of_date: date) -> AgentSignal:
        """Fit OLS, predict, and generate signal vs BCB target."""
```

Implementation:
- Extract from features: build a DataFrame from available history. Use `features["_raw_ols_data"]` (a DataFrame with columns: core_yoy, expectations_12m, output_gap, usdbrl_yoy, crb_yoy — prepared as a sub-dict by compute_features).
- If insufficient data (< MIN_OBS rows), return NO_SIGNAL: `AgentSignal(signal_id=SIGNAL_ID, agent_id="inflation_agent", timestamp=datetime.utcnow(), as_of_date=as_of_date, direction=SignalDirection.NEUTRAL, strength=SignalStrength.NO_SIGNAL, confidence=0.0, value=0.0, horizon_days=252, metadata={"reason": "insufficient_data"})`
- Use trailing WINDOW rows. Fit via `statsmodels.api.OLS(endog, exog).fit()` where `exog = sm.add_constant(X[["expectations_12m", "output_gap", "usdbrl_yoy", "crb_yoy"]])`.
- Predict 12M ahead core: use latest feature values to predict.
- gap = predicted_core - TARGET
- If gap > 0.5pp → LONG (inflation above target, hawkish signal); gap < -0.5pp → SHORT; else NEUTRAL
- confidence = min(1.0, abs(gap) / 3.0)  — scales 0→1 over a 3pp deviation
- strength = classify_strength(confidence)
- value = predicted_core
- Include in metadata: r_squared, n_obs, coefficients dict, prediction.
- On any exception: log warning, return NO_SIGNAL.

3. **IpcaBottomUpModel** class:

```python
class IpcaBottomUpModel:
    """Component-level IPCA forecast using seasonal patterns + IBGE weights."""
    SIGNAL_ID = "INFLATION_BR_BOTTOMUP"
    TARGET = 3.0   # BCB target
    BAND = 1.5     # tolerance band

    IBGE_WEIGHTS = {
        "food_home": 0.21, "food_away": 0.11, "housing": 0.16,
        "clothing": 0.04, "health": 0.14, "personal_care": 0.09,
        "education": 0.06, "transport": 0.12, "communication": 0.05,
    }

    def run(self, features: dict, as_of_date: date) -> AgentSignal:
        """Aggregate 9-component seasonal forecast to 12M IPCA projection."""
```

Implementation:
- For each component key in IBGE_WEIGHTS, read the raw MoM series from `features["_raw_components"][component]` (a DataFrame prepared by compute_features, at least 60 months).
- Compute seasonal factor per calendar month: trailing 5-year average of MoM values for that calendar month. Implementation: `df.groupby(df.index.month)["value"].mean()` on the trailing 60-month slice.
- Project 12 monthly seasonal factors starting from current month → sum to get annual forecast per component.
- Aggregate: `forecast_12m = sum(seasonal_12m[c] * IBGE_WEIGHTS[c] for c in components)` (in % terms).
- If fewer than 3 components have data (< 3 non-NaN seasonal factors): return NO_SIGNAL.
- Signal direction: forecast_12m > TARGET + BAND → LONG, forecast_12m < TARGET - BAND → SHORT, else NEUTRAL.
- confidence: scales linearly: |forecast_12m - TARGET| / (BAND * 2), clamped to [0, 1].
- value = forecast_12m (annualized %).
- Include in metadata: per-component forecasts, seasonal_months used.
- On any exception: log warning, return NO_SIGNAL.

Note on `_raw_ols_data` and `_raw_components`: these are sub-dicts/DataFrames that `InflationAgent.compute_features()` must prepare and store in the features dict under these private keys, so models receive ready-to-use data. Update `compute_features()` to build these keys from loaded data.

Imports for the file: `from __future__ import annotations`, `import numpy as np`, `import pandas as pd`, `import statsmodels.api as sm`, `from statsmodels.tsa.filters.hp_filter import hpfilter`, `from src.agents.base import AgentSignal, BaseAgent, classify_strength`, `from src.agents.data_loader import PointInTimeDataLoader`, `from src.agents.features.inflation_features import InflationFeatureEngine`, `from src.core.enums import SignalDirection, SignalStrength`.

Run `ruff check --fix src/agents/inflation_agent.py` after writing.
  </action>
  <verify>
    Run: `python -c "from src.agents.inflation_agent import InflationAgent, PhillipsCurveModel, IpcaBottomUpModel; print('OK')"`
    Run: `python -c "from src.agents.inflation_agent import PhillipsCurveModel; m = PhillipsCurveModel(); print(m.SIGNAL_ID)"`
    Run: `ruff check src/agents/inflation_agent.py`
  </verify>
  <done>
    InflationAgent, PhillipsCurveModel, IpcaBottomUpModel all importable without error.
    PhillipsCurveModel.SIGNAL_ID == "INFLATION_BR_PHILLIPS".
    IpcaBottomUpModel.SIGNAL_ID == "INFLATION_BR_BOTTOMUP".
    ruff check passes.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.agents.features.inflation_features import InflationFeatureEngine; print(InflationFeatureEngine)"` — imports cleanly
2. `python -c "from src.agents.inflation_agent import InflationAgent, PhillipsCurveModel, IpcaBottomUpModel"` — imports cleanly
3. `ruff check src/agents/features/ src/agents/inflation_agent.py` — zero errors
4. `PhillipsCurveModel().run({"_raw_ols_data": pd.DataFrame()}, date.today())` returns NO_SIGNAL AgentSignal (insufficient data path)
</verification>

<success_criteria>
- InflationFeatureEngine.compute() signature is correct and all 45+ feature keys are defined (even if returning np.nan when data is absent)
- PhillipsCurveModel.run() returns LONG when predicted_core > 3.5%, SHORT when < 2.5%, NO_SIGNAL when data < 36 obs
- IpcaBottomUpModel.run() returns LONG when weighted 12M forecast > 4.5%, SHORT when < 1.5%
- All files pass ruff check with zero violations
- No import-time side effects (no DB connection at import)
</success_criteria>

<output>
After completion, create `.planning/phases/08-inflation-monetary-policy-agents/08-01-SUMMARY.md`
</output>
