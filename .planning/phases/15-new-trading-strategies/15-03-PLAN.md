---
phase: 15-new-trading-strategies
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/strategies/inf_02_ipca_surprise.py
  - src/strategies/inf_03_inflation_carry.py
  - src/strategies/cupom_02_onshore_offshore.py
  - tests/test_strategies/test_inf_cupom_new.py
autonomous: true
requirements: [INST-01, INST-02, CPST-01]

must_haves:
  truths:
    - "INF-02 generates StrategySignal trading NTN-Bs and breakevens around IPCA/IPCA-15 releases when model forecast diverges from Focus consensus"
    - "INF-03 generates StrategySignal for inflation carry: long/short breakeven (DI_PRE minus NTN_B_REAL) based on comparison with inflation target, current IPCA, and Focus expectations"
    - "CUPOM-02 generates StrategySignal trading the spread between onshore DDI futuro rate and offshore NDF-implied rate on z-score mean reversion"
    - "All 3 strategies return empty list when data is missing (no forward-fill, no degraded models)"
    - "All 3 strategies register via @StrategyRegistry.register with correct asset classes"
  artifacts:
    - path: "src/strategies/inf_02_ipca_surprise.py"
      provides: "INF-02 IPCA Surprise Trade strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/inf_03_inflation_carry.py"
      provides: "INF-03 Inflation Carry strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/cupom_02_onshore_offshore.py"
      provides: "CUPOM-02 Onshore-Offshore Spread strategy"
      contains: "@StrategyRegistry.register"
    - path: "tests/test_strategies/test_inf_cupom_new.py"
      provides: "Unit tests for INF-02, INF-03, CUPOM-02"
      min_lines: 80
  key_links:
    - from: "src/strategies/inf_02_ipca_surprise.py"
      to: "PointInTimeDataLoader"
      via: "get_macro_series for IPCA, get_focus_expectations for IPCA forecast"
      pattern: "self\\.data_loader\\.get_macro_series|get_focus_expectations"
    - from: "src/strategies/cupom_02_onshore_offshore.py"
      to: "PointInTimeDataLoader"
      via: "get_curve for DI_PRE, get_market_data for USDBRL"
      pattern: "self\\.data_loader\\.get_curve"
---

<objective>
Implement 3 strategies: INF-02 (IPCA Surprise Trade), INF-03 (Inflation Carry), and CUPOM-02 (Onshore-Offshore Spread). INF-02 trades around IPCA releases, INF-03 trades the breakeven as a carry strategy, and CUPOM-02 trades the onshore-offshore interest rate spread via z-score mean reversion.

Purpose: Add inflation event-driven trading and carry strategies to the existing INF_BR_01, plus a second cupom cambial strategy complementing CUPOM_01.

Output: 3 strategy files + 1 test file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-backtesting-engine-v2-strategy-framework/14-01-SUMMARY.md
@.planning/phases/15-new-trading-strategies/15-CONTEXT.md

# Key existing files:
@src/strategies/base.py
@src/strategies/registry.py
@src/strategies/inf_br_01_breakeven.py
@src/strategies/cupom_01_cip_basis.py
@src/agents/data_loader.py
@src/core/enums.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement INF-02 IPCA Surprise, INF-03 Inflation Carry, and CUPOM-02 Onshore-Offshore</name>
  <files>
    src/strategies/inf_02_ipca_surprise.py
    src/strategies/inf_03_inflation_carry.py
    src/strategies/cupom_02_onshore_offshore.py
  </files>
  <action>
Create 3 new strategy files following established patterns.

**INF-02: IPCA Surprise Trade** (`inf_02_ipca_surprise.py`):
- Register with `@StrategyRegistry.register("INF_02", asset_class=AssetClass.INFLATION_BR, instruments=["NTN_B_REAL", "DI_PRE"])`
- Trade NTN-Bs and breakevens around IPCA/IPCA-15 releases when model forecast diverges from Focus:
  1. **Model IPCA forecast**: Build a simple seasonal model:
     - Load IPCA monthly series via `data_loader.get_macro_series("BR_IPCA_MOM", as_of_date, lookback_days=1825)` (5 years).
     - Compute seasonal factor for current month: average of same-month readings over past 5 years.
     - Load current IPCA-15 (preview): `data_loader.get_latest_macro_value("BR_IPCA15_MOM", as_of_date)`. If IPCA-15 is available for current month, use it as model forecast (it's a leading indicator).
     - Model forecast = IPCA-15 value if available, else seasonal average.
  2. **Focus consensus**: `data_loader.get_focus_expectations("IPCA", as_of_date)`. Extract the latest Focus median IPCA forecast.
  3. **Divergence**: surprise_z = (model_forecast - focus_median) / historical_std_of_surprises
     - Build history of (actual - focus) surprises over 24+ months, compute std.
     - Z-score the current model_forecast - focus divergence.
  4. **IPCA release window**: Maintain IPCA release calendar (typically around the 10th of each month). Method `_near_ipca_release(as_of_date)` checks if within [-3, +2] business days of estimated release. If not near release, check if the z-score from the most recent IPCA surprise is still extreme (|z| > 1.5); if so, maintain signal for up to 14 days post-release.
- Direction: surprise_z > 0 (model expects higher than Focus) => upside inflation surprise expected => SHORT NTN-Bs (real rates rise) / SHORT breakevens. surprise_z < 0 => LONG NTN-Bs.
- Entry threshold: |surprise_z| >= 1.0
- Stop-loss: 1.5% (IPCA trades are bounded)
- Take-profit: 2.5%
- holding_period_days: 14

**INF-03: Inflation Carry** (`inf_03_inflation_carry.py`):
- Register with `@StrategyRegistry.register("INF_03", asset_class=AssetClass.INFLATION_BR, instruments=["DI_PRE", "NTN_B_REAL"])`
- Long/short breakeven (DI_PRE minus NTN_B_REAL) based on inflation outlook:
  1. Load DI PRE curve (nominal): `data_loader.get_curve("DI_PRE", as_of_date)`. Extract 2Y rate.
  2. Load NTN-B curve (real): `data_loader.get_curve("NTN_B_REAL", as_of_date)`. Extract 2Y rate.
  3. Compute breakeven_2y = DI_PRE_2Y - NTN_B_REAL_2Y.
  4. Compare breakeven to 3 benchmarks:
     a. BCB target: 3.0% (with ±1.5pp band). If breakeven > 4.5% (upper target+band), breakeven is too high.
     b. Current IPCA 12M: `get_latest_macro_value("BR_IPCA_12M", ...)`. If breakeven > current IPCA * 1.1, market pricing seems excessive.
     c. Focus IPCA expectation: `get_focus_expectations("IPCA", ...)`. If breakeven > Focus + 0.5pp, market is more pessimistic than consensus.
  5. Score: composite = average of 3 z-scores comparing breakeven to each benchmark over 252-day history.
- Direction: composite > 0 (breakeven too high vs fundamentals) => SHORT breakeven (receive NTN-B, pay DI_PRE). composite < 0 (breakeven too low) => LONG breakeven.
- Entry threshold: |composite_z| >= 1.0
- Stop-loss: 1.5%
- Take-profit: 2.0%
- holding_period_days: 21

**CUPOM-02: Onshore-Offshore Spread** (`cupom_02_onshore_offshore.py`):
- Register with `@StrategyRegistry.register("CUPOM_02", asset_class=AssetClass.CUPOM_CAMBIAL, instruments=["DDI", "NDF"])`
- Trade spread between onshore (DDI futuro) and offshore (NDF-implied rate):
  1. **Onshore rate**: DDI rate from DI curve. Load `data_loader.get_curve("DI_PRE", as_of_date)`, extract 3M (63d) and 6M (126d) rates. The DDI (cupom cambial) = DI_PRE adjusted for FX forward. Approximate: DDI ~= DI_PRE_rate - USDBRL_forward_premium.
  2. **Forward premium**: Load USDBRL spot from `data_loader.get_market_data("USDBRL", as_of_date)`. Load PTAX: `data_loader.get_latest_macro_value("BR_PTAX_SELL", as_of_date)` or use spot. Compute implied forward from DI vs US rates: fwd_premium = (DI_rate - US_rate) * tenor_fraction.
  3. **Offshore NDF-implied rate**: NDF_implied = US_rate + fwd_premium (from DI curve). In practice, the offshore NDF rate differs from onshore DDI due to convertibility premium.
  4. **Spread**: onshore_offshore_spread = DDI_implied - NDF_implied. Since we cannot directly observe NDF rates, use a proxy: the CIP basis (already computed in existing CIP basis work). Load the DI and UST curves, compute covered interest parity basis as proxy for the onshore-offshore spread.
  5. Actually, simplify: compute onshore_rate = DI_rate, offshore_implied = UST_rate + USDBRL_fwd_points. Spread = DI_rate - offshore_implied. Z-score this spread vs 252-day history using curve_history.
- Direction: spread z > 0 (onshore premium elevated) => expect mean reversion => SHORT spread (short onshore, long offshore proxy). spread z < 0 => LONG spread.
- Entry threshold: |z| >= 1.5 (this spread can be noisy)
- Stop-loss: 2%
- Take-profit: 3%
- holding_period_days: 21
  </action>
  <verify>
    python -c "
from src.strategies.inf_02_ipca_surprise import Inf02IpcaSurpriseStrategy
from src.strategies.inf_03_inflation_carry import Inf03InflationCarryStrategy
from src.strategies.cupom_02_onshore_offshore import Cupom02OnshoreOffshoreStrategy
from src.strategies.registry import StrategyRegistry
for s in ['INF_02', 'INF_03', 'CUPOM_02']:
    assert s in StrategyRegistry.list_all(), f'{s} not registered'
print('INF-02, INF-03, CUPOM-02 registered successfully')
"
  </verify>
  <done>INF-02, INF-03, CUPOM-02 strategy classes exist with generate_signals returning StrategySignal; INF-02 implements IPCA release window logic; INF-03 compares breakeven to 3 benchmarks; CUPOM-02 trades onshore-offshore spread</done>
</task>

<task type="auto">
  <name>Task 2: Tests for INF-02, INF-03, CUPOM-02 and update __init__.py</name>
  <files>
    tests/test_strategies/test_inf_cupom_new.py
    src/strategies/__init__.py
  </files>
  <action>
**Update `src/strategies/__init__.py`**:
- Import Inf02IpcaSurpriseStrategy, Inf03InflationCarryStrategy, Cupom02OnshoreOffshoreStrategy
- Add to ALL_STRATEGIES dict: "INF_02", "INF_03", "CUPOM_02"
- Add to __all__ list

**Tests** (`tests/test_strategies/test_inf_cupom_new.py`):
- Use mock PointInTimeDataLoader with MagicMock (established pattern)
- **INF-02 tests (4 tests)**:
  - Test registration in StrategyRegistry with AssetClass.INFLATION_BR
  - Test signal generation when model forecast diverges from Focus (z > 1.0)
  - Test IPCA-15 used as model forecast when available
  - Test empty list returned when IPCA data missing
- **INF-03 tests (4 tests)**:
  - Test registration
  - Test breakeven above target+band => composite > 0 => SHORT breakeven direction
  - Test breakeven below all benchmarks => LONG breakeven direction
  - Test missing curve data returns empty list
- **CUPOM-02 tests (4 tests)**:
  - Test registration with AssetClass.CUPOM_CAMBIAL
  - Test elevated onshore premium z-score produces signal
  - Test z-score mean reversion direction: positive z => SHORT spread
  - Test missing DI curve data returns empty list
- At least 12 tests total
  </action>
  <verify>
    python -m pytest tests/test_strategies/test_inf_cupom_new.py -v --tb=short 2>&1 | tail -20
  </verify>
  <done>INF-02, INF-03, CUPOM-02 imported in __init__.py, ALL_STRATEGIES updated, >=12 tests pass confirming signal generation, IPCA calendar logic, breakeven benchmarking, and spread z-score computation</done>
</task>

</tasks>

<verification>
1. `python -c "from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_all())"` shows INF_02, INF_03, CUPOM_02 alongside existing strategies
2. `python -c "from src.core.enums import AssetClass; from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_by_asset_class(AssetClass.INFLATION_BR))"` returns INF_BR_01 + INF_02 + INF_03
3. `python -c "from src.core.enums import AssetClass; from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_by_asset_class(AssetClass.CUPOM_CAMBIAL))"` returns CUPOM_01 + CUPOM_02
4. `python -m pytest tests/test_strategies/test_inf_cupom_new.py -v` — all tests pass
</verification>

<success_criteria>
- 3 new strategy files exist and are importable
- INF-02 implements IPCA release window detection and seasonal model forecast
- INF-03 compares breakeven to BCB target, current IPCA, and Focus expectations
- CUPOM-02 trades onshore-offshore spread with z-score mean reversion
- All strategies return empty on missing data
- All tests pass (>=12)
- __init__.py updated
</success_criteria>

<output>
After completion, create `.planning/phases/15-new-trading-strategies/15-03-SUMMARY.md`
</output>
