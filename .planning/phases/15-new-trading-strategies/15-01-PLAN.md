---
phase: 15-new-trading-strategies
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/strategies/fx_02_carry_momentum.py
  - src/strategies/fx_03_flow_tactical.py
  - src/strategies/fx_04_vol_surface_rv.py
  - src/strategies/fx_05_terms_of_trade.py
  - tests/test_strategies/test_fx_new.py
autonomous: true
requirements: [FXST-01, FXST-02, FXST-03, FXST-04]

must_haves:
  truths:
    - "StrategyRegistry.list_by_asset_class(AssetClass.FX) returns FX_BR_01 plus 4 new FX strategies (FX_02, FX_03, FX_04, FX_05)"
    - "FX-02 generates a StrategySignal combining Selic-FFR carry z-score with 3M USDBRL momentum z-score, with vol-adjusted sizing"
    - "FX-03 generates a StrategySignal from BCB FX flow (40%), CFTC positioning (35%), B3 foreign flow (25%) with contrarian logic at |z|>2"
    - "FX-04 generates a StrategySignal from USDBRL vol surface distortions (risk reversal, butterfly, term structure, implied-realized premium)"
    - "FX-05 generates a StrategySignal from commodity-weighted terms of trade index vs USDBRL misalignment"
    - "All 4 strategies return None/empty when required data is missing (no forward-fill, no degraded models)"
  artifacts:
    - path: "src/strategies/fx_02_carry_momentum.py"
      provides: "FX-02 Carry-Adjusted Momentum strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/fx_03_flow_tactical.py"
      provides: "FX-03 Flow-Based Tactical FX strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/fx_04_vol_surface_rv.py"
      provides: "FX-04 Vol Surface Relative Value strategy"
      contains: "@StrategyRegistry.register"
    - path: "src/strategies/fx_05_terms_of_trade.py"
      provides: "FX-05 Terms of Trade FX strategy"
      contains: "@StrategyRegistry.register"
    - path: "tests/test_strategies/test_fx_new.py"
      provides: "Unit tests for all 4 new FX strategies"
      min_lines: 100
  key_links:
    - from: "src/strategies/fx_02_carry_momentum.py"
      to: "StrategyRegistry"
      via: "@StrategyRegistry.register decorator"
      pattern: "@StrategyRegistry\\.register"
    - from: "src/strategies/fx_*.py"
      to: "PointInTimeDataLoader"
      via: "self.data_loader method calls"
      pattern: "self\\.data_loader\\."
---

<objective>
Implement 4 new FX trading strategies for USDBRL: FX-02 (Carry-Adjusted Momentum), FX-03 (Flow-Based Tactical), FX-04 (Vol Surface Relative Value), and FX-05 (Terms of Trade Misalignment). Each strategy registers via @StrategyRegistry.register, produces StrategySignal with z_score/entry_level/stop_loss/take_profit, and uses real data from PointInTimeDataLoader.

Purpose: Expand FX coverage from 1 existing strategy (FX_BR_01) to 5 strategies, providing diversified signal sources for USDBRL positioning across carry, flow, vol, and fundamental dimensions.

Output: 4 strategy files + 1 test file covering all FX strategies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-backtesting-engine-v2-strategy-framework/14-01-SUMMARY.md

# Key existing files to reference for patterns:
@src/strategies/base.py
@src/strategies/registry.py
@src/strategies/fx_br_01_carry_fundamental.py
@src/strategies/__init__.py
@src/agents/data_loader.py
@src/core/enums.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement FX-02 Carry-Adjusted Momentum and FX-03 Flow-Based Tactical strategies</name>
  <files>
    src/strategies/fx_02_carry_momentum.py
    src/strategies/fx_03_flow_tactical.py
  </files>
  <action>
Create two new FX strategy files following the established pattern from fx_br_01_carry_fundamental.py.

**FX-02: Carry-Adjusted Momentum** (`fx_02_carry_momentum.py`):
- Register with `@StrategyRegistry.register("FX_02", asset_class=AssetClass.FX, instruments=["USDBRL"])`
- Strategy combines two components:
  1. **Carry z-score (50%)**: Compute Selic - FFR spread using `data_loader.get_latest_macro_value("BR_SELIC_TARGET", ...)` and `data_loader.get_latest_macro_value("US_FED_FUNDS", ...)`. Build history of spreads over 252-day lookback, compute z-score of current spread vs history using `self.compute_z_score()`.
  2. **Momentum z-score (50%)**: Load USDBRL 3M (63-day) returns via `data_loader.get_market_data("USDBRL", ...)` with 504-day lookback. Compute 63-day log return, build rolling 63-day return history, compute z-score.
- Composite z-score = 0.50 * carry_z + 0.50 * momentum_z
- Vol-adjusted sizing: multiply suggested_size by `min(1.0, target_vol / realized_vol)` where target_vol=0.15 and realized_vol is 21-day USDBRL annualized vol
- Direction: composite > 0 => SHORT USDBRL (BRL strength via carry advantage + momentum), composite < 0 => LONG USDBRL
- Entry threshold: |composite_z| >= 0.75; no signal below this
- Stop-loss: vol-based, entry_level +/- 2.5 * daily_vol * sqrt(holding_period)
- Take-profit: entry_level +/- 1.5 * abs(entry - stop)
- holding_period_days: 21 (medium-term)
- Return `StrategySignal` with all fields populated. Return empty list if any data is missing.
- Define module-level `FX_02_CONFIG = StrategyConfig(...)` with asset_class=AssetClass.FX

**FX-03: Flow-Based Tactical FX** (`fx_03_flow_tactical.py`):
- Register with `@StrategyRegistry.register("FX_03", asset_class=AssetClass.FX, instruments=["USDBRL"])`
- Three flow components with contrarian logic:
  1. **BCB FX flow (40%)**: `data_loader.get_flow_data("BR_FX_FLOW_NET", ...)` with 365-day lookback. Compute 21-day rolling sum, z-score vs 252-day history.
  2. **CFTC BRL positioning (35%)**: `data_loader.get_flow_data("CFTC_6L_LEVERAGED_NET", ...)`. Compute z-score of latest net position vs 104-week (2-year) history.
  3. **B3 foreign equity flow (25%)**: `data_loader.get_flow_data("BR_FX_FLOW_FINANCIAL", ...)` as proxy. 21-day rolling sum, z-score.
- Composite = 0.40 * bcb_z + 0.35 * cftc_z + 0.25 * b3_z
- **Contrarian logic**: When |composite_z| > 2.0, invert the signal direction (extreme positioning = likely reversal). When |composite_z| <= 2.0, follow the flow direction.
- Direction: For non-contrarian (|z| <= 2): positive composite => SHORT USDBRL (inflows = BRL strength). For contrarian (|z| > 2): flip direction.
- Entry threshold: |composite_z| >= 1.0
- Stop-loss: fixed 3% from entry
- Take-profit: fixed 5% from entry
- holding_period_days: 14
- Return `StrategySignal`. Return empty list if any required flow component is missing (per decision: skip entirely on missing data).
  </action>
  <verify>
    python -c "
from src.strategies.fx_02_carry_momentum import Fx02CarryMomentumStrategy
from src.strategies.fx_03_flow_tactical import Fx03FlowTacticalStrategy
from src.strategies.registry import StrategyRegistry
assert 'FX_02' in StrategyRegistry.list_all()
assert 'FX_03' in StrategyRegistry.list_all()
print('FX-02 and FX-03 registered successfully')
"
  </verify>
  <done>FX-02 and FX-03 strategy classes exist, register via decorator, and have generate_signals methods returning StrategySignal with z_score, entry_level, stop_loss, take_profit populated</done>
</task>

<task type="auto">
  <name>Task 2: Implement FX-04 Vol Surface RV, FX-05 Terms of Trade, tests, and update __init__.py</name>
  <files>
    src/strategies/fx_04_vol_surface_rv.py
    src/strategies/fx_05_terms_of_trade.py
    src/strategies/__init__.py
    tests/test_strategies/test_fx_new.py
  </files>
  <action>
**FX-04: Vol Surface Relative Value** (`fx_04_vol_surface_rv.py`):
- Register with `@StrategyRegistry.register("FX_04", asset_class=AssetClass.FX, instruments=["USDBRL"])`
- Analyze USDBRL vol surface through 4 components (all computed from available data):
  1. **Implied-Realized Premium (40%)**: Load USDBRL market data for realized vol (21-day). Estimate implied vol proxy from USDBRL options-like behavior: use the absolute daily return z-score scaled by sqrt(252) as implied vol proxy. Alternatively, if series "BR_USDBRL_IV_1M" or similar exists in macro_series, use it directly. Compute premium = implied - realized, z-score vs 252-day history. Positive z = vol is expensive (sell vol / SHORT USDBRL puts = expect BRL stability).
  2. **Term Structure Slope (25%)**: Compare short-term (21-day) realized vol to longer-term (63-day) realized vol. Inverted term structure (short > long) signals stress. Z-score the ratio short_vol/long_vol vs history.
  3. **Skew Proxy (20%)**: Compute skewness of daily USDBRL returns over 63 days. Positive skew = tail risk to USDBRL upside (BRL weakness). Z-score vs 504-day history.
  4. **Kurtosis Signal (15%)**: Compute excess kurtosis of 63-day returns. High kurtosis = fat tails = vol expansion expected. Z-score vs history.
- Composite = weighted sum of 4 z-scores
- Direction: composite > 0 => LONG USDBRL (vol surface signals BRL stress), composite < 0 => SHORT USDBRL (vol surface cheap)
- Entry threshold: |composite_z| >= 1.0
- Stop-loss: vol-based, 2.0 * 21-day daily vol * sqrt(14)
- Take-profit: 1.5 * stop distance
- holding_period_days: 14
- Uses `scipy.stats.skew` and `scipy.stats.kurtosis` for moments calculation

**FX-05: Terms of Trade FX** (`fx_05_terms_of_trade.py`):
- Register with `@StrategyRegistry.register("FX_05", asset_class=AssetClass.FX, instruments=["USDBRL"])`
- Build commodity-weighted terms of trade index for Brazil:
  - Load commodity prices via `data_loader.get_market_data()` for: "SOYBEAN" (or "ZS=F"), "IRON_ORE" (or "TIO=F"/"VALE"), "BRENT" (or "BZ=F"), "SUGAR" (or "SB=F"), "COFFEE" (or "KC=F"). Use Yahoo tickers already configured in the system.
  - Weights: soybean 30%, iron ore 25%, oil 20%, sugar 15%, coffee 10% (reflecting Brazil export composition)
  - Compute 63-day log return for each commodity, weighted sum = ToT change
  - Build 504-day history of ToT changes
  - Z-score current ToT change vs history
- Compare ToT z-score to USDBRL 63-day return z-score. Misalignment = ToT_z - USDBRL_return_z
- If misalignment > 0: ToT improving faster than BRL appreciating => SHORT USDBRL (expect BRL catch-up)
- If misalignment < 0: ToT deteriorating faster than BRL depreciating => LONG USDBRL
- Entry threshold: |misalignment_z| >= 1.0
- Stop-loss: 4% fixed (terms of trade moves are slower)
- Take-profit: 6% fixed
- holding_period_days: 28 (slow-moving fundamental)

**Update `src/strategies/__init__.py`**:
- Import all 4 new strategy classes
- Add them to ALL_STRATEGIES dict with keys "FX_02", "FX_03", "FX_04", "FX_05"
- Add to __all__ list

**Tests** (`tests/test_strategies/test_fx_new.py`):
- Use mock PointInTimeDataLoader with MagicMock (pattern from existing strategy tests)
- For each strategy (FX-02 through FX-05):
  - Test that strategy is registered in StrategyRegistry
  - Test generate_signals returns StrategySignal with correct fields when data is provided
  - Test generate_signals returns empty list when data is missing
  - Test contrarian logic for FX-03 (extreme |z| > 2 inverts direction)
  - Test vol-adjusted sizing for FX-02
  - Test misalignment direction for FX-05
- At least 16 tests total (4 per strategy)
  </action>
  <verify>
    python -c "
from src.strategies.registry import StrategyRegistry
from src.core.enums import AssetClass
fx = StrategyRegistry.list_by_asset_class(AssetClass.FX)
assert 'FX_02' in fx and 'FX_03' in fx and 'FX_04' in fx and 'FX_05' in fx
print(f'FX strategies registered: {fx}')
" && python -m pytest tests/test_strategies/test_fx_new.py -v --tb=short 2>&1 | tail -20
  </verify>
  <done>All 4 FX strategies (FX-02 through FX-05) registered in StrategyRegistry, imported in __init__.py, listed in ALL_STRATEGIES, and all tests pass confirming signal generation with correct z_score, entry_level, stop_loss, take_profit fields</done>
</task>

</tasks>

<verification>
1. `python -c "from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_all())"` shows FX_02, FX_03, FX_04, FX_05 alongside existing 8 strategies (12 total)
2. `python -c "from src.core.enums import AssetClass; from src.strategies.registry import StrategyRegistry; print(StrategyRegistry.list_by_asset_class(AssetClass.FX))"` returns 5 FX strategies
3. `python -m pytest tests/test_strategies/test_fx_new.py -v` â€” all tests pass
4. Each strategy file contains `@StrategyRegistry.register(...)` decorator and `StrategySignal` output
</verification>

<success_criteria>
- 4 new FX strategy files exist and are importable
- All 4 register via @StrategyRegistry.register with AssetClass.FX
- Each strategy produces StrategySignal with z_score, entry_level, stop_loss, take_profit populated
- Each strategy returns empty list when data is missing (no forward-fill)
- FX-03 implements contrarian logic at |z| > 2
- FX-02 implements vol-adjusted sizing
- FX-05 uses commodity-weighted ToT index
- All tests pass (>=16 tests)
- __init__.py updated with imports and ALL_STRATEGIES entries
</success_criteria>

<output>
After completion, create `.planning/phases/15-new-trading-strategies/15-01-SUMMARY.md`
</output>
