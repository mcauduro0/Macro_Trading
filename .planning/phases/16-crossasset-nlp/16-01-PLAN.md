---
phase: 16-crossasset-nlp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agents/cross_asset_view.py
  - src/agents/hmm_regime.py
  - src/agents/consistency_checker.py
  - src/agents/cross_asset_agent.py
  - src/narrative/generator.py
  - tests/test_cross_asset_view.py
  - tests/test_hmm_regime.py
  - tests/test_consistency_checker.py
autonomous: true
requirements:
  - CRSV-01
  - CRSV-02
  - CRSV-03
  - CRSV-04

must_haves:
  truths:
    - "CrossAssetAgent.run() produces a CrossAssetView with regime, regime_probabilities, per-asset-class views, risk_appetite, tail_risk, key_trades, narrative, and risk_warnings"
    - "HMM regime classifier outputs 4 regime probabilities summing to 1.0 and falls back to rule-based when hmmlearn is unavailable or fails to converge"
    - "Consistency checker flags contradictions between agent/strategy signals and applies 0.5x sizing penalty on affected instruments"
    - "LLM generates structured 3-5 sentence regime narrative with template fallback"
  artifacts:
    - path: "src/agents/cross_asset_view.py"
      provides: "CrossAssetView frozen dataclass and CrossAssetViewBuilder"
      contains: "CrossAssetView"
    - path: "src/agents/hmm_regime.py"
      provides: "HMMRegimeClassifier with rule-based fallback"
      contains: "HMMRegimeClassifier"
    - path: "src/agents/consistency_checker.py"
      provides: "CrossAssetConsistencyChecker with dict-based rules"
      contains: "CrossAssetConsistencyChecker"
    - path: "tests/test_cross_asset_view.py"
      provides: "Unit tests for CrossAssetView, HMM, consistency checker"
  key_links:
    - from: "src/agents/cross_asset_agent.py"
      to: "src/agents/cross_asset_view.py"
      via: "CrossAssetViewBuilder.build() called in run_models()"
      pattern: "CrossAssetViewBuilder"
    - from: "src/agents/cross_asset_agent.py"
      to: "src/agents/hmm_regime.py"
      via: "HMMRegimeClassifier.classify() replaces inline regime logic"
      pattern: "HMMRegimeClassifier"
    - from: "src/agents/cross_asset_agent.py"
      to: "src/agents/consistency_checker.py"
      via: "ConsistencyChecker.check() called after signal generation"
      pattern: "CrossAssetConsistencyChecker"
---

<objective>
Build the enhanced CrossAssetAgent v2 with CrossAssetView dataclass, HMM-based regime classification (with rule-based fallback), cross-asset consistency checking, and LLM-powered narrative generation.

Purpose: The CrossAssetAgent is the central regime and risk context provider for all strategies. Enhancing it with HMM probabilities (not just point estimates), consistency checking, and structured narrative makes the system more robust and informative.

Output: CrossAssetView frozen dataclass, HMMRegimeClassifier, CrossAssetConsistencyChecker, enhanced CrossAssetAgent producing CrossAssetView, LLM narrative generation for cross-asset section, comprehensive unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-crossasset-nlp/16-CONTEXT.md
@src/agents/cross_asset_agent.py
@src/agents/features/cross_asset_features.py
@src/strategies/cross_01_regime_allocation.py
@src/strategies/cross_02_risk_appetite.py
@src/narrative/generator.py
@src/narrative/templates.py
@src/agents/base.py
@src/core/enums.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CrossAssetView dataclass, HMM regime classifier, consistency checker</name>
  <files>
    src/agents/cross_asset_view.py
    src/agents/hmm_regime.py
    src/agents/consistency_checker.py
  </files>
  <action>
**1. Create `src/agents/cross_asset_view.py`** -- CrossAssetView frozen dataclass + builder pattern (per locked decision: frozen dataclass + builder).

CrossAssetView fields (CRSV-01):
- `regime`: str -- one of "Goldilocks", "Reflation", "Stagflation", "Deflation"
- `regime_probabilities`: dict[str, float] -- {regime_name: probability}, sums to 1.0
- `asset_class_views`: dict[str, AssetClassView] -- per-asset-class directional view
- `risk_appetite`: float -- 0 to 100 composite score
- `tail_risk`: TailRiskAssessment -- dataclass with `composite_score` (0-100), `regime_transition_prob` (float), `market_indicators` (dict), `assessment` (str: "low"/"moderate"/"elevated"/"critical")
- `key_trades`: list[KeyTrade] -- top-3 by conviction, each with `instrument`, `direction`, `conviction`, `rationale`
- `narrative`: str -- 3-5 sentence regime narrative
- `risk_warnings`: list[str] -- human-readable warnings
- `consistency_issues`: list[ConsistencyIssue] -- flagged contradictions
- `as_of_date`: date
- `generated_at`: datetime

Supporting dataclasses (all frozen):
- `AssetClassView(asset_class, direction, conviction, key_driver, instruments)`
- `TailRiskAssessment(composite_score, regime_transition_prob, market_indicators, assessment)`
- `KeyTrade(instrument, direction, conviction, rationale, strategy_id)`
- `ConsistencyIssue(rule_id, description, affected_instruments, severity, sizing_penalty)`

CrossAssetViewBuilder class:
- Methods: `set_regime()`, `set_regime_probabilities()`, `add_asset_class_view()`, `set_risk_appetite()`, `set_tail_risk()`, `add_key_trade()`, `set_narrative()`, `add_risk_warning()`, `add_consistency_issue()`, `set_as_of_date()`
- `.build()` -> frozen CrossAssetView (validates regime_probabilities sum to ~1.0)

**2. Create `src/agents/hmm_regime.py`** -- HMM regime classifier (CRSV-02).

Per locked decisions:
- 6 features: growth_z, inflation_z, VIX_z, credit_spread_z, FX_vol_z, equity_momentum_z
- Expanding training window (all data from 2010 to as_of_date)
- Outputs full probability vector (not just point estimate)
- Falls back to rule-based + risk_warning when HMM fails

HMMRegimeClassifier class:
- `__init__(self, n_regimes=4)` -- try import hmmlearn.hmm.GaussianHMM; set `_hmm_available` flag
- `classify(self, feature_history: pd.DataFrame, as_of_date: date) -> HMMResult`:
  - `feature_history` has columns: growth_z, inflation_z, VIX_z, credit_spread_z, FX_vol_z, equity_momentum_z
  - If hmmlearn available AND enough data (>= 60 observations):
    - Fit GaussianHMM(n_components=4, covariance_type="full", n_iter=100, random_state=42)
    - predict_proba on last observation -> regime_probabilities
    - Map HMM states to regime names by examining state means (highest growth_z mean = Goldilocks, etc.)
    - Return HMMResult(regime, probabilities, method="hmm", converged=True)
  - On any failure (import error, convergence, insufficient data):
    - Use rule-based fallback from CROSS_01 logic (growth_z, inflation_z thresholds)
    - Return HMMResult with method="rule_based", converged=False, and a warning string

HMMResult dataclass:
- `regime`: str
- `regime_probabilities`: dict[str, float]
- `method`: str ("hmm" or "rule_based")
- `converged`: bool
- `warning`: str | None

Rule-based fallback (reuse CROSS_01 logic):
- Goldilocks: growth_z > 0 AND inflation_z < 0.5
- Reflation: growth_z > 0 AND inflation_z >= 0.5
- Stagflation: growth_z < 0 AND inflation_z >= 0.5
- Deflation: growth_z < 0 AND inflation_z < -0.5
- Default: nearest regime
- Probabilities: assign 0.7 to classified regime, 0.1 to each other

**3. Create `src/agents/consistency_checker.py`** -- Cross-asset consistency checker (CRSV-03).

Per locked decisions:
- Check BOTH agent signals AND strategy signals
- Extensible dict-based rules
- Warning + 0.5x sizing penalty on affected instruments

CrossAssetConsistencyChecker class:
- `RULES`: list of dicts, each with:
  - `rule_id`: str (e.g., "FX_RATES_CONTRADICTION")
  - `description`: str
  - `check_fn`: callable(signals_dict) -> ConsistencyIssue | None
  - `affected_instruments`: list[str]
  - `severity`: str ("warning" or "critical")

Implement 7 rules:
1. **FX_RATES_CONTRADICTION**: FX bullish BRL (SHORT USDBRL) + rates higher (SHORT DI) = inconsistent
2. **EQUITY_RATES_CONTRADICTION**: LONG equities + SHORT DI aggressively = inconsistent (risk-on + hawkish)
3. **REGIME_FX_MISMATCH**: Stagflation regime + SHORT USDBRL = inconsistent
4. **REGIME_EQUITY_MISMATCH**: Stagflation/Deflation regime + LONG equities = inconsistent
5. **INFLATION_RATES_CONTRADICTION**: High inflation signal + LONG DI (receive) = inconsistent
6. **RISK_APPETITE_DIRECTION**: Risk appetite < 30 (fear) + LONG risk assets = inconsistent
7. **SOVEREIGN_FX_DIVERGENCE**: Positive sovereign risk + SHORT USDBRL = inconsistent

- `check(self, agent_signals, strategy_signals, regime) -> list[ConsistencyIssue]`
  - Iterate over RULES, call check_fn, collect issues
  - Each ConsistencyIssue has sizing_penalty=0.5 per locked decision
  </action>
  <verify>
    Run: `python -c "from src.agents.cross_asset_view import CrossAssetView, CrossAssetViewBuilder; b = CrossAssetViewBuilder(); b.set_regime('Goldilocks'); b.set_regime_probabilities({'Goldilocks': 0.7, 'Reflation': 0.1, 'Stagflation': 0.1, 'Deflation': 0.1}); b.set_as_of_date(__import__('datetime').date.today()); v = b.build(); print(v.regime, sum(v.regime_probabilities.values()))"`
    Run: `python -c "from src.agents.hmm_regime import HMMRegimeClassifier, HMMResult; c = HMMRegimeClassifier(); print(c._hmm_available)"`
    Run: `python -c "from src.agents.consistency_checker import CrossAssetConsistencyChecker; c = CrossAssetConsistencyChecker(); print(len(c.RULES))"`
  </verify>
  <done>
    CrossAssetView frozen dataclass with all required fields, CrossAssetViewBuilder with .build(), HMMRegimeClassifier with classify() method and rule-based fallback, CrossAssetConsistencyChecker with 7 dict-based rules and 0.5x sizing penalty. All three modules import cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate into CrossAssetAgent, add LLM narrative, write tests</name>
  <files>
    src/agents/cross_asset_agent.py
    src/narrative/generator.py
    tests/test_cross_asset_view.py
    tests/test_hmm_regime.py
    tests/test_consistency_checker.py
  </files>
  <action>
**1. Enhance `src/agents/cross_asset_agent.py`:**

Add new imports: CrossAssetView, CrossAssetViewBuilder, HMMRegimeClassifier, CrossAssetConsistencyChecker.

Add to `__init__`:
- `self.hmm_classifier = HMMRegimeClassifier()`
- `self.consistency_checker = CrossAssetConsistencyChecker()`

Modify `load_data()`:
- Add growth_z and inflation_z series loading (BR_GDP_GROWTH_YOY/BR_IBC_BR_YOY for growth, BR_IPCA_12M for inflation) -- needed for HMM features
- Add equity momentum series (IBOVESPA 63-day returns)
- These feed the 6 HMM feature columns

Add new method `build_cross_asset_view(self, signals, features) -> CrossAssetView`:
- Use CrossAssetViewBuilder:
  - Build 6-column feature DataFrame from features dict (growth_z, inflation_z, VIX_z, credit_spread_z, FX_vol_z, equity_momentum_z)
  - Call self.hmm_classifier.classify(feature_df, as_of_date) -> HMMResult
  - set_regime(hmm_result.regime)
  - set_regime_probabilities(hmm_result.regime_probabilities)
  - If hmm_result.warning: add_risk_warning(hmm_result.warning)
  - Build per-asset-class views from agent signals (FX, rates, equities, inflation, sovereign)
  - set_risk_appetite from RiskSentimentIndex signal value
  - Compute tail_risk: market composite (VIX, credit, correlation breaks from features) + regime_transition_prob (sum of Stagflation + Deflation probabilities from HMM)
  - key_trades: sort all strategy signals by confidence descending, take top 3
  - Generate narrative via LLM or template (see below)
  - Run consistency_checker.check(agent_signals, strategy_signals, regime)
  - Add issues to builder
  - .build() -> CrossAssetView

Modify `run_models()`:
- After producing 3 signals, call build_cross_asset_view()
- Store view in self._last_view for access by other components
- Return signals (unchanged) -- CrossAssetView is an additional output

Modify `generate_narrative()`:
- Use the CrossAssetView narrative field if available

**2. Add cross-asset narrative section to `src/narrative/generator.py`** (CRSV-04):

Per locked decision: Both short 3-5 sentence narrative in CrossAssetAgent + full section in NarrativeGenerator.

Add method `generate_cross_asset_narrative(self, view: CrossAssetView) -> str`:
- If has API key: use structured prompt asking for 3-5 sentences explaining:
  - Current regime and confidence
  - Key drivers (from regime_probabilities)
  - Trade rationale (from key_trades)
  - Risk warnings if any
- JSON output format requested from LLM
- Template fallback: build ASCII summary from CrossAssetView fields

Update `_build_prompt_data` to include CrossAssetView data when available (regime, risk_appetite, tail_risk, key_trades).

**3. Create `tests/test_cross_asset_view.py`:**
- Test CrossAssetViewBuilder builds frozen dataclass correctly
- Test regime_probabilities validation (sums to ~1.0)
- Test builder raises on missing required fields
- Test AssetClassView, TailRiskAssessment, KeyTrade, ConsistencyIssue creation

**4. Create `tests/test_hmm_regime.py`:**
- Test rule-based fallback produces correct regimes for all 4 quadrants
- Test rule-based assigns 0.7 probability to classified regime
- Test that classify() works with minimal DataFrame (rule-based path)
- Test that classify() handles empty DataFrame gracefully
- If hmmlearn available, test HMM path with synthetic data

**5. Create `tests/test_consistency_checker.py`:**
- Test each of 7 rules fires on its contradiction condition
- Test no false positives when signals are consistent
- Test sizing_penalty is 0.5 on all issues
- Test check() returns empty list when no contradictions
  </action>
  <verify>
    Run: `python -m pytest tests/test_cross_asset_view.py tests/test_hmm_regime.py tests/test_consistency_checker.py -v`
    Expected: All tests pass.
    Run: `python -c "from src.agents.cross_asset_agent import CrossAssetAgent; print('CrossAssetAgent v2 loads OK')"`
  </verify>
  <done>
    CrossAssetAgent.run() produces both AgentSignals AND a CrossAssetView. HMM classifier tested with rule-based fallback. Consistency checker flags contradictions with 0.5x penalty. NarrativeGenerator has cross-asset section support. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.agents.cross_asset_view import CrossAssetView, CrossAssetViewBuilder"` -- imports OK
2. `python -c "from src.agents.hmm_regime import HMMRegimeClassifier"` -- imports OK
3. `python -c "from src.agents.consistency_checker import CrossAssetConsistencyChecker"` -- imports OK
4. `python -c "from src.agents.cross_asset_agent import CrossAssetAgent"` -- imports OK (enhanced agent)
5. `python -m pytest tests/test_cross_asset_view.py tests/test_hmm_regime.py tests/test_consistency_checker.py -v` -- all pass
6. `python -m pytest tests/ -x --timeout=120` -- existing tests still pass (no regressions)
</verification>

<success_criteria>
- CrossAssetView frozen dataclass with all CRSV-01 fields (regime, regime_probabilities, asset_class_views, risk_appetite, tail_risk, key_trades, narrative, risk_warnings)
- HMM regime classifier outputs probability vector with rule-based fallback (CRSV-02)
- 7 consistency rules flag contradictions with 0.5x sizing penalty (CRSV-03)
- LLM narrative generation with template fallback for CrossAssetView (CRSV-04)
- All new and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-crossasset-nlp/16-01-SUMMARY.md`
</output>
