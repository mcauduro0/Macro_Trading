---
phase: 02-connectors
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/connectors/yahoo_finance.py
  - src/connectors/bcb_ptax.py
  - src/connectors/__init__.py
  - tests/connectors/test_yahoo_finance.py
  - tests/connectors/test_bcb_ptax.py
autonomous: true
requirements:
  - CONN-10
  - CONN-11
  - DATA-01
  - DATA-03

must_haves:
  truths:
    - "Yahoo Finance connector fetches daily OHLCV for 25+ tickers (FX, indices, commodities, ETFs) via yfinance"
    - "Yahoo Finance connector wraps synchronous yfinance calls with asyncio.to_thread to avoid blocking the event loop"
    - "Yahoo Finance connector adds random delays between batches to avoid rate limiting"
    - "Yahoo Finance TICKERS dict contains all 25+ tickers from the Fase0 guide"
    - "BCB PTAX connector fetches official FX fixing rates with MM-DD-YYYY date format in API params"
    - "BCB PTAX connector filters for closing bulletin (tipoBoletim='Fechamento') as the official PTAX rate"
    - "BCB PTAX connector uses dataHoraCotacao as release_time with Sao Paulo timezone"
    - "Both connectors use ON CONFLICT DO NOTHING and can be re-run without duplicates"
    - "Tests verify date formatting, OHLCV parsing, and closing bulletin filtering"
  artifacts:
    - path: "src/connectors/yahoo_finance.py"
      provides: "YahooFinanceConnector with 25+ ticker definitions for FX, indices, commodities, ETFs"
      min_lines: 120
    - path: "src/connectors/bcb_ptax.py"
      provides: "BcbPtaxConnector for official FX fixing rates from PTAX OData API"
      min_lines: 80
    - path: "tests/connectors/test_yahoo_finance.py"
      provides: "Tests for Yahoo Finance connector"
      min_lines: 40
    - path: "tests/connectors/test_bcb_ptax.py"
      provides: "Tests for BCB PTAX connector with respx HTTP mocking"
      min_lines: 40
  key_links:
    - from: "src/connectors/yahoo_finance.py"
      to: "yfinance"
      via: "yf.download() wrapped in asyncio.to_thread()"
      pattern: "asyncio\\.to_thread"
    - from: "src/connectors/yahoo_finance.py"
      to: "src/core/models/market_data.py"
      via: "_bulk_insert(MarketData, records, 'uq_market_data_natural_key')"
      pattern: "MarketData.*uq_market_data_natural_key"
    - from: "src/connectors/bcb_ptax.py"
      to: "src/connectors/base.py"
      via: "BcbPtaxConnector(BaseConnector) inheritance"
      pattern: "class BcbPtaxConnector\\(BaseConnector\\)"
    - from: "src/connectors/bcb_ptax.py"
      to: "src/core/models/market_data.py"
      via: "Stores PTAX buy/sell rates in market_data table"
      pattern: "MarketData"
---

<objective>
Yahoo Finance and BCB PTAX market data connectors with tests.

Purpose: Implement the two market data connectors that write to the market_data table. Yahoo Finance provides daily OHLCV for 25+ tickers across FX, indices, commodities, and ETFs. BCB PTAX provides the official Brazilian FX fixing rate (buy/sell) from the OData API. Together these prove the BaseConnector pattern with market data (as opposed to macro series), different API technologies (yfinance library vs REST OData), and demonstrate that the MarketData model's idempotent write pattern works.

Output: Two connector modules (yahoo_finance.py, bcb_ptax.py) with ticker/series definitions, tests, and updated connectors __init__.py.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-connectors/02-RESEARCH.md
@.planning/phases/02-connectors/02-01-SUMMARY.md

@src/connectors/base.py
@src/core/models/market_data.py
@src/core/models/instruments.py
@src/core/config.py
@src/core/database.py
@tests/conftest.py
@tests/connectors/conftest.py
@tests/fixtures/ptax_sample.json
@tests/fixtures/yahoo_sample.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Yahoo Finance connector with 25+ tickers, async wrapping, and tests</name>
  <files>
    src/connectors/yahoo_finance.py
    tests/connectors/test_yahoo_finance.py
  </files>
  <action>
**Create src/connectors/yahoo_finance.py:**

Class `YahooFinanceConnector(BaseConnector)`:

Class-level constants:
- `SOURCE_NAME = "YAHOO_FINANCE"`
- `BASE_URL = "https://finance.yahoo.com"` (not actually used for HTTP since yfinance handles it, but required by BaseConnector)
- `BATCH_SIZE = 5` -- number of tickers to download in a single yf.download() call
- `BATCH_DELAY_SECONDS = 2.0` -- random delay between batches (1.0 to BATCH_DELAY_SECONDS)

TICKERS dict -- use the EXACT registry from the Fase0 guide (Etapa 9). Keys are our internal ticker names, values are Yahoo Finance ticker symbols:

```python
TICKERS = {
    # FX
    "USDBRL": "BRL=X",
    "EURUSD": "EURUSD=X",
    "USDJPY": "JPY=X",
    "GBPUSD": "GBPUSD=X",
    "USDCHF": "CHF=X",
    "DXY": "DX-Y.NYB",
    # Equity Indices
    "IBOVESPA": "^BVSP",
    "SP500": "^GSPC",
    "VIX": "^VIX",
    # Commodities
    "GOLD": "GC=F",
    "OIL_WTI": "CL=F",
    "OIL_BRENT": "BZ=F",
    "SOYBEAN": "ZS=F",
    "CORN": "ZC=F",
    "COPPER": "HG=F",
    "IRON_ORE_PROXY": "VALE3.SA",
    # ETFs
    "EWZ": "EWZ",
    "TIP_ETF": "TIP",
    "TLT_ETF": "TLT",
    "HYG_ETF": "HYG",
    "EMB_ETF": "EMB",
    "LQD_ETF": "LQD",
}
```

Note: This is 22 tickers. The requirement says 25+. Add these additional useful tickers to reach 25+:
```python
    "USDMXN": "MXN=X",        # Mexico peso (EM peer)
    "USDCNY": "CNY=X",        # China yuan
    "USDCLP": "CLP=X",        # Chile peso (EM peer)
    "NASDAQ": "^IXIC",        # Nasdaq Composite
    "RUSSELL2000": "^RUT",    # Russell 2000 small cap
```
That gives 27 tickers.

Methods:

`_batch_tickers(self) -> list[list[str]]`:
- Split TICKERS values into batches of BATCH_SIZE
- Return list of lists of Yahoo ticker symbols

`async def _download_batch(self, yahoo_tickers: list[str], start_date: date, end_date: date) -> dict`:
- Define inner sync function `_download()` that calls:
  ```python
  yf.download(
      tickers=yahoo_tickers,
      start=start_date.strftime("%Y-%m-%d"),
      end=end_date.strftime("%Y-%m-%d"),
      group_by="ticker",
      auto_adjust=True,
      threads=False,   # Avoid threading issues in async context
      progress=False,  # No progress bar in automated context
  )
  ```
- Wrap with `await asyncio.to_thread(_download)`
- Return the DataFrame (or handle yfinance returning different shapes for single vs multi ticker)

`async def fetch(self, start_date: date, end_date: date, tickers: list[str] | None = None, **kwargs) -> list[dict]`:
- Build a reverse map: Yahoo symbol -> our ticker name
- For each batch:
  - Call `_download_batch(batch_tickers, start_date, end_date)`
  - Parse the returned DataFrame into list of dicts
  - For single-ticker download, yfinance returns columns directly (Open, High, Low, Close, Volume)
  - For multi-ticker download, yfinance returns MultiIndex columns grouped by ticker
  - Handle both cases
  - For each row, create record dict: `{"_ticker": our_ticker_name, "timestamp": row_date_as_datetime_with_utc_tz, "frequency": "daily", "open": open_val, "high": high_val, "low": low_val, "close": close_val, "volume": volume_val, "adjusted_close": close_val (since auto_adjust=True), "source": "YAHOO_FINANCE"}`
  - Handle NaN values: convert to None
  - Log progress: `"batch_downloaded"` with batch number and ticker count
  - Sleep random(1.0, BATCH_DELAY_SECONDS) between batches
  - On error (including YfRateLimitError if available): log warning, skip batch, continue
- Return all records

`_ensure_instrument(self, ticker: str, yahoo_symbol: str) -> int`:
- Async helper that ensures an Instrument row exists for the ticker
- Use pg_insert on instruments table with on_conflict_do_nothing (on ticker unique constraint)
- Map ticker to reasonable defaults: asset_class from ticker prefix, country from symbol suffix, currency
- Return instrument id via SELECT

`async def store(self, records: list[dict]) -> int`:
- Group records by `_ticker`
- For each ticker group, ensure Instrument exists and get instrument_id
- Replace `_ticker` with integer `instrument_id` in each record
- Bulk insert all records using `_bulk_insert(MarketData, records, "uq_market_data_natural_key")`
- Return total inserted count

Override `__aenter__` and `__aexit__` to be no-ops for the httpx client (since yfinance handles its own HTTP). Still call super for logging setup. Or simply don't override -- the httpx client will exist but won't be used. The cleaner approach: override __aenter__ to skip httpx client creation (set self._client to a sentinel or skip it), since yfinance doesn't use it. Actually, simplest: just let the base create the client; it won't hurt anything to have an unused httpx client.

**Create tests/connectors/test_yahoo_finance.py:**

Note: yfinance is hard to mock cleanly because it uses its own HTTP layer internally. Tests should focus on:

- `test_tickers_registry_has_25_plus`: Assert `len(YahooFinanceConnector.TICKERS) >= 25`.

- `test_tickers_registry_has_key_tickers`: Assert "USDBRL", "SP500", "GOLD", "EWZ" are in TICKERS.

- `test_batch_tickers_creates_correct_batches`: Verify `_batch_tickers()` splits tickers into batches of BATCH_SIZE.

- `test_fetch_creates_records_with_correct_fields`: Mock `yf.download` using `unittest.mock.patch` (since yfinance doesn't use httpx). Create a mock DataFrame with known OHLCV data. Verify the connector produces records with the correct fields (timestamp, open, high, low, close, volume, source).

- `test_nan_values_converted_to_none`: Mock with DataFrame containing NaN values. Verify they become None in the records.

- `test_record_has_utc_timestamp`: Verify timestamp is timezone-aware (UTC).

For mocking yfinance: use `unittest.mock.patch("yfinance.download")` or `patch.object`. Create a mock pandas DataFrame as return value. Since yfinance returns DataFrames with DatetimeIndex, construct one with known values.
  </action>
  <verify>
Run: `python -c "from src.connectors.yahoo_finance import YahooFinanceConnector; print(f'Yahoo Finance tickers: {len(YahooFinanceConnector.TICKERS)}')"` -- should print 27 or more.

Run: `python -m pytest tests/connectors/test_yahoo_finance.py -v` -- all tests pass.
  </verify>
  <done>
YahooFinanceConnector exists with 25+ tickers (FX, indices, commodities, ETFs) from the Fase0 guide. Uses asyncio.to_thread() for non-blocking yfinance calls. Downloads in batches with random delays for rate limiting. Converts DataFrame to record dicts with proper NaN handling. Writes to market_data table via ON CONFLICT DO NOTHING. Tests verify ticker count, batching, record format, and NaN handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: BCB PTAX connector with MM-DD-YYYY date handling, closing bulletin filter, and tests</name>
  <files>
    src/connectors/bcb_ptax.py
    tests/connectors/test_bcb_ptax.py
    src/connectors/__init__.py
  </files>
  <action>
**Create src/connectors/bcb_ptax.py:**

Class `BcbPtaxConnector(BaseConnector)`:

Class-level constants:
- `SOURCE_NAME = "BCB_PTAX"`
- `BASE_URL = "https://olinda.bcb.gov.br"`
- `RATE_LIMIT_PER_SECOND = 2.0`
- `TIMEOUT_SECONDS = 30.0`
- `TICKER_NAME = "USDBRL_PTAX"` -- the instrument ticker for PTAX rates

Methods:

`async def fetch_period(self, start_date: date, end_date: date) -> list[dict]`:
- Build OData URL: `/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarPeriodo(dataInicial=@di,dataFinalCotacao=@df)`
- Params: `{"@di": f"'{start_date.strftime('%m-%d-%Y')}'", "@df": f"'{end_date.strftime('%m-%d-%Y')}'", "$format": "json"}`
- CRITICAL: Date format is MM-DD-YYYY (American format, NOT DD/MM/YYYY or ISO). This is the most common PTAX pitfall.
- Call `self._request("GET", url, params=params)`
- Parse response: `data.get("value", [])`
- Filter for `tipoBoletim == "Fechamento"` -- only keep the closing PTAX rate (the official fixing). Log a debug message for non-closing bulletins.
- For each closing bulletin:
  - Parse `dataHoraCotacao` (format: "YYYY-MM-DD HH:MM:SS.fff") with ZoneInfo("America/Sao_Paulo") timezone
  - Build record dict: `{"_ticker": self.TICKER_NAME, "timestamp": release_time (datetime with Sao Paulo tz), "frequency": "daily", "open": item["cotacaoCompra"], "high": None, "low": None, "close": item["cotacaoVenda"], "volume": None, "adjusted_close": item["cotacaoVenda"], "source": "BCB_PTAX"}`
  - Note: Store cotacaoCompra as `open` (buy rate) and cotacaoVenda as `close` (sell rate). This is a reasonable mapping to OHLCV columns for FX fixing data. The bid-ask spread is naturally captured.
  - Alternative approach: store `close` as the mid-rate `(cotacaoCompra + cotacaoVenda) / 2` and use a separate field for bid/ask. But the MarketData model doesn't have bid/ask columns, so mapping buy->open, sell->close is pragmatic.

`async def fetch(self, start_date: date, end_date: date, **kwargs) -> list[dict]`:
- Split date range into 1-year chunks (PTAX API handles long ranges but chunking is safer)
- Call `fetch_period` for each chunk
- Return all records

`async def store(self, records: list[dict]) -> int`:
- Ensure Instrument "USDBRL_PTAX" exists (using same pattern as Yahoo connector)
- Get instrument_id
- Replace `_ticker` with instrument_id in records
- Bulk insert with `_bulk_insert(MarketData, records, "uq_market_data_natural_key")`
- Return inserted count

**Update src/connectors/__init__.py:**
- Add imports: `from .yahoo_finance import YahooFinanceConnector`, `from .bcb_ptax import BcbPtaxConnector`
- The final __init__.py should export: BaseConnector, ConnectorError, RateLimitError, DataParsingError, FetchError, BcbSgsConnector, FredConnector, YahooFinanceConnector, BcbPtaxConnector

**Create tests/connectors/test_bcb_ptax.py:**

Using respx to mock the PTAX OData API:

- `test_fetch_period_uses_mm_dd_yyyy_format`: Mock the PTAX endpoint. Verify the request URL contains dates in MM-DD-YYYY format (e.g., '01-15-2025' not '15/01/2025' or '2025-01-15').

- `test_fetch_period_filters_closing_bulletin`: Mock with response containing both "Fechamento" and "Abertura" bulletins (use the ptax_sample.json fixture). Verify only closing bulletins are returned (2 out of 3 in the sample).

- `test_fetch_period_parses_buy_sell_rates`: Mock with sample data. Verify `open` == cotacaoCompra and `close` == cotacaoVenda for returned records.

- `test_fetch_period_sets_release_time_from_dataHoraCotacao`: Verify release_time is parsed from dataHoraCotacao with Sao Paulo timezone.

- `test_fetch_period_handles_empty_response`: Mock with `{"value": []}`. Verify empty list returned (no error).

- `test_date_format_produces_correct_api_params`: Directly test that `date(2025, 1, 15).strftime('%m-%d-%Y')` produces `"01-15-2025"`. This is the critical PTAX format test.

For respx tests: use `respx.mock(base_url="https://olinda.bcb.gov.br")` pattern.
  </action>
  <verify>
Run: `python -c "from src.connectors.bcb_ptax import BcbPtaxConnector; print('PTAX connector imported')"` -- should succeed.

Run: `python -c "from src.connectors import BcbSgsConnector, FredConnector, YahooFinanceConnector, BcbPtaxConnector; print('All 4 connectors importable')"` -- should succeed.

Run: `python -m pytest tests/connectors/test_bcb_ptax.py -v` -- all tests pass.

Run: `python -m pytest tests/ -v` -- ALL tests pass (utils + connectors).
  </verify>
  <done>
BcbPtaxConnector fetches official FX fixing rates with correct MM-DD-YYYY date format. Filters for closing bulletin only (the official PTAX). Stores cotacaoCompra as open (buy rate), cotacaoVenda as close (sell rate). Uses dataHoraCotacao with Sao Paulo timezone as release_time. YahooFinanceConnector and BcbPtaxConnector both write to market_data with ON CONFLICT DO NOTHING. All 4 connectors (BCB SGS, FRED, Yahoo, PTAX) are importable from src.connectors. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.connectors import BcbSgsConnector, FredConnector, YahooFinanceConnector, BcbPtaxConnector"` -- all 4 import
2. `python -c "from src.connectors.yahoo_finance import YahooFinanceConnector; assert len(YahooFinanceConnector.TICKERS) >= 25"` -- 25+ tickers
3. `python -m pytest tests/connectors/test_yahoo_finance.py tests/connectors/test_bcb_ptax.py -v` -- all pass
4. `python -m pytest tests/ -v --tb=short` -- ALL tests pass (entire test suite)
5. PTAX date format test confirms MM-DD-YYYY (not DD/MM or ISO)
6. Yahoo Finance connector uses asyncio.to_thread for non-blocking execution
7. PTAX connector filters for "Fechamento" closing bulletin
</verification>

<success_criteria>
- Yahoo Finance connector fetches OHLCV for 25+ tickers with asyncio.to_thread wrapping, batch delays, and NaN handling
- BCB PTAX connector fetches official FX fixing with MM-DD-YYYY date format and closing bulletin filter
- Both connectors store release_time for point-in-time correctness
- Both connectors use ON CONFLICT DO NOTHING for idempotent writes
- All 4 Phase 2 connectors are importable from src.connectors
- Complete test suite passes (utility tests + all connector tests)
</success_criteria>

<output>
After completion, create `.planning/phases/02-connectors/02-03-SUMMARY.md`
</output>
