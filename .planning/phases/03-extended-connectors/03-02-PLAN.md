---
phase: 03-extended-connectors
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/connectors/ibge_sidra.py
  - tests/connectors/test_ibge_sidra.py
  - tests/fixtures/ibge_sidra_sample.json
  - src/connectors/bcb_focus.py
  - tests/connectors/test_bcb_focus.py
  - tests/fixtures/bcb_focus_sample.json
autonomous: true
requirements:
  - CONN-06
  - CONN-04

must_haves:
  truths:
    - "IBGE SIDRA connector fetches IPCA MoM change and weight for 9 components from Table 7060"
    - "IBGE SIDRA connector skips the header row (data[0]) and parses YYYYMM periods into first-of-month dates"
    - "IBGE SIDRA connector stores records to macro_series table with series_id per component"
    - "BCB Focus connector fetches market expectations for IPCA, Selic, GDP, FX with OData pagination"
    - "BCB Focus connector encodes reference year/period in series_id (e.g. BR_FOCUS_IPCA_2026_MEDIAN)"
    - "BCB Focus connector stores records to macro_series table with observation_date as survey date"
    - "Both connectors use ON CONFLICT DO NOTHING for idempotent writes"
    - "Both connectors have passing tests with respx mocks"
  artifacts:
    - path: "src/connectors/ibge_sidra.py"
      provides: "IBGE SIDRA IPCA connector with 9 groups and weights"
      min_lines: 120
    - path: "tests/connectors/test_ibge_sidra.py"
      provides: "IBGE SIDRA tests with respx mocks"
      min_lines: 60
    - path: "src/connectors/bcb_focus.py"
      provides: "BCB Focus connector with OData pagination"
      min_lines: 180
    - path: "tests/connectors/test_bcb_focus.py"
      provides: "BCB Focus tests with respx mocks"
      min_lines: 80
  key_links:
    - from: "src/connectors/ibge_sidra.py"
      to: "src/core/models/macro_series.py"
      via: "_bulk_insert with MacroSeries model"
      pattern: "_bulk_insert.*MacroSeries.*uq_macro_series_natural_key"
    - from: "src/connectors/bcb_focus.py"
      to: "src/core/models/macro_series.py"
      via: "_bulk_insert with MacroSeries model"
      pattern: "_bulk_insert.*MacroSeries.*uq_macro_series_natural_key"
    - from: "src/connectors/bcb_focus.py"
      to: "https://olinda.bcb.gov.br"
      via: "OData pagination with $top/$skip"
      pattern: "\\$top.*\\$skip"
---

<objective>
Implement the IBGE SIDRA connector (CONN-06) for disaggregated IPCA data and the BCB Focus connector (CONN-04) for market expectations with OData pagination. Both store to the macro_series table.

Purpose: IBGE SIDRA provides IPCA inflation broken down by 9 components with weights -- essential for inflation analysis and the diffusion index transform in Phase 5. BCB Focus provides market consensus expectations (IPCA, Selic, GDP, FX) by horizon -- essential for macro surprise calculations.

Output: Two working connectors with tests. IBGE SIDRA uses a path-based REST API; BCB Focus uses OData with pagination.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-extended-connectors/03-RESEARCH.md

# Pattern reference
@src/connectors/base.py
@src/connectors/bcb_sgs.py
@src/connectors/bcb_ptax.py

# Target ORM model
@src/core/models/macro_series.py
@src/core/models/data_sources.py
@src/core/models/series_metadata.py

# Test infrastructure
@tests/connectors/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: IBGE SIDRA connector for IPCA components (CONN-06)</name>
  <files>
    src/connectors/ibge_sidra.py
    tests/connectors/test_ibge_sidra.py
    tests/fixtures/ibge_sidra_sample.json
  </files>
  <action>
Create `src/connectors/ibge_sidra.py` implementing `IbgeSidraConnector` inheriting from `BaseConnector`.

**Class attributes:**
- `SOURCE_NAME = "IBGE_SIDRA"`
- `BASE_URL = "https://apisidra.ibge.gov.br"`
- `RATE_LIMIT_PER_SECOND = 1.0` (conservative -- IBGE has no documented rate limit)
- `TIMEOUT_SECONDS = 60.0` (SIDRA can be slow)

**IPCA groups registry (dict mapping group_name -> SIDRA classification code):**
```python
IPCA_GROUPS = {
    "FOOD":          7169,
    "HOUSING":       7170,
    "HOUSEHOLD":     7445,
    "CLOTHING":      7171,
    "TRANSPORT":     7432,
    "HEALTH":        7172,
    "PERSONAL":      7173,
    "EDUCATION":     7174,
    "COMMUNICATION": 7175,
}
```

Also build a reverse map `_code_to_name` for parsing responses.

**SIDRA variables:**
- Variable 63: MoM percentage change
- Variable 2265: Weight in the IPCA basket

**`fetch()` method:**
- Convert start_date/end_date to YYYYMM period format (e.g., `202401`)
- Build path-based URL: `/values/t/7060/n1/all/v/{variable}/p/{start_period}-{end_period}/c315/{group_codes}`
  - `group_codes` = comma-separated IPCA_GROUPS values
- Fetch Variable 63 (MoM change) and Variable 2265 (weight) in separate requests
- Parse response JSON: **CRITICAL -- skip data[0] (header row)**
- For each data item (index 1+):
  - `D3C` = period code (YYYYMM)
  - `D4C` = classification code (group)
  - `V` = value string (may be empty, "-", or "...")
  - Skip records where V is empty/invalid
  - Convert period to `date(year, month, 1)` (first-of-month convention)
  - Map group code to group name via `_code_to_name`
- Generate series keys:
  - MoM: `BR_IPCA_{GROUP}_MOM` (e.g., `BR_IPCA_FOOD_MOM`)
  - Weight: `BR_IPCA_{GROUP}_WEIGHT` (e.g., `BR_IPCA_FOOD_WEIGHT`)
- Tag records with `_series_key`, `observation_date`, `value`, `release_time`, `revision_number=0`, `source`

**`store()` method:**
- Same pattern as BcbSgsConnector.store(): ensure data_source, ensure series_metadata per key, attach series_id, _bulk_insert(MacroSeries, records, "uq_macro_series_natural_key")

**Test file** (`tests/connectors/test_ibge_sidra.py`):
- Create fixture `tests/fixtures/ibge_sidra_sample.json` -- array where first element is header metadata and subsequent elements have `D3C`, `D4C`, `V` fields
- Test that header row (index 0) is skipped
- Test YYYYMM period is parsed to first-of-month date
- Test invalid values ("", "-", "...") are skipped
- Test series keys correctly incorporate group name
- Test all 9 IPCA groups are in the registry
- Use respx mocking with `base_url="https://apisidra.ibge.gov.br"`
  </action>
  <verify>
Run `python -m pytest tests/connectors/test_ibge_sidra.py -v` -- all tests pass.
Verify `IbgeSidraConnector` is importable: `python -c "from src.connectors.ibge_sidra import IbgeSidraConnector; print('OK')"`
Verify IPCA_GROUPS has exactly 9 entries: `python -c "from src.connectors.ibge_sidra import IbgeSidraConnector; assert len(IbgeSidraConnector.IPCA_GROUPS) == 9; print('9 groups OK')"`
  </verify>
  <done>
IBGE SIDRA connector fetches IPCA MoM change and weights for all 9 components from Table 7060, skips the header row, converts YYYYMM to first-of-month dates, and stores to macro_series with ON CONFLICT DO NOTHING. Tests pass with respx mocks.
  </done>
</task>

<task type="auto">
  <name>Task 2: BCB Focus connector with OData pagination (CONN-04)</name>
  <files>
    src/connectors/bcb_focus.py
    tests/connectors/test_bcb_focus.py
    tests/fixtures/bcb_focus_sample.json
  </files>
  <action>
Create `src/connectors/bcb_focus.py` implementing `BcbFocusConnector` inheriting from `BaseConnector`.

**Class attributes:**
- `SOURCE_NAME = "BCB_FOCUS"`
- `BASE_URL = "https://olinda.bcb.gov.br"`
- `RATE_LIMIT_PER_SECOND = 2.0`
- `ODATA_PAGE_SIZE = 1000`
- `MAX_PAGES = 100` (safety limit: 100K records max)

**Indicator configuration:**
```python
INDICATORS = {
    "IPCA": {"entity_set": "ExpectativasMercadoAnuais", "type": "annual"},
    "IGP-M": {"entity_set": "ExpectativasMercadoAnuais", "type": "annual"},
    "Selic": {"entity_set": "ExpectativasMercadoSelic", "type": "selic"},
    "PIB": {"entity_set": "ExpectativasMercadoAnuais", "type": "annual"},
    "Câmbio": {"entity_set": "ExpectativasMercadoAnuais", "type": "annual"},
}
```

**`_fetch_odata_paginated()` method (private):**
- Accepts `entity_set: str` and `odata_filter: str`
- Paginates using `$top={PAGE_SIZE}` and `$skip=N*PAGE_SIZE`
- URL pattern: `/olinda/servico/Expectativas/versao/v1/odata/{entity_set}`
- Params: `$format=json`, `$top`, `$skip`, `$filter`, `$orderby=Data desc`
- Terminate when `len(items) < PAGE_SIZE` (partial or empty page)
- Safety: break after MAX_PAGES iterations with a warning log
- Return all accumulated records from `response["value"]` arrays

**`fetch()` method:**
- For each indicator in INDICATORS:
  - Build OData filter: `Indicador eq '{indicator}' and Data ge '{start_date}' and Data le '{end_date}'`
  - Call `_fetch_odata_paginated()` with the indicator's entity set
  - Map each response item to a record:
    - `observation_date` = parse `Data` field (YYYY-MM-DD format, this is the survey/publication date)
    - For annual type: `DataReferencia` = reference year (e.g., "2026")
      - `series_key = f"BR_FOCUS_{indicator.upper().replace('-', '')}_{ref_year}_MEDIAN"`
    - For selic type: `DataReferencia` = meeting date/reference
      - `series_key = f"BR_FOCUS_SELIC_{ref_year}_MEDIAN"`
    - `value` = `Mediana` field (the consensus median)
    - `release_time` = datetime from observation_date with Sao_Paulo timezone
    - `revision_number = 0`
    - Tag with `_series_key`
- Handle indicator names with accents/special chars: normalize for series_key (e.g., "Câmbio" -> "CAMBIO")

**`store()` method:**
- Same pattern as BcbSgsConnector.store(): ensure data_source, ensure series_metadata per key, attach series_id, _bulk_insert(MacroSeries, records, "uq_macro_series_natural_key")

**Test file** (`tests/connectors/test_bcb_focus.py`):
- Create fixture `tests/fixtures/bcb_focus_sample.json` with sample OData response containing `value` array with representative items (Indicador, Data, DataReferencia, Mediana, Media, etc.)
- Test OData pagination: mock 2 pages (first full, second partial) to verify pagination termination
- Test series_key encodes reference year: `BR_FOCUS_IPCA_2026_MEDIAN`
- Test observation_date is the survey date (not the reference year)
- Test MAX_PAGES safety limit (mock endless full pages, verify loop stops)
- Test empty response (value array with 0 items)
- Use respx mocking with `base_url="https://olinda.bcb.gov.br"`
  </action>
  <verify>
Run `python -m pytest tests/connectors/test_bcb_focus.py -v` -- all tests pass.
Verify `BcbFocusConnector` is importable: `python -c "from src.connectors.bcb_focus import BcbFocusConnector; print('OK')"`
Verify OData pagination terminates: test with 2-page mock returns correct record count.
  </verify>
  <done>
BCB Focus connector fetches market expectations for IPCA, Selic, GDP, FX, IGP-M via OData API with $top/$skip pagination, encodes reference year in series_id for horizon disambiguation, and stores to macro_series with ON CONFLICT DO NOTHING. Tests pass including pagination termination and safety limit.
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/connectors/test_ibge_sidra.py tests/connectors/test_bcb_focus.py -v` -- all tests pass
- IBGE SIDRA: header row skipped, 9 IPCA groups in registry, YYYYMM -> date(Y, M, 1)
- BCB Focus: OData pagination terminates correctly, series_key includes reference year
- Both connectors store to macro_series with correct constraint
- No new dependencies added
</verification>

<success_criteria>
- IbgeSidraConnector fetches 9 IPCA components (MoM + weight) and stores to macro_series
- BcbFocusConnector fetches expectations with OData pagination and stores by horizon
- Both connectors pass all tests with respx mocks
- Series IDs correctly disambiguate different components/horizons
</success_criteria>

<output>
After completion, create `.planning/phases/03-extended-connectors/03-02-SUMMARY.md`
</output>
