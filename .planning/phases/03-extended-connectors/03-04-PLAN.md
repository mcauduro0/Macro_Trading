---
phase: 03-extended-connectors
plan: 04
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
  - 03-03
files_modified:
  - src/connectors/cftc_cot.py
  - tests/connectors/test_cftc_cot.py
  - tests/fixtures/cftc_disagg_sample.csv
  - src/connectors/__init__.py
  - tests/connectors/conftest.py
autonomous: true
requirements:
  - CONN-08

must_haves:
  truths:
    - "CFTC COT connector downloads disaggregated futures ZIP files for historical years and parses the CSV inside"
    - "CFTC COT connector fetches current-week data from Socrata CSV API"
    - "CFTC COT connector computes net positions (long - short) for 4 categories x 12 contracts = 48 series"
    - "CFTC COT connector stores records to flow_data table with flow_type per category"
    - "CFTC COT connector uses asyncio.to_thread for pandas CSV parsing (non-blocking)"
    - "CFTC COT connector uses ON CONFLICT DO NOTHING for idempotent writes"
    - "All 7 new connectors are exported from src/connectors/__init__.py"
  artifacts:
    - path: "src/connectors/cftc_cot.py"
      provides: "CFTC COT connector with 12 contracts x 4 categories"
      min_lines: 220
    - path: "tests/connectors/test_cftc_cot.py"
      provides: "CFTC COT tests with mocked CSV data"
      min_lines: 100
    - path: "src/connectors/__init__.py"
      provides: "Updated exports for all 11 connectors"
      contains: "BcbFxFlowConnector"
  key_links:
    - from: "src/connectors/cftc_cot.py"
      to: "src/core/models/flow_data.py"
      via: "_bulk_insert with FlowData model"
      pattern: "_bulk_insert.*FlowData.*uq_flow_data_natural_key"
    - from: "src/connectors/cftc_cot.py"
      to: "cftc.gov/files/dea/history"
      via: "ZIP download and in-memory CSV extraction"
      pattern: "zipfile\\.ZipFile"
    - from: "src/connectors/__init__.py"
      to: "all 7 new connector modules"
      via: "import and __all__ list"
      pattern: "__all__.*BcbFxFlowConnector.*CftcCotConnector"
---

<objective>
Implement the CFTC COT connector (CONN-08) for disaggregated futures positioning data from bulk CSV files, and update src/connectors/__init__.py to export all 7 new Phase 3 connectors.

Purpose: CFTC COT positioning data provides speculator/hedger positioning for 12 key contracts (ES, TY, US, etc.) -- essential for sentiment and flow analysis. The __init__.py update ensures all 11 connectors (4 from Phase 2 + 7 from Phase 3) are importable from the connectors package.

Output: CFTC COT connector with tests, plus updated package exports for the complete connector suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-extended-connectors/03-RESEARCH.md

# Pattern reference
@src/connectors/base.py
@src/connectors/bcb_sgs.py

# Target ORM model
@src/core/models/flow_data.py
@src/core/models/data_sources.py
@src/core/models/series_metadata.py

# Package exports to update
@src/connectors/__init__.py

# Test infrastructure
@tests/connectors/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CFTC COT disaggregated connector (CONN-08)</name>
  <files>
    src/connectors/cftc_cot.py
    tests/connectors/test_cftc_cot.py
    tests/fixtures/cftc_disagg_sample.csv
  </files>
  <action>
Create `src/connectors/cftc_cot.py` implementing `CftcCotConnector` inheriting from `BaseConnector`.

**Class attributes:**
- `SOURCE_NAME = "CFTC_COT"`
- `BASE_URL = "https://www.cftc.gov"`
- `RATE_LIMIT_PER_SECOND = 1.0`
- `TIMEOUT_SECONDS = 120.0` (ZIP files can be large)
- `SOCRATA_BASE_URL = "https://publicreporting.cftc.gov"`

**Contract registry (12 contracts, mapping name -> CFTC_Contract_Market_Code):**
```python
CONTRACT_CODES = {
    "ES": "13874A",    # E-mini S&P 500
    "NQ": "209742",    # E-mini NASDAQ 100
    "YM": "124603",    # E-mini Dow
    "TY": "043602",    # 10-Year T-Note
    "US": "020601",    # 30-Year T-Bond
    "FV": "044601",    # 5-Year T-Note
    "TU": "042601",    # 2-Year T-Note
    "ED": "132741",    # Eurodollar (legacy, may use SOFR now)
    "CL": "067651",    # Crude Oil WTI
    "GC": "088691",    # Gold
    "SI": "084691",    # Silver
    "DX": "098662",    # US Dollar Index
}
```
Build `_reverse_contract_map = {v: k for k, v in CONTRACT_CODES.items()}`

**Position categories (4 categories from disaggregated report):**
```python
CATEGORIES = {
    "DEALER":    ("Dealer_Positions_Long_All",    "Dealer_Positions_Short_All"),
    "ASSETMGR":  ("Asset_Mgr_Positions_Long_All", "Asset_Mgr_Positions_Short_All"),
    "LEVERAGED": ("Lev_Money_Positions_Long_All",  "Lev_Money_Positions_Short_All"),
    "OTHER":     ("Other_Rept_Positions_Long_All", "Other_Rept_Positions_Short_All"),
}
```

**`_download_historical_year()` method:**
- Download yearly ZIP: `GET /files/dea/history/fut_disagg_txt_{year}.zip`
- Extract ZIP in-memory: `zipfile.ZipFile(io.BytesIO(response.content))`
- Get the first (only) file in the ZIP
- Parse CSV with `pd.read_csv()` wrapped in `asyncio.to_thread()` (**CRITICAL: don't block event loop**)
- Filter DataFrame by `CFTC_Contract_Market_Code` matching tracked contracts
- Return filtered DataFrame

**`_fetch_current_week()` method:**
- Fetch from Socrata: create a temporary httpx client with `base_url=SOCRATA_BASE_URL`
- `GET /resource/72hh-3qpy.csv?$limit=5000`
- Parse CSV with `pd.read_csv(io.StringIO(response.text))` via `asyncio.to_thread()`
- Filter by tracked contracts
- Return DataFrame (or empty DataFrame on error with warning log)

**`compute_net_positions()` method:**
- Input: pandas DataFrame from either source
- For each row:
  - `report_date` = parse `Report_Date_as_YYYY-MM-DD` column
  - `contract_code` = `CFTC_Contract_Market_Code` column
  - `contract_name` = lookup in `_reverse_contract_map` (skip if not tracked)
  - For each of 4 categories in CATEGORIES:
    - Validate both long and short columns exist (log warning if missing, skip)
    - `net = row[long_col] - row[short_col]`
    - `series_key = f"CFTC_{contract_name}_{cat_name}_NET"` (e.g., `CFTC_ES_DEALER_NET`)
    - Build record: `_series_key`, `observation_date=report_date`, `value=float(net)`, `flow_type=f"CFTC_{cat_name}_NET"`, `unit="contracts"`, `release_time=None`
- Return list of record dicts

**`fetch()` method:**
- Determine year range from start_date.year to end_date.year
- For historical years (< current year): call `_download_historical_year(year)`
- For current year: call `_fetch_current_week()` (Socrata provides latest data)
- Combine all DataFrames
- Call `compute_net_positions()` on combined DataFrame
- Filter records to [start_date, end_date]
- Return records

**`store()` method:**
- Ensure data_source row exists
- Ensure series_metadata for each unique _series_key
- Attach series_id to each record, remove _series_key
- `_bulk_insert(FlowData, records, "uq_flow_data_natural_key")`

**Test file** (`tests/connectors/test_cftc_cot.py`):
- Create fixture `tests/fixtures/cftc_disagg_sample.csv` with 3-5 rows containing the required columns for 2 contracts and all 4 categories
- Test net position computation: `long - short` = expected net for each category
- Test contract filtering: only tracked contracts appear in output
- Test series_key format: `CFTC_{CONTRACT}_{CATEGORY}_NET`
- Test column validation: missing column logs warning, does not crash
- Test ZIP extraction: mock the ZIP download with a real ZIP bytes object containing the sample CSV
- Test Socrata fallback: mock Socrata endpoint returning CSV data
- Test empty DataFrame produces empty record list
- Use respx mocking for both cftc.gov and publicreporting.cftc.gov
  </action>
  <verify>
Run `python -m pytest tests/connectors/test_cftc_cot.py -v` -- all tests pass.
Verify `CftcCotConnector` is importable: `python -c "from src.connectors.cftc_cot import CftcCotConnector; print('OK')"`
Verify 12 contracts: `python -c "from src.connectors.cftc_cot import CftcCotConnector; assert len(CftcCotConnector.CONTRACT_CODES) == 12; print('12 contracts OK')"`
Verify 4 categories: `python -c "from src.connectors.cftc_cot import CftcCotConnector; assert len(CftcCotConnector.CATEGORIES) == 4; print('4 categories OK')"`
  </verify>
  <done>
CFTC COT connector downloads disaggregated futures ZIP files (historical) and Socrata CSV (current week), computes net positions for 12 contracts x 4 categories = 48 series, and stores to flow_data with ON CONFLICT DO NOTHING. pandas parsing is event-loop-safe via asyncio.to_thread. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update connectors package exports and test conftest</name>
  <files>
    src/connectors/__init__.py
    tests/connectors/conftest.py
  </files>
  <action>
Update `src/connectors/__init__.py` to import and export all 7 new connectors from Phase 3:

Add imports:
```python
from .bcb_fx_flow import BcbFxFlowConnector
from .bcb_focus import BcbFocusConnector
from .b3_market_data import B3MarketDataConnector
from .ibge_sidra import IbgeSidraConnector
from .stn_fiscal import StnFiscalConnector
from .cftc_cot import CftcCotConnector
from .treasury_gov import TreasuryGovConnector
```

Update `__all__` list to include all 11 connectors (4 Phase 2 + 7 Phase 3):
```python
__all__ = [
    # Base
    "BaseConnector",
    "ConnectorError",
    "DataParsingError",
    "FetchError",
    "RateLimitError",
    # Phase 2 connectors
    "BcbPtaxConnector",
    "BcbSgsConnector",
    "FredConnector",
    "YahooFinanceConnector",
    # Phase 3 connectors
    "B3MarketDataConnector",
    "BcbFocusConnector",
    "BcbFxFlowConnector",
    "CftcCotConnector",
    "IbgeSidraConnector",
    "StnFiscalConnector",
    "TreasuryGovConnector",
]
```

Update `tests/connectors/conftest.py` to add fixture loaders for the new Phase 3 test fixtures:
- `bcb_fx_flow_response` loading `bcb_fx_flow_sample.json`
- `bcb_focus_response` loading `bcb_focus_sample.json`
- `tesouro_direto_response` loading `tesouro_direto_sample.json`
- `ibge_sidra_response` loading `ibge_sidra_sample.json`
- `stn_fiscal_response` loading `stn_fiscal_sample.json`
- For CSV fixtures (cftc, treasury), add helpers that return raw text or Path objects

These are convenience fixtures -- individual test files may also load fixtures directly. The conftest additions ensure consistency with the Phase 2 pattern.
  </action>
  <verify>
Verify all 11 connectors importable from package: `python -c "from src.connectors import BcbFxFlowConnector, BcbFocusConnector, B3MarketDataConnector, IbgeSidraConnector, StnFiscalConnector, CftcCotConnector, TreasuryGovConnector; print('All 7 new connectors imported OK')"`
Run full connector test suite: `python -m pytest tests/connectors/ -v` -- all tests pass (Phase 2 + Phase 3)
  </verify>
  <done>
All 11 connectors (4 Phase 2 + 7 Phase 3) are importable from `src.connectors`. Test conftest updated with fixture loaders for Phase 3. Full connector test suite passes.
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/connectors/ -v` -- ALL connector tests pass (Phase 2 + Phase 3)
- `python -c "import src.connectors; print(len(src.connectors.__all__))"` prints 16 (5 base + 4 Phase 2 + 7 Phase 3)
- CFTC COT: 12 contracts x 4 categories = 48 potential series
- CFTC COT: ZIP extraction in-memory (no temp files)
- CFTC COT: pandas parsing via asyncio.to_thread
</verification>

<success_criteria>
- CftcCotConnector passes all tests with mocked CSV/ZIP data
- Net positions computed correctly: long - short for each category
- All 11 connectors exported from src.connectors.__init__.py
- Full test suite passes (Phase 2 + Phase 3 connectors)
</success_criteria>

<output>
After completion, create `.planning/phases/03-extended-connectors/03-04-SUMMARY.md`
</output>
