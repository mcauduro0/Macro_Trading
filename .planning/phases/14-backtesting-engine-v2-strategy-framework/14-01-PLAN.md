---
phase: 14-backtesting-engine-v2-strategy-framework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/strategies/base.py
  - src/strategies/registry.py
  - src/strategies/__init__.py
  - src/core/enums.py
  - src/core/models/strategy_state.py
  - src/core/models/backtest_results.py
  - src/core/models/__init__.py
  - alembic/env.py
  - alembic/versions/006_add_strategy_state_enhance_backtest_results.py
  - tests/test_strategies/test_base.py
  - tests/test_strategies/test_registry.py
autonomous: true
requirements:
  - SFWK-01
  - SFWK-02
  - SFWK-03
  - SFWK-04

must_haves:
  truths:
    - "StrategySignal dataclass includes z_score, raw_value, suggested_size, entry_level, stop_loss, take_profit, holding_period_days, metadata fields"
    - "StrategyRegistry.register decorator registers a strategy class by ID"
    - "StrategyRegistry.list_by_asset_class returns only strategies of that asset class"
    - "StrategyRegistry.instantiate creates a strategy instance by ID with optional params"
    - "Existing 8 strategies continue to work via ALL_STRATEGIES dict AND are auto-registered in StrategyRegistry"
    - "strategy_state table exists in database with correct columns and indexes"
    - "backtest_results table has new v2 columns (params_json, daily_returns_json, run_timestamp, avg_holding_days, num_trades)"
  artifacts:
    - path: "src/strategies/base.py"
      provides: "Enhanced StrategySignal dataclass and updated BaseStrategy with compute_z_score, size_from_conviction, classify_strength"
      contains: "class StrategySignal"
    - path: "src/strategies/registry.py"
      provides: "StrategyRegistry with register decorator, get, list_all, list_by_asset_class, instantiate, instantiate_all"
      exports: ["StrategyRegistry"]
    - path: "src/core/models/strategy_state.py"
      provides: "StrategyStateRecord ORM model for strategy_state table"
      contains: "class StrategyStateRecord"
    - path: "alembic/versions/006_add_strategy_state_enhance_backtest_results.py"
      provides: "Alembic migration for strategy_state table and backtest_results v2 columns"
      contains: "def upgrade"
  key_links:
    - from: "src/strategies/registry.py"
      to: "src/strategies/base.py"
      via: "imports BaseStrategy type for registry type hints"
      pattern: "from src\\.strategies\\.base import"
    - from: "src/strategies/__init__.py"
      to: "src/strategies/registry.py"
      via: "re-exports StrategyRegistry"
      pattern: "from src\\.strategies\\.registry import StrategyRegistry"
    - from: "alembic/env.py"
      to: "src/core/models/strategy_state.py"
      via: "imports strategy_state module for autogenerate"
      pattern: "strategy_state"
---

<objective>
Enhanced StrategySignal dataclass, StrategyRegistry with decorator-based registration, and database migrations for strategy_state and backtest_results v2 tables.

Purpose: Establish the foundational strategy infrastructure that all 16 new strategies (Phase 15) and the BacktestEngine v2 (Plan 14-02) will build on. The StrategyRegistry replaces the manual ALL_STRATEGIES dict with a decorator-based pattern, while the enhanced StrategySignal adds quantitative fields (z_score, entry_level, stop_loss, take_profit) needed for rigorous backtesting.

Output: Enhanced base.py with StrategySignal, new registry.py, strategy_state ORM model, backtest_results v2 migration, and tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/strategies/base.py
@src/strategies/__init__.py
@src/core/enums.py
@src/core/models/backtest_results.py
@src/core/models/__init__.py
@alembic/env.py
@alembic/versions/004_add_strategy_signals_backtest.py
@docs/GUIA_COMPLETO_CLAUDE_CODE_Fase2.md (lines 44-282 for Etapa 1 specs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced StrategySignal, updated BaseStrategy, and StrategyRegistry</name>
  <files>
    src/strategies/base.py
    src/strategies/registry.py
    src/strategies/__init__.py
    src/core/enums.py
  </files>
  <action>
1. **Update src/core/enums.py**: Add expanded AssetClass values needed by Phase 15 strategies. The existing AssetClass has FX, EQUITY_INDEX, COMMODITY, FIXED_INCOME, CRYPTO. Add new values: RATES_BR, RATES_US, INFLATION_BR, INFLATION_US, CUPOM_CAMBIAL, SOVEREIGN_CREDIT, CROSS_ASSET. Keep existing values so nothing breaks. NOTE: The existing 8 strategies use AssetClass.FIXED_INCOME and AssetClass.FX -- these continue to work.

2. **Enhance src/strategies/base.py**: Add the StrategySignal dataclass ALONGSIDE the existing StrategyConfig, StrategyPosition, and BaseStrategy. Do NOT remove or rename any existing classes -- coexistence is key.

   StrategySignal fields (per SFWK-01):
   ```python
   @dataclass
   class StrategySignal:
       strategy_id: str
       timestamp: datetime
       direction: SignalDirection
       strength: SignalStrength
       confidence: float           # 0.0 to 1.0
       z_score: float              # z-score vs history
       raw_value: float            # raw model output
       suggested_size: float       # 0.0 to 1.0 risk units
       asset_class: AssetClass
       instruments: list[str]      # ticker list
       entry_level: Optional[float] = None
       stop_loss: Optional[float] = None
       take_profit: Optional[float] = None
       holding_period_days: Optional[int] = None
       metadata: dict = field(default_factory=dict)
   ```

   Add utility methods to BaseStrategy (do NOT make them abstract -- concrete methods with default implementations):
   - `compute_z_score(value: float, history: list[float], window: int = 252) -> float`: Rolling z-score. If len(history) < 2, return 0.0. Use last `window` values, compute mean and std, return (value - mean) / std. Guard against zero std (return 0.0).
   - `size_from_conviction(z_score: float, max_size: float = 1.0) -> float`: Sigmoid truncated mapping. Use `min(max_size, max_size * (2 / (1 + exp(-abs(z_score))) - 1))`. Returns 0 for z=0, approaches max_size for large |z|.
   - `classify_strength(z_score: float) -> SignalStrength`: |z| >= 2.0 -> STRONG, |z| >= 1.0 -> MODERATE, |z| >= 0.5 -> WEAK, else NO_SIGNAL.

3. **Create src/strategies/registry.py**: StrategyRegistry class (per SFWK-02):
   - Class-level `_strategies: dict[str, type[BaseStrategy]] = {}` and `_metadata: dict[str, dict] = {}` (stores asset_class, instruments per strategy).
   - `@classmethod register(cls, strategy_id: str, asset_class: AssetClass = None, instruments: list[str] = None)` decorator: Stores class in _strategies, stores metadata in _metadata. Returns the original class unmodified.
   - `@classmethod get(cls, strategy_id: str) -> type[BaseStrategy]`: Raises KeyError with helpful message if not found.
   - `@classmethod list_all(cls) -> list[str]`: Returns sorted list of all strategy IDs.
   - `@classmethod list_by_asset_class(cls, asset_class: AssetClass) -> list[str]`: Filters by asset_class from metadata. Falls back to checking instantiated strategy's config.asset_class if metadata missing.
   - `@classmethod instantiate(cls, strategy_id: str, **kwargs) -> BaseStrategy`: Gets class and calls constructor. Pass **kwargs through.
   - `@classmethod instantiate_all(cls) -> list[BaseStrategy]`: Instantiates all registered strategies with default params.

4. **Update src/strategies/__init__.py**: Keep ALL existing exports (ALL_STRATEGIES, BaseStrategy, StrategyConfig, StrategyPosition, all 8 strategy classes). ADD imports for StrategySignal and StrategyRegistry. Also register each of the 8 existing strategies in the StrategyRegistry by calling `StrategyRegistry._strategies[id] = cls` for each entry in ALL_STRATEGIES at module load time (after imports), so both ALL_STRATEGIES dict AND StrategyRegistry are populated. Add StrategyRegistry metadata entries for each existing strategy using their StrategyConfig.asset_class.
  </action>
  <verify>
    Run: `cd /home/user/Macro_Trading && python -c "
from src.strategies import StrategySignal, StrategyRegistry, ALL_STRATEGIES, BaseStrategy, StrategyConfig, StrategyPosition
from src.core.enums import AssetClass, SignalDirection, SignalStrength
from datetime import datetime

# Verify StrategySignal has all required fields
sig = StrategySignal(strategy_id='TEST', timestamp=datetime.now(), direction=SignalDirection.LONG, strength=SignalStrength.STRONG, confidence=0.9, z_score=2.5, raw_value=100.0, suggested_size=0.8, asset_class=AssetClass.FX, instruments=['USDBRL'])
assert sig.z_score == 2.5
assert sig.entry_level is None

# Verify Registry has existing 8 strategies
assert len(StrategyRegistry.list_all()) == 8
assert 'RATES_BR_01' in StrategyRegistry.list_all()

# Verify backward compat
assert len(ALL_STRATEGIES) == 8

print('ALL CHECKS PASSED')
"`
  </verify>
  <done>StrategySignal dataclass has all SFWK-01 fields, StrategyRegistry provides register/get/list_all/list_by_asset_class/instantiate/instantiate_all, existing 8 strategies are registered in both ALL_STRATEGIES and StrategyRegistry, all existing imports continue to work.</done>
</task>

<task type="auto">
  <name>Task 2: Database models and Alembic migration for strategy_state and backtest_results v2</name>
  <files>
    src/core/models/strategy_state.py
    src/core/models/backtest_results.py
    src/core/models/__init__.py
    alembic/env.py
    alembic/versions/006_add_strategy_state_enhance_backtest_results.py
  </files>
  <action>
1. **Create src/core/models/strategy_state.py** (per SFWK-03): New ORM model StrategyStateRecord:
   ```python
   class StrategyStateRecord(Base):
       __tablename__ = "strategy_state"
       id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
       strategy_id: Mapped[str] = mapped_column(String(50), nullable=False, index=True)
       timestamp: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
       direction: Mapped[str] = mapped_column(String(10), nullable=False)  # LONG, SHORT, FLAT
       strength: Mapped[str] = mapped_column(String(10), nullable=False)
       confidence: Mapped[float] = mapped_column(Float, nullable=False)
       z_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
       raw_value: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
       suggested_size: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
       instruments: Mapped[Optional[list]] = mapped_column(JSONB, nullable=True)
       entry_level: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
       stop_loss: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
       take_profit: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
       holding_period_days: Mapped[Optional[int]] = mapped_column(Integer, nullable=True)
       metadata_json: Mapped[Optional[dict]] = mapped_column(JSONB, nullable=True)
       created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
   ```
   Add composite index on (strategy_id, timestamp DESC): `__table_args__ = (Index('ix_strategy_state_strat_ts', 'strategy_id', timestamp.desc()),)`

2. **Enhance src/core/models/backtest_results.py** (per SFWK-04): Add new columns to BacktestResultRecord. Since the table already exists with data, add columns as nullable:
   - `run_timestamp: Mapped[Optional[datetime]]` — DateTime(timezone=True), nullable=True
   - `params_json: Mapped[Optional[dict]]` — JSONB, nullable=True (strategy parameters used)
   - `daily_returns_json: Mapped[Optional[list]]` — JSONB, nullable=True (array of daily returns)
   - `avg_holding_days: Mapped[Optional[float]]` — Float, nullable=True
   - `num_trades: Mapped[Optional[int]]` — Integer, nullable=True (NOTE: distinct from total_trades which already exists -- BUT since total_trades already exists and serves same purpose, use total_trades. Instead add avg_holding_days only as new metric field)

   Actually, comparing SFWK-04 requirements against existing model: the existing model already has most fields. The NEW fields needed are: `run_timestamp`, `params_json`, `daily_returns_json`, `avg_holding_days`. The `num_trades` from the guide maps to the existing `total_trades`. Monthly returns already stored as monthly_returns JSONB. So add only the 4 truly new fields.

3. **Update src/core/models/__init__.py**: Add import for `strategy_state` module and `StrategyStateRecord` to __all__.

4. **Update alembic/env.py**: Add `strategy_state` to the model imports list (line ~15) so autogenerate picks up the new table. Also add `backtest_results` import if not already present.

5. **Create migration file** `alembic/versions/006_add_strategy_state_enhance_backtest_results.py` manually (NOT using autogenerate -- write it by hand for precision):
   - Revision ID: `e5f6g7h8i9j0`
   - Down revision: `005_create_pipeline_runs` (revision = the ID from that file, check it)
   - upgrade():
     a. Create strategy_state table with all columns and composite index
     b. Add 4 new columns to backtest_results: run_timestamp, params_json, daily_returns_json, avg_holding_days (all nullable, using op.add_column)
   - downgrade():
     a. Drop the 4 added columns from backtest_results
     b. Drop strategy_state table

   Read alembic/versions/005_create_pipeline_runs.py FIRST to get its revision ID for down_revision.
  </action>
  <verify>
    Run: `cd /home/user/Macro_Trading && python -c "
from src.core.models.strategy_state import StrategyStateRecord
from src.core.models.backtest_results import BacktestResultRecord
from src.core.models import StrategyStateRecord as SR2

# Verify strategy_state model
assert StrategyStateRecord.__tablename__ == 'strategy_state'
assert hasattr(StrategyStateRecord, 'z_score')
assert hasattr(StrategyStateRecord, 'instruments')

# Verify backtest_results v2 columns
assert hasattr(BacktestResultRecord, 'params_json')
assert hasattr(BacktestResultRecord, 'daily_returns_json')
assert hasattr(BacktestResultRecord, 'avg_holding_days')
assert hasattr(BacktestResultRecord, 'run_timestamp')

print('MODEL CHECKS PASSED')
"` && python -c "
# Verify migration file is syntactically valid
import importlib.util, sys
spec = importlib.util.spec_from_file_location('mig', 'alembic/versions/006_add_strategy_state_enhance_backtest_results.py')
mod = importlib.util.module_from_spec(spec)
print('MIGRATION SYNTAX OK')
"
  </verify>
  <done>StrategyStateRecord model exists with all SFWK-03 fields and (strategy_id, timestamp DESC) index. BacktestResultRecord has new v2 columns (run_timestamp, params_json, daily_returns_json, avg_holding_days) per SFWK-04. Migration file 006 creates strategy_state table and adds columns to backtest_results. Models registered in __init__.py and alembic/env.py.</done>
</task>

<task type="auto">
  <name>Task 3: Tests for StrategySignal, BaseStrategy utilities, and StrategyRegistry</name>
  <files>
    tests/test_strategies/test_base.py
    tests/test_strategies/test_registry.py
  </files>
  <action>
1. **Update tests/test_strategies/test_base.py**: ADD new test functions (do not remove existing tests). Read the file first to see what exists, then append:
   - `test_strategy_signal_creation`: Create StrategySignal with all required fields, assert z_score, raw_value, suggested_size are set, assert optional fields default to None.
   - `test_strategy_signal_with_optional_fields`: Create with entry_level=100.5, stop_loss=98.0, take_profit=105.0, holding_period_days=10, metadata={"model": "v2"}. Assert all set.
   - `test_compute_z_score_normal`: Create a concrete BaseStrategy subclass (MinimalStrategy) that implements generate_signals returning []. Call compute_z_score(105, [100,100,100,100,100], window=5). Mean=100, std=0 -> should return 0.0 (zero std guard). Then with [100,102,98,101,99], value=110 -> z > 0.
   - `test_compute_z_score_empty_history`: history=[] -> returns 0.0.
   - `test_compute_z_score_single_value`: history=[100] -> returns 0.0.
   - `test_size_from_conviction_zero`: z=0 -> returns 0.0.
   - `test_size_from_conviction_large`: z=5.0 -> close to max_size (>0.9).
   - `test_size_from_conviction_moderate`: z=1.0 -> between 0.3 and 0.8.
   - `test_classify_strength_strong`: z=2.5 -> STRONG.
   - `test_classify_strength_moderate`: z=1.5 -> MODERATE.
   - `test_classify_strength_weak`: z=0.7 -> WEAK.
   - `test_classify_strength_no_signal`: z=0.3 -> NO_SIGNAL.
   - `test_classify_strength_negative`: z=-2.5 -> STRONG (uses abs).

2. **Create tests/test_strategies/test_registry.py**: Test StrategyRegistry:
   - `test_register_decorator`: Use @StrategyRegistry.register("TEST_01", asset_class=AssetClass.FX) on a dummy strategy class. Assert "TEST_01" in StrategyRegistry.list_all(). Clean up after test by removing from _strategies.
   - `test_get_existing`: Register a dummy, call get("TEST_01"), assert returns the class.
   - `test_get_missing_raises`: Call get("NONEXISTENT"), assert raises KeyError.
   - `test_list_all_includes_existing_8`: Assert len >= 8, assert "RATES_BR_01" in list.
   - `test_list_by_asset_class`: Assert list_by_asset_class(AssetClass.FIXED_INCOME) returns at least ["RATES_BR_01", "RATES_BR_02", "RATES_BR_03", "RATES_BR_04"].
   - `test_instantiate_returns_instance`: Instantiate "RATES_BR_01" (may need to pass data_loader=None or mock), verify isinstance BaseStrategy. (Check the constructor signature of RatesBR01CarryStrategy first.)

   NOTE: Since existing strategies require a `data_loader` argument in their constructors, `instantiate` will need to accept **kwargs. The test for instantiate should pass the required args. For `instantiate_all`, it may fail for strategies needing constructor args -- document this as expected behavior (instantiate_all works for strategies with no-arg constructors or when default args suffice).

   Use pytest fixtures with cleanup to avoid polluting the registry between tests. Use a `@pytest.fixture(autouse=True)` that saves and restores _strategies state.
  </action>
  <verify>
    Run: `cd /home/user/Macro_Trading && python -m pytest tests/test_strategies/test_base.py tests/test_strategies/test_registry.py -v --tb=short 2>&1 | tail -30`
  </verify>
  <done>All tests pass. StrategySignal creation tests verify all SFWK-01 fields. BaseStrategy utility tests verify compute_z_score, size_from_conviction, classify_strength. Registry tests verify register decorator, get, list_all, list_by_asset_class with existing 8 strategies.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.strategies import StrategySignal, StrategyRegistry; print(len(StrategyRegistry.list_all()))"` outputs 8
2. `python -c "from src.core.models.strategy_state import StrategyStateRecord; print(StrategyStateRecord.__tablename__)"` outputs "strategy_state"
3. `python -m pytest tests/test_strategies/test_base.py tests/test_strategies/test_registry.py -v` -- all pass
4. Migration file exists and is syntactically valid Python
</verification>

<success_criteria>
- StrategySignal dataclass has all 15 fields specified in SFWK-01
- StrategyRegistry has all 6 methods specified in SFWK-02 and decorator-based registration works
- All 8 existing strategies are accessible via both ALL_STRATEGIES and StrategyRegistry
- strategy_state model has all SFWK-03 columns with (strategy_id, timestamp DESC) index
- backtest_results model has v2 columns (params_json, daily_returns_json, run_timestamp, avg_holding_days) per SFWK-04
- Alembic migration 006 creates strategy_state table and adds v2 columns to backtest_results
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-backtesting-engine-v2-strategy-framework/14-01-SUMMARY.md`
</output>
