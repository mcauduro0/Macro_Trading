---
phase: 13-pipeline-llm-dashboard-api-tests
plan: 03
type: execute
wave: 2
depends_on: [13-02]
files_modified:
  - src/api/static/dashboard.html
  - src/api/routes/dashboard.py
  - src/api/main.py
  - tests/test_api/test_dashboard.py
autonomous: true
requirements: [DASH-01, DASH-02, DASH-03, DASH-04, DASH-05]

must_haves:
  truths:
    - "GET /dashboard returns 200 with a self-contained HTML page"
    - "Dashboard has 4 horizontal tabs: Macro Dashboard, Agent Signals, Portfolio, Backtests"
    - "Macro Dashboard tab shows key indicators fetched from /api/v1/macro/dashboard"
    - "Agent Signals tab displays 5 agent cards with direction arrows (green/red/gray) and confidence bars"
    - "Portfolio tab shows positions table, VaR, leverage, and drawdown metrics"
    - "Backtests tab shows strategy results table and equity curve chart"
    - "Dashboard uses dark theme with Bloomberg-inspired styling"
  artifacts:
    - path: "src/api/static/dashboard.html"
      provides: "Single-file HTML dashboard with React + Tailwind + Recharts via CDN"
      contains: "React.createElement"
    - path: "src/api/routes/dashboard.py"
      provides: "FastAPI route serving the HTML dashboard"
      contains: "router"
    - path: "tests/test_api/test_dashboard.py"
      provides: "Tests for dashboard endpoint"
      min_lines: 20
  key_links:
    - from: "src/api/routes/dashboard.py"
      to: "src/api/static/dashboard.html"
      via: "FileResponse or HTMLResponse serving the HTML file"
      pattern: "FileResponse|HTMLResponse"
    - from: "src/api/main.py"
      to: "src/api/routes/dashboard.py"
      via: "app.include_router(dashboard.router)"
      pattern: "dashboard.router"
    - from: "src/api/static/dashboard.html"
      to: "/api/v1/"
      via: "fetch() calls to API endpoints for live data"
      pattern: "fetch.*api/v1"
---

<objective>
Build a Bloomberg-inspired single-file HTML dashboard served by FastAPI at GET /dashboard, with 4 tabs (Macro Dashboard, Agent Signals, Portfolio, Backtests) using React + Tailwind + Recharts via CDN.

Purpose: The dashboard provides a visual summary of the entire trading system state — macro indicators, agent consensus, portfolio positions, and backtest results — in a dense, information-rich format suitable for a trading desk.

Output: src/api/static/dashboard.html, src/api/routes/dashboard.py, updated main.py, dashboard tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-pipeline-llm-dashboard-api-tests/13-CONTEXT.md
@src/api/main.py
@src/api/routes/health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Single-file HTML dashboard with React + Tailwind + Recharts (4 tabs, dark theme)</name>
  <files>
    src/api/static/dashboard.html
  </files>
  <action>
Create a single self-contained HTML file that implements the full dashboard UI. All dependencies loaded via CDN (no build step required).

**CDN dependencies (loaded in `<head>`):**
- React 18 + ReactDOM (unpkg CDN)
- Babel standalone (for JSX transform in browser)
- Tailwind CSS (CDN play version)
- Recharts (unpkg CDN, UMD build)

**Tailwind config (inline `<script>`):**
Configure dark theme as default. Custom colors: `bg-gray-950` base, `green-500` for LONG, `red-500` for SHORT, `gray-500` for NEUTRAL. Monospace font for numbers (`font-mono`).

**React App structure (in `<script type="text/babel">`):**

1. **App component** — State: `activeTab` (default: "macro"). Renders header + tab bar + active tab content.

2. **Header** — "Macro Trading System" title, current date, manual refresh button (no auto-refresh per CONTEXT.md). Dark bar with monospace styling.

3. **TabBar** — 4 horizontal top tabs with equal prominence per CONTEXT.md:
   - "Macro Dashboard" (icon: chart)
   - "Agent Signals" (icon: signal)
   - "Portfolio" (icon: briefcase)
   - "Backtests" (icon: play)
   Active tab has accent border. All tabs visible at all times.

4. **MacroDashboard tab** — Fetches from `/api/v1/macro/dashboard` on mount.
   - Grid of indicator cards (3-4 columns on large screens, 1 on mobile)
   - Each card: indicator name, current value (large monospace), change indicator (green/red arrow + delta), last updated timestamp
   - Key indicators: Selic rate, IPCA YoY, USDBRL, IBOV, DI 1Y, VIX, US 10Y, CDS 5Y
   - Show loading skeleton while fetching, graceful error state if API unavailable

5. **AgentSignals tab** — Fetches from `/api/v1/agents` and `/api/v1/signals/latest` (these endpoints come from Plan 13-04; use mock/placeholder data if endpoints not yet available).
   - 5 agent cards in a grid (per CONTEXT.md: 5 agent cards with consensus view)
   - Each card: agent name, last run time, signal count badge
   - Per-signal rows inside card: signal_id, direction arrow (green up-arrow for LONG, red down-arrow for SHORT, gray dash for NEUTRAL per CONTEXT.md), strength text, confidence bar (horizontal bar 0-100%)
   - Consensus view at top: combined direction + confidence across all agents

6. **Portfolio tab** — Fetches from `/api/v1/portfolio/current` and `/api/v1/portfolio/risk`.
   - Positions table: columns = instrument, direction, weight (%), contributing strategy, last updated
   - Risk metrics panel: VaR 95% (large number), VaR 99%, leverage, max drawdown, circuit breaker status
   - Color coding: positive weights green, negative red

7. **Backtests tab** — Fetches from `/api/v1/strategies`.
   - Strategy results table: strategy_id, description, Sharpe ratio, annual return, max drawdown, win rate, status
   - Equity curve chart (Recharts LineChart): fetched from `/api/v1/strategies/{id}/backtest` for selected strategy
   - Strategy selector dropdown above the chart

**Data fetching pattern:**
- Each tab fetches on mount using `React.useEffect` + `fetch()`
- Manual refresh button re-fetches current tab's data
- Graceful error handling: show "Data unavailable — run daily pipeline first" message with gray styling
- Loading states: pulsing skeleton cards

**Visual style (Bloomberg-inspired per CONTEXT.md):**
- Background: `bg-gray-950` (near-black)
- Cards: `bg-gray-900` with `border-gray-800`
- Text: `text-gray-100` primary, `text-gray-400` secondary
- Numbers: `font-mono text-lg` for values
- Accent colors: `green-500` (LONG/positive), `red-500` (SHORT/negative), `amber-500` (alerts)
- Dense layout: minimal padding, compact cards, no unnecessary whitespace
- Headers: small caps, `text-gray-500`, letter-spacing
  </action>
  <verify>
ls -la src/api/static/dashboard.html  # file exists
grep -q 'React' src/api/static/dashboard.html  # uses React
grep -q 'tailwindcss' src/api/static/dashboard.html  # uses Tailwind
grep -q 'Recharts' src/api/static/dashboard.html  # uses Recharts
grep -q 'Macro Dashboard' src/api/static/dashboard.html  # has all 4 tabs
grep -q 'Agent Signals' src/api/static/dashboard.html
grep -q 'Portfolio' src/api/static/dashboard.html
grep -q 'Backtests' src/api/static/dashboard.html
  </verify>
  <done>
Single-file HTML dashboard exists with React + Tailwind + Recharts via CDN, 4 tabs (Macro Dashboard, Agent Signals, Portfolio, Backtests), Bloomberg-inspired dark theme, color-coded direction arrows, confidence bars, manual refresh only.
  </done>
</task>

<task type="auto">
  <name>Task 2: FastAPI route serving dashboard and tests</name>
  <files>
    src/api/routes/dashboard.py
    src/api/main.py
    tests/test_api/test_dashboard.py
  </files>
  <action>
**Dashboard route (`src/api/routes/dashboard.py`):**

Create a FastAPI router with a single endpoint:

```python
from fastapi import APIRouter
from fastapi.responses import FileResponse
from pathlib import Path

router = APIRouter(tags=["dashboard"])

DASHBOARD_HTML = Path(__file__).parent.parent / "static" / "dashboard.html"

@router.get("/dashboard", response_class=FileResponse)
async def get_dashboard():
    """Serve the single-page HTML dashboard."""
    return FileResponse(
        path=DASHBOARD_HTML,
        media_type="text/html",
    )
```

**Update main.py (`src/api/main.py`):**

1. Add import: `from src.api.routes import dashboard` (add to existing import line alongside health, macro, curves, market_data, flows)
2. Add router: `app.include_router(dashboard.router)` — mount at root level (no prefix), so /dashboard is served directly.

**Dashboard tests (`tests/test_api/test_dashboard.py`):**

Using FastAPI TestClient:

1. `test_dashboard_returns_200` — GET /dashboard returns 200 status.
2. `test_dashboard_returns_html` — Response content-type is text/html.
3. `test_dashboard_contains_react` — Response body contains "React" (confirming full HTML is served).
4. `test_dashboard_contains_all_tabs` — Response body contains "Macro Dashboard", "Agent Signals", "Portfolio", "Backtests".
5. `test_dashboard_dark_theme` — Response body contains "bg-gray-950" or equivalent dark theme indicators.

Use `from fastapi.testclient import TestClient` with `from src.api.main import app`.
  </action>
  <verify>
python -c "from src.api.routes.dashboard import router; print('Dashboard route OK')"
pytest tests/test_api/test_dashboard.py -v  # all tests pass
  </verify>
  <done>
GET /dashboard returns 200 with full HTML dashboard, main.py includes dashboard router, 5 dashboard tests pass confirming HTML content, tabs, and dark theme.
  </done>
</task>

</tasks>

<verification>
1. GET /dashboard returns 200 with HTML content via FastAPI TestClient
2. HTML file contains React, Tailwind, Recharts CDN references
3. All 4 tabs present: Macro Dashboard, Agent Signals, Portfolio, Backtests
4. Dark theme classes present in HTML
5. `pytest tests/test_api/test_dashboard.py -v` — all tests pass
</verification>

<success_criteria>
- Single-file HTML dashboard served at GET /dashboard
- 4 horizontal tabs: Macro Dashboard (indicators), Agent Signals (5 agent cards + consensus), Portfolio (positions + risk), Backtests (results table + equity curve)
- Bloomberg-inspired dark theme with monospace numbers, green/red accents
- Color-coded direction arrows (green LONG, red SHORT, gray NEUTRAL) with confidence bars
- Manual refresh only (no auto-refresh)
- React + Tailwind + Recharts via CDN (no build step)
- All dashboard tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-pipeline-llm-dashboard-api-tests/13-03-SUMMARY.md`
</output>
