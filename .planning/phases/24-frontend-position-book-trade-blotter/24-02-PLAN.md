---
phase: 24-frontend-position-book-trade-blotter
plan: 02
type: execute
wave: 2
depends_on:
  - 24-01
files_modified:
  - src/api/static/js/pms/pages/TradeBlotterPage.jsx
  - src/api/static/js/App.jsx
  - src/api/static/dashboard.html
autonomous: true
requirements:
  - PMS-FE-TB-01
  - PMS-FE-TB-02
  - PMS-FE-TB-03

must_haves:
  truths:
    - "Trade Blotter page shows pending proposals with conviction score, risk impact preview, and system rationale"
    - "Clicking Approve on a proposal opens a slide-out right panel with execution fields (price, notional, thesis, target, stop, time horizon)"
    - "Manager can modify size, price, stop/target directly in the approval form before confirming"
    - "Batch approve and batch reject work via checkboxes and top action buttons"
    - "History tab shows all past proposals with status badges, conviction, dates, and realized P&L"
    - "Status filtering and date range picker are available in the history tab"
  artifacts:
    - path: "src/api/static/js/pms/pages/TradeBlotterPage.jsx"
      provides: "Complete Trade Blotter page with pending proposals and history tabs"
      min_lines: 600
    - path: "src/api/static/js/App.jsx"
      provides: "PMS blotter route wired to TradeBlotterPage"
    - path: "src/api/static/dashboard.html"
      provides: "TradeBlotterPage.jsx script tag in correct load order"
  key_links:
    - from: "TradeBlotterPage.jsx"
      to: "/api/v1/pms/trades/proposals"
      via: "useFetch hook with 60s polling and status filter"
      pattern: "useFetch.*pms/trades/proposals"
    - from: "TradeBlotterPage.jsx"
      to: "/api/v1/pms/trades/proposals/{id}/approve"
      via: "fetch POST on approval form submit"
      pattern: "fetch.*proposals.*approve"
    - from: "TradeBlotterPage.jsx"
      to: "/api/v1/pms/trades/proposals/{id}/reject"
      via: "fetch POST on reject button click"
      pattern: "fetch.*proposals.*reject"
    - from: "App.jsx"
      to: "window.TradeBlotterPage"
      via: "Route element rendering"
      pattern: "TradeBlotterPage"
---

<objective>
Build the Trade Blotter page for the PMS -- a two-tab interface with pending trade proposals (approval workflow with slide-out panel, batch actions, expandable risk detail) and trade history (status filtering, date range, outcome tracking).

Purpose: Enable the portfolio manager to review, approve, reject, or modify system-generated trade proposals with full execution context and risk awareness -- the core decision-making screen.
Output: TradeBlotterPage.jsx component with route wiring in App.jsx and script loading in dashboard.html.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-frontend-position-book-trade-blotter/24-CONTEXT.md
@.planning/phases/23-frontend-design-system-morning-pack-page/23-01-SUMMARY.md
@.planning/phases/23-frontend-design-system-morning-pack-page/23-02-SUMMARY.md
@.planning/phases/24-frontend-position-book-trade-blotter/24-01-SUMMARY.md

Key references (read these before implementing):
@src/api/static/js/pms/theme.jsx           — PMS_COLORS, PMS_TYPOGRAPHY, PMS_SPACING, helper functions
@src/api/static/js/pms/components.jsx       — PMSCard, PMSTable, PMSBadge, PMSGauge, PMSLayout, PMSMetricCard
@src/api/static/js/pms/pages/MorningPackPage.jsx — PMS page pattern (sample data, useFetch, window globals, approve/reject flow)
@src/api/static/js/hooks.jsx                — useFetch hook
@src/api/static/js/App.jsx                  — Route wiring (updated by plan 24-01)
@src/api/static/dashboard.html              — Script loading order (updated by plan 24-01)
@src/api/routes/pms_trades.py               — API endpoints: proposals list, approve, reject, modify-approve
@src/api/schemas/pms_schemas.py             — TradeProposalResponse, ApproveProposalRequest, RejectProposalRequest, ModifyApproveRequest
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TradeBlotterPage.jsx with pending proposals and history tabs</name>
  <files>src/api/static/js/pms/pages/TradeBlotterPage.jsx</files>
  <action>
Create TradeBlotterPage.jsx as a single-file PMS page component following the MorningPackPage.jsx pattern (window globals, sample data fallback, useFetch polling).

**Data Fetching (2 endpoints, 60-second polling):**
- `useFetch('/api/v1/pms/trades/proposals?status=PENDING', 60000)` — pending proposals for the active tab
- `useFetch('/api/v1/pms/trades/proposals', 60000)` — all proposals for history tab
- Each endpoint has comprehensive SAMPLE_* constants for fallback

**Sample Data Constants:**
- `SAMPLE_PENDING_PROPOSALS` — 6 pending proposals with realistic data:
  - Each has: id, instrument, asset_class, direction, suggested_notional_brl, conviction (0.55-0.92), signal_source, strategy_ids, rationale (1-2 sentences), risk_impact ({var_before: X, var_after: Y, concentration_impact: Z, correlated_positions: []}), status: 'PENDING', created_at
  - Instruments: NTN-B 2030, USDBRL NDF 3M, DI1 Jan26, CDS BR 5Y, DDI Jan26, IBOV FUT
- `SAMPLE_HISTORY` — 15 historical proposals with mixed statuses:
  - Statuses: APPROVED (6, green), REJECTED (4, red), EXPIRED (2, gray), EXECUTED (3, blue)
  - Each has: id, instrument, direction, conviction, status, created_at, reviewed_at, execution_price (if approved), realized_pnl (if executed), notes

**Tab Navigation:**
- Two tabs at the top: "Pending Proposals" (default) and "History"
- useState for `activeTab` ('pending' | 'history')
- Tab styling: active tab has PMS_COLORS.border.accent bottom border, inactive has PMS_COLORS.text.muted color
- Counter badge on Pending tab showing number of pending proposals

**Tab 1: Pending Proposals**

*Batch Action Bar (top of list):*
- "Select All" checkbox + "Approve Selected" button (PMS_COLORS.pnl.positive bg) + "Reject Selected" button (PMS_COLORS.pnl.negative bg)
- Buttons disabled when no checkboxes selected
- useState for `selectedIds` (Set of proposal IDs)
- Batch approve: for each selected, call approve API with default execution values. Show progress count.
- Batch reject: prompt for single rejection reason via window.prompt, then call reject API for each

*Proposal Cards (one per proposal):*
- Layout: vertical list of proposal cards, each card is a PMS_COLORS.bg.secondary box with border
- Card header row: Instrument (bold) | Direction badge (PMSBadge variant positive/negative) | Asset Class (muted) | Checkbox (right-aligned)
- Card body: compact inline summary (visible by default):
  - Conviction: numeric score with convictionColor() background pill
  - Expected P&L: formatPnL() with color
  - Risk impact one-liner: "VaR impact: +X.XX% | Concentration: Y%"
  - Signal source and strategy IDs in muted text
- Rationale text: 1-2 lines, PMS_TYPOGRAPHY.sizes.sm, PMS_COLORS.text.secondary
- Expandable risk detail (locked decision): click "Risk Detail" link to toggle expanded section showing:
  - Portfolio VaR before/after
  - Concentration impact
  - Correlated positions list
  - Style: indented, PMS_COLORS.bg.tertiary bg
- useState for `expandedRiskId` (single proposal ID or null)
- Action buttons (bottom of card): "Approve" (green accent), "Reject" (red accent), "Detail" (muted)
  - Approve button: opens slide-out right panel (see below)
  - Reject button: calls reject API with notes from inline text field. Use a small inline notes input that appears on reject click, with "Confirm Reject" and "Cancel" buttons.
  - Detail button: scrolls to or highlights risk detail section

*Slide-Out Approval Panel (locked decision: right-side panel):*
- useState for `approvingProposal` (proposal object or null)
- Panel: fixed right, full-height, width ~400px, PMS_COLORS.bg.secondary background, shadow, z-index above content
- Backdrop: semi-transparent overlay on the left side
- Panel header: "Approve: {instrument}" with close (X) button
- Pre-filled from proposal: direction, suggested_notional_brl, conviction
- Editable fields (locked decision: manager can override directly):
  - Execution Price (number input, required)
  - Notional BRL (number input, pre-filled with suggested_notional_brl, editable)
  - Manager Thesis (textarea, optional)
  - Target Price (number input, optional)
  - Stop Loss (number input, optional)
  - Time Horizon (select: 1W, 2W, 1M, 3M, 6M, 1Y)
- Input styling: PMS_COLORS.bg.tertiary background, PMS_COLORS.border.default border, PMS text colors, PMS_TYPOGRAPHY.fontFamily
- Buttons: "Confirm Approval" (full-width, PMS_COLORS.pnl.positive bg), "Cancel" (text button)
- On submit: POST to /api/v1/pms/trades/proposals/{id}/approve with body {execution_price, execution_notional_brl, manager_thesis, target_price, stop_loss, time_horizon}
- On success: close panel, update proposal status in local state (optimistic UI), show brief success feedback
- On error: display error message in panel

**Tab 2: History**

*Filter Bar:*
- Status filter: dropdown/button group with options: All, APPROVED, REJECTED, EXPIRED, EXECUTED
- Date range: two date inputs (from/to) for filtering by created_at
- useState for `historyStatusFilter` and `historyDateRange`
- Apply filters client-side on the fetched proposals list

*History Table:*
- Columns (locked decision): Instrument | Direction | Status (badge) | Conviction | Proposed Date | Decision Date | Realized P&L (if executed)
- Status badges using color-coded PMSBadge: Green APPROVED, Red REJECTED, Gray EXPIRED (variant neutral), Blue EXECUTED (variant info)
- Sort by Proposed Date descending (most recent first)
- Pagination: show first 20 entries with "Load More" button (simple client-side pagination, not infinite scroll -- keeps it simple for the data volume expected)
- Direction: PMSBadge variant positive/negative
- Conviction: number with convictionColor() text
- Realized P&L: show only for EXECUTED status, use pnlColor() and formatPnL()
- Empty state: "No proposals match the selected filters"

**Window Global Exposure:**
```
window.TradeBlotterPage = TradeBlotterPage;
```

**Pattern Notes:**
- Access PMS theme via `window.PMS_THEME` destructured at top (same as MorningPackPage)
- Access React hooks via global `React` object
- Access useFetch via global `window.useFetch`
- All inline styles (no Tailwind classes for PMS-specific colors)
- Slide-out panel is pure CSS (position: fixed, right: 0, transition: transform) -- no library needed
  </action>
  <verify>
File exists at src/api/static/js/pms/pages/TradeBlotterPage.jsx with 600+ lines. File includes:
- SAMPLE_PENDING_PROPOSALS and SAMPLE_HISTORY constants
- useFetch calls to /api/v1/pms/trades/proposals (with and without status filter)
- Tab navigation (Pending / History)
- Proposal cards with conviction, risk preview, rationale
- Expandable risk detail section
- Slide-out right approval panel with execution fields
- Batch action bar with select-all, approve-selected, reject-selected
- Inline reject flow with notes input
- History table with status badges, filters, and pagination
- window.TradeBlotterPage export
  </verify>
  <done>
TradeBlotterPage.jsx renders two tabs: Pending Proposals (with proposal cards, batch actions, expandable risk detail, and slide-out approval panel) and History (with status-filtered table, date range, color-coded badges, and pagination). Approval form captures all execution fields. Sample data fallback ensures page works without backend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire TradeBlotterPage into App.jsx routes and dashboard.html</name>
  <files>src/api/static/js/App.jsx, src/api/static/dashboard.html</files>
  <action>
**App.jsx changes:**
1. In the AppContent component, add below the PositionBookPage resolution line (added by plan 24-01):
   ```
   const TradeBlotterPage = window.TradeBlotterPage;
   ```
2. Replace the PMS blotter placeholder route:
   - Change: `<Route path="/pms/blotter" element={<PMSPlaceholder title="Trade Blotter" />} />`
   - To: `<Route path="/pms/blotter" element={<TradeBlotterPage />} />`

**dashboard.html changes:**
1. Add a new script tag for TradeBlotterPage.jsx AFTER the PositionBookPage.jsx line (added by plan 24-01) and BEFORE Sidebar.jsx:
   ```
   <script type="text/babel" src="/static/js/pms/pages/TradeBlotterPage.jsx"></script>
   ```
   This goes between PositionBookPage.jsx and Sidebar.jsx to maintain the dependency order.

After these changes, the PMS pages script loading order in dashboard.html should be:
1. theme.jsx
2. components.jsx
3. MorningPackPage.jsx
4. PositionBookPage.jsx
5. TradeBlotterPage.jsx
6. Sidebar.jsx
7. (v3 pages)
8. App.jsx
  </action>
  <verify>
1. In App.jsx, grep for `TradeBlotterPage` — should appear in window resolution and Route element
2. In App.jsx, confirm no PMSPlaceholder for "Trade Blotter" remains
3. In dashboard.html, grep for `TradeBlotterPage.jsx` — should appear as a script tag
4. Script loading order: theme → components → MorningPackPage → PositionBookPage → TradeBlotterPage → Sidebar → ... → App
  </verify>
  <done>
TradeBlotterPage renders at /pms/blotter route when navigating via PMS sidebar. Script loads in correct order in dashboard.html. No placeholder remains for Trade Blotter.
  </done>
</task>

</tasks>

<verification>
1. TradeBlotterPage.jsx file exists at src/api/static/js/pms/pages/TradeBlotterPage.jsx with 600+ lines
2. App.jsx has Route for /pms/blotter pointing to TradeBlotterPage (not PMSPlaceholder)
3. dashboard.html has TradeBlotterPage.jsx script tag in correct order
4. File references window.PMS_THEME for all color/typography tokens
5. File uses useFetch hook for trade proposals endpoint with 60s polling
6. Sample data constants provide fallback for both pending and history data
7. Pending tab shows proposal cards with conviction, risk preview, rationale
8. Slide-out right panel captures all execution fields (price, notional, thesis, target, stop, time horizon)
9. Batch actions work (select multiple, approve/reject selected)
10. History tab shows status-filtered table with color-coded badges
11. No PMSPlaceholder references remain for "Position Book" or "Trade Blotter"
</verification>

<success_criteria>
- Trade Blotter page renders with two functional tabs (Pending and History)
- Pending proposals show conviction, risk impact, and rationale
- Slide-out approval panel captures execution details and submits to approve API
- Manager can override size/price/stop/target in approval form (modify-and-approve)
- Batch select with approve/reject all selected proposals
- Reject flow captures manager notes via inline input
- History tab filters by status and date range
- Status badges color-coded per PMS design system (Green/Red/Gray/Blue)
- All content styled with PMS_COLORS inline styles (Bloomberg-dense dark theme)
- Sample data fallback ensures page works without backend
</success_criteria>

<output>
After completion, create `.planning/phases/24-frontend-position-book-trade-blotter/24-02-SUMMARY.md`
</output>
