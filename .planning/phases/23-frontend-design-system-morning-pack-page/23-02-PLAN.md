---
phase: 23-frontend-design-system-morning-pack-page
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/api/static/js/pms/pages/MorningPackPage.jsx
  - src/api/static/js/App.jsx
  - src/api/static/dashboard.html
autonomous: true
requirements:
  - PMS-FE-MP-01
  - PMS-FE-MP-02

must_haves:
  truths:
    - "Morning Pack page shows a compact ticker strip of 10-15 market indicators with ticker name, current value, and color-coded daily change"
    - "Morning Pack page shows one card per analytical agent (5 total) with signal direction, confidence score (numeric, e.g. 0.85), key metric, and one-line rationale"
    - "Morning Pack page shows trade proposal cards grouped by agent, each displaying ticker, direction, size, conviction score, expected P&L, and one-line rationale"
    - "Trade proposal cards have inline quick-approve button for high-confidence proposals and click-through detail for flagged/lower-confidence proposals"
    - "Morning Pack page has sticky alert banner at top with severity-colored alerts and dismiss buttons"
    - "Morning Pack sections follow locked order: alerts -> market overview -> agent summaries -> trade proposals"
  artifacts:
    - path: "src/api/static/js/pms/pages/MorningPackPage.jsx"
      provides: "Complete Morning Pack page component with 4 sections"
      contains: "MorningPackPage"
      min_lines: 300
    - path: "src/api/static/js/App.jsx"
      provides: "MorningPackPage route wired to /pms/morning-pack"
      contains: "MorningPackPage"
    - path: "src/api/static/dashboard.html"
      provides: "Script tag loading MorningPackPage.jsx"
      contains: "MorningPackPage.jsx"
  key_links:
    - from: "src/api/static/js/pms/pages/MorningPackPage.jsx"
      to: "/api/v1/pms/morning-pack/latest"
      via: "useFetch hook for briefing data"
      pattern: "useFetch.*morning-pack"
    - from: "src/api/static/js/pms/pages/MorningPackPage.jsx"
      to: "/api/v1/pms/risk/live"
      via: "useFetch hook for risk alerts"
      pattern: "useFetch.*risk/live"
    - from: "src/api/static/js/pms/pages/MorningPackPage.jsx"
      to: "src/api/static/js/pms/components.jsx"
      via: "PMSCard, PMSMetricCard, PMSBadge, PMSAlertBanner imports"
      pattern: "PMSCard|PMSMetricCard|PMSBadge"
    - from: "src/api/static/js/pms/pages/MorningPackPage.jsx"
      to: "/api/v1/pms/trades/proposals/{id}/approve"
      via: "fetch POST for quick-approve action"
      pattern: "approve"
---

<objective>
Morning Pack page — the first operational PMS screen giving the portfolio manager a complete daily overview before markets open. Displays active alerts, market overview ticker strip, agent intelligence summaries, and actionable trade proposals with approve/reject flow.

Purpose: This is the most time-sensitive PMS page (locked decision: default landing page). It consolidates all system intelligence into a single Bloomberg-dense view so the manager can assess market conditions, review agent recommendations, and take action on trade proposals in minutes.

Output: MorningPackPage.jsx component consuming 3 API endpoints (morning-pack/latest, risk/live, trades/proposals) with 4 sections in locked order: alerts -> market overview -> agent summaries -> trade proposals.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-frontend-design-system-morning-pack-page/23-01-SUMMARY.md

@src/api/static/js/pms/theme.jsx
@src/api/static/js/pms/components.jsx
@src/api/static/js/App.jsx
@src/api/static/js/hooks.jsx
@src/api/routes/pms_briefing.py
@src/api/routes/pms_trades.py
@src/api/routes/pms_risk.py
@src/api/schemas/pms_schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Morning Pack page — alerts banner, market overview ticker strip, and agent summaries</name>
  <files>
    src/api/static/js/pms/pages/MorningPackPage.jsx
  </files>
  <action>
Create directory `src/api/static/js/pms/pages/` for PMS page components.

Create MorningPackPage.jsx — a single comprehensive page component using CDN-loaded React (no imports, access via window globals: `window.useFetch`, `window.PMS_THEME`, `window.PMSCard`, etc.).

The page fetches data from three API endpoints using `useFetch`:
1. `/api/v1/pms/morning-pack/latest` — main briefing data (market_snapshot, agent_views, trade_proposals, action_items, macro_narrative)
2. `/api/v1/pms/risk/live` — live risk data for alerts (var, leverage, drawdown, limits, alerts)
3. `/api/v1/pms/trades/proposals?status=pending` — pending trade proposals with full detail

Graceful fallback: if API returns error or null, display sample/placeholder data so the page always renders (consistent with existing dashboard pattern from Phase 19). Create sample data constants at the top of the file:

```javascript
const SAMPLE_MARKET_DATA = [
  { ticker: 'DI1F26', value: 14.25, change: -0.15, unit: '%' },
  { ticker: 'DI1F27', value: 13.80, change: -0.08, unit: '%' },
  { ticker: 'IBOV', value: 128450, change: 1.2, unit: 'pts' },
  { ticker: 'USD/BRL', value: 4.92, change: -0.35, unit: '' },
  { ticker: 'VIX', value: 18.5, change: 2.1, unit: '' },
  { ticker: 'UST 10Y', value: 4.35, change: 0.03, unit: '%' },
  { ticker: 'CDS BR 5Y', value: 145, change: -3, unit: 'bps' },
  { ticker: 'IPCA 12M', value: 4.62, change: 0.0, unit: '%' },
  { ticker: 'Selic', value: 13.75, change: 0.0, unit: '%' },
  { ticker: 'S&P 500', value: 5320, change: 0.45, unit: 'pts' },
  { ticker: 'DXY', value: 103.8, change: -0.2, unit: '' },
  { ticker: 'Brent', value: 82.5, change: 1.3, unit: 'USD' },
];

const SAMPLE_AGENTS = [
  { id: 'inflation', name: 'Inflation Agent', signal: 'LONG', confidence: 0.72, key_metric: 'IPCA 12M: 4.62% (above target)', rationale: 'Inflation persistence above BCB target suggests further NTN-B protection needed' },
  { id: 'monetary', name: 'Monetary Policy Agent', signal: 'SHORT', confidence: 0.68, key_metric: 'Selic-Taylor gap: -75bps', rationale: 'Market pricing 50bps cut cycle but Taylor rule suggests only 25bps appropriate' },
  { id: 'fiscal', name: 'Fiscal Agent', signal: 'NEUTRAL', confidence: 0.55, key_metric: 'Debt/GDP: 74.2%', rationale: 'Fiscal trajectory stable but primary balance deteriorating at margins' },
  { id: 'fx', name: 'FX Equilibrium Agent', signal: 'LONG', confidence: 0.78, key_metric: 'BEER misalignment: -4.2%', rationale: 'BRL undervalued vs BEER model with positive carry differential supporting appreciation' },
  { id: 'cross_asset', name: 'Cross-Asset Agent', signal: 'NEUTRAL', confidence: 0.61, key_metric: 'Regime: Reflation (0.65)', rationale: 'Goldilocks-to-Reflation transition, moderate risk appetite, cross-asset correlations stable' },
];
```

**Section 1: Alert Banner (sticky top)**
Use `PMSAlertBanner` component. Parse alerts from risk/live endpoint `data.alerts` array. Each alert has `severity` (ok/warning/breach) and `message`. If no alerts, banner is hidden. Sticky positioning at top of page content area (not fixed to viewport — stays within main content scroll).

**Section 2: Market Overview Ticker Strip (locked: "compact ticker strip for market overview")**
Horizontal scrollable row of `PMSMetricCard` components. Use data from briefing's `market_snapshot` section (or SAMPLE_MARKET_DATA fallback). Each card shows: ticker name (muted xs text), value (bold lg), daily change with directional arrow and color from `pnlColor()`. Dense layout: flex row with gap of 8px, overflow-x auto for horizontal scroll. The strip should feel like a Bloomberg-style data ribbon. Apply Bloomberg-dense styling: minimal vertical height (~60px per card), no unnecessary padding.

**Section 3: Agent Summaries (locked: "one card per agent")**
Grid of 5 `PMSCard` components, one per analytical agent. Use agent data from briefing's `agent_views` section (or SAMPLE_AGENTS fallback). Each agent card uses the agent's accent color from `PMS_COLORS.agent[id]` as left border.

Card internal layout:
- Header row: Agent name (semibold, sm) + signal direction badge (`PMSBadge` with directionColor)
- Confidence score as numeric value (e.g., "0.72") with color from convictionColor() (locked: "numeric conviction score, not bar gauges")
- Key metric line (muted secondary text, xs)
- One-line rationale (text.secondary, xs, max 2 lines with overflow ellipsis)

Agent cards must be visually distinct from trade proposal cards (locked specific idea). Use PMS_COLORS.agent accent colors and slightly different card treatment (left accent border).

Grid layout: 2-3 columns responsive (use CSS grid, 2 columns on medium screens, 3 on large). Gap of PMS_SPACING.md.

**Loading state:**
While any fetch is loading, show `PMSSkeleton` placeholders for each section. Use skeleton heights matching the expected content (ticker strip: 60px, agent cards: 120px each).

Expose on window: `window.MorningPackPage = MorningPackPage`.
  </action>
  <verify>
```bash
ls -la src/api/static/js/pms/pages/MorningPackPage.jsx
wc -l src/api/static/js/pms/pages/MorningPackPage.jsx
grep "MorningPackPage" src/api/static/js/pms/pages/MorningPackPage.jsx | head -3
grep "PMSCard\|PMSMetricCard\|PMSBadge\|PMSAlertBanner" src/api/static/js/pms/pages/MorningPackPage.jsx | wc -l
```
File exists, > 200 lines, uses PMS component library.
  </verify>
  <done>
MorningPackPage renders 3 sections (alerts, market overview ticker strip, agent summaries) using PMS component library. Fetches from /api/v1/pms/morning-pack/latest and /api/v1/pms/risk/live. Falls back to sample data when API unavailable. Agent cards show signal direction badge, numeric confidence score, key metric, and rationale with per-agent accent colors. Market overview is a compact horizontal ticker strip with 10-15 indicators.
  </done>
</task>

<task type="auto">
  <name>Task 2: Trade proposal section, approve/reject actions, page wiring, and dashboard.html integration</name>
  <files>
    src/api/static/js/pms/pages/MorningPackPage.jsx
    src/api/static/js/App.jsx
    src/api/static/dashboard.html
  </files>
  <action>
**MorningPackPage.jsx** — Add Section 4 (trade proposals) to the existing component:

**Section 4: Trade Proposals (locked: "grouped by agent", "hybrid approve/reject flow")**

Add sample proposals data constant:
```javascript
const SAMPLE_PROPOSALS = [
  { id: 'tp-1', agent: 'inflation', instrument: 'NTN-B 2030', direction: 'LONG', suggested_size: 15000000, conviction: 0.82, expected_pnl: 45000, rationale: 'IPCA persistence above target, breakeven underpriced vs model', status: 'pending' },
  { id: 'tp-2', agent: 'fx', instrument: 'USD/BRL NDF 3M', direction: 'SHORT', suggested_size: 20000000, conviction: 0.75, expected_pnl: 62000, rationale: 'BRL undervalued per BEER, positive carry, flow momentum supportive', status: 'pending' },
  { id: 'tp-3', agent: 'monetary', instrument: 'DI1 Jan26', direction: 'LONG', suggested_size: 10000000, conviction: 0.68, expected_pnl: 28000, rationale: 'Market overpricing easing cycle, Taylor gap supports receiver position', status: 'pending' },
  { id: 'tp-4', agent: 'cross_asset', instrument: 'IBOV FUT', direction: 'LONG', suggested_size: 8000000, conviction: 0.58, expected_pnl: 18000, rationale: 'Reflation regime favors equities, risk appetite moderate-positive', status: 'pending' },
  { id: 'tp-5', agent: 'fiscal', instrument: 'CDS BR 5Y', direction: 'SHORT', suggested_size: 5000000, conviction: 0.52, expected_pnl: 12000, rationale: 'Fiscal metrics stable, spread compression expected on improved primary balance', status: 'pending' },
];
```

Use proposals from `/api/v1/pms/trades/proposals?status=pending` endpoint (or SAMPLE_PROPOSALS fallback).

Group proposals by agent (locked decision). For each agent group, render a section header with agent name and accent color. Under each group, render proposal cards.

**Trade Proposal Card design (locked: "full context inline"):**
Each card is NOT a PMSCard (visually distinct from agent cards per locked specific idea). Use a different treatment: no left accent border, slightly different background (PMS_COLORS.bg.tertiary), with a subtle bottom border between cards.

Card layout (dense, Bloomberg-style):
- Top row: instrument ticker (bold, base size) + direction badge (PMSBadge with directionColor) + conviction score (numeric, color-coded)
- Middle row: size (formatted as notional, e.g. "BRL 15M") + expected P&L (formatted with pnlColor, e.g. "+R$ 45K")
- Bottom row: one-line rationale (text.secondary, xs)
- Action row (right-aligned):
  - If conviction >= 0.70 (high confidence): show inline "Quick Approve" button (green, small). Clicking sends POST to `/api/v1/pms/trades/proposals/{id}/approve` with `{ execution_price: null, execution_notional: null, notes: "Quick approved from Morning Pack" }`, then marks card as approved with visual feedback (green border flash, "Approved" badge).
  - Always show "Details" button (muted, small) that could open a detail panel (for now, show an alert or console.log with the proposal ID — full detail panel built in Phase 24).
  - Show "Reject" button (red outline, small). Clicking sends POST to `/api/v1/pms/trades/proposals/{id}/reject` with `{ notes: "" }` after optional prompt for reason (use window.prompt for simplicity — proper modal in Phase 24).

**Approve/reject state management:**
Use local React state to track proposal statuses. After successful POST, update the card appearance:
- Approved: green left border, "APPROVED" badge, disable buttons
- Rejected: red strikethrough, "REJECTED" badge, disable buttons
- Error: show red error text below the card temporarily

If the API POST fails (e.g., 404, 500), gracefully show the error but don't crash. Use try/catch around fetch calls.

**Formatting helpers for proposals:**
- `formatNotional(value)` — e.g., 15000000 -> "BRL 15.0M", 500000 -> "BRL 500K"
- `formatExpectedPnL(value)` — e.g., 45000 -> "+R$ 45K" with green, -12000 -> "-R$ 12K" with red

**App.jsx** — Replace the MorningPackPage placeholder:

In Plan 01, the `/pms/morning-pack` route used `<PMSPlaceholder title="Morning Pack" />`. Update it to use `<MorningPackPage />` now that the real component exists. Since MorningPackPage is exposed on `window.MorningPackPage`, reference it directly.

**dashboard.html** — Add MorningPackPage script tag:

Add after components.jsx but before App.jsx:
```html
<script type="text/babel" src="/static/js/pms/pages/MorningPackPage.jsx"></script>
```

Ensure the loading order is: hooks.jsx -> pms/theme.jsx -> pms/components.jsx -> pms/pages/MorningPackPage.jsx -> Sidebar.jsx -> pages/* -> App.jsx.
  </action>
  <verify>
1. Trade proposals section exists in MorningPackPage:
```bash
grep -c "SAMPLE_PROPOSALS\|proposal\|approve\|reject" src/api/static/js/pms/pages/MorningPackPage.jsx
```
Should be >= 10 occurrences.

2. MorningPackPage is wired in App.jsx:
```bash
grep "MorningPackPage" src/api/static/js/App.jsx
```
Should show route element using MorningPackPage (not PMSPlaceholder).

3. Script loading in dashboard.html:
```bash
grep "MorningPackPage" src/api/static/dashboard.html
```
Should show the script tag.

4. Full page line count:
```bash
wc -l src/api/static/js/pms/pages/MorningPackPage.jsx
```
Should be > 350 lines (4 sections + sample data + helpers).
  </verify>
  <done>
Morning Pack page has all 4 sections in locked order: (1) sticky alert banner with severity-colored alerts, (2) compact market overview ticker strip with 10-15 indicators, (3) agent summaries with one card per agent showing signal/confidence/metric/rationale, (4) trade proposals grouped by agent with inline quick-approve for high-confidence (>= 0.70) proposals, detail and reject buttons. Approve/reject sends POST to PMS API with visual feedback. MorningPackPage wired to /pms/morning-pack route in App.jsx and loaded in dashboard.html.
  </done>
</task>

</tasks>

<verification>
1. MorningPackPage.jsx exists with all 4 sections:
```bash
grep -c "Section\|SAMPLE_\|alert\|ticker\|agent\|proposal" src/api/static/js/pms/pages/MorningPackPage.jsx
```

2. Page uses PMS design system:
```bash
grep "PMS_COLORS\|PMS_THEME\|PMSCard\|PMSMetricCard\|PMSBadge\|PMSAlertBanner" src/api/static/js/pms/pages/MorningPackPage.jsx | wc -l
```
Should show 10+ references to PMS theme/components.

3. API endpoints consumed:
```bash
grep "api/v1/pms" src/api/static/js/pms/pages/MorningPackPage.jsx
```
Should show morning-pack/latest, risk/live, and trades/proposals endpoints.

4. Approve/reject actions:
```bash
grep "approve\|reject" src/api/static/js/pms/pages/MorningPackPage.jsx | wc -l
```
Should show 5+ references.

5. Route wired in App.jsx:
```bash
grep "MorningPackPage" src/api/static/js/App.jsx
```

6. Script loading order in dashboard.html:
```bash
grep -n "\.jsx" src/api/static/dashboard.html
```
Should show: hooks -> pms/theme -> pms/components -> pms/pages/MorningPackPage -> Sidebar -> pages/* -> App.
</verification>

<success_criteria>
- Morning Pack page renders 4 sections in locked order: alerts -> market overview -> agent summaries -> trade proposals
- Ticker strip shows 10-15 market indicators in compact horizontal row with color-coded changes
- 5 agent cards with per-agent accent color, signal direction badge, numeric conviction score, key metric, and rationale
- Trade proposals grouped by agent with full context inline (ticker, direction, size, conviction, expected P&L, rationale)
- High-confidence proposals (conviction >= 0.70) have inline quick-approve button
- All proposals have detail and reject buttons
- Approve/reject POST to PMS API with visual state feedback
- Graceful fallback to sample data when API unavailable
- All PMS components use Bloomberg-dense dark theme from PMS design system
</success_criteria>

<output>
After completion, create `.planning/phases/23-frontend-design-system-morning-pack-page/23-02-SUMMARY.md`
</output>
