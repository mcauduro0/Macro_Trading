---
phase: 18-dagster-orchestration-monitoring-reporting
plan: 02
type: execute
wave: 2
depends_on:
  - 18-01
files_modified:
  - src/orchestration/assets_signals.py
  - src/orchestration/assets_portfolio.py
  - src/orchestration/assets_risk.py
  - src/orchestration/assets_report.py
  - src/orchestration/definitions.py
autonomous: true
requirements:
  - ORCH-02

must_haves:
  truths:
    - "Dagster asset graph shows the full pipeline: Bronze -> Silver -> Agents -> Signals -> Portfolio -> Risk -> Report in dependency order"
    - "Signal assets depend on Agent assets and wrap SignalAggregatorV2"
    - "Portfolio assets depend on Signal assets and wrap Black-Litterman + PositionSizer"
    - "Risk assets depend on Portfolio assets and wrap VaRCalculator + StressTester + RiskLimitsManager"
    - "Report asset depends on all upstream assets and wraps DailyReportGenerator (placeholder for 18-04)"
    - "All assets visible in dagster-webserver UI as a connected dependency graph"
  artifacts:
    - path: "src/orchestration/assets_signals.py"
      provides: "Signal aggregation Dagster assets"
      min_lines: 60
    - path: "src/orchestration/assets_portfolio.py"
      provides: "Portfolio optimization Dagster assets"
      min_lines: 60
    - path: "src/orchestration/assets_risk.py"
      provides: "Risk engine Dagster assets"
      min_lines: 60
    - path: "src/orchestration/assets_report.py"
      provides: "Daily report Dagster asset (placeholder for 18-04 generator)"
      min_lines: 30
    - path: "src/orchestration/definitions.py"
      provides: "Updated Definitions with all assets registered"
      contains: "assets_signals"
  key_links:
    - from: "src/orchestration/assets_signals.py"
      to: "src/portfolio/signal_aggregator.py"
      via: "SignalAggregatorV2 import"
      pattern: "SignalAggregatorV2"
    - from: "src/orchestration/assets_portfolio.py"
      to: "src/portfolio/"
      via: "BlackLitterman, PositionSizer imports"
      pattern: "from src\\.portfolio"
    - from: "src/orchestration/assets_risk.py"
      to: "src/risk/"
      via: "VaRCalculator, StressTester imports"
      pattern: "from src\\.risk"
    - from: "src/orchestration/definitions.py"
      to: "src/orchestration/assets_*.py"
      via: "all_assets list aggregation"
      pattern: "all_assets"
---

<objective>
Extend the Dagster orchestration with downstream pipeline assets: Signal aggregation, Portfolio optimization, Risk computation, and Daily Report generation. These complete the full dependency graph from Bronze data ingestion through to final report output.

Purpose: The full pipeline dependency graph enables Dagster to orchestrate the entire daily workflow (data -> transforms -> agents -> signals -> portfolio -> risk -> report) with proper dependency management, retries, and partial re-execution.

Output: 4 new asset modules completing the pipeline, updated Definitions module with all assets registered.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-dagster-orchestration-monitoring-reporting/18-01-SUMMARY.md
@src/orchestration/definitions.py
@src/portfolio/signal_aggregator.py
@src/risk/var_calculator.py
@src/risk/stress_tester.py
@src/risk/risk_limits_v2.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Signal, Portfolio, Risk, and Report Dagster asset definitions</name>
  <files>
    src/orchestration/assets_signals.py
    src/orchestration/assets_portfolio.py
    src/orchestration/assets_risk.py
    src/orchestration/assets_report.py
  </files>
  <action>
Create 4 new asset modules that extend the pipeline downstream from Agents.

**src/orchestration/assets_signals.py**: Define Signal-layer Dagster assets:

1. `signal_aggregation` — depends on all 5 agent assets (`agent_inflation`, `agent_monetary_policy`, `agent_fiscal`, `agent_fx_equilibrium`, `agent_cross_asset`). Wraps `SignalAggregatorV2.aggregate()` with Bayesian method (default per Phase 17 decision). Returns dict with aggregated signal count, methods used, and crowding/staleness metadata.

2. `signal_monitor` — depends on `signal_aggregation`. Wraps `SignalMonitor` to detect flips, surges, and divergence. Returns dict with `{flips: N, surges: N, divergences: N, summary: str}`.

Both assets use `@asset(group_name="signals")` with `RetryPolicy(max_retries=3, delay=30)`. Assets receive `context: AssetExecutionContext` for logging. Use `DailyPartitionsDefinition(start_date="2010-01-01")`.

**src/orchestration/assets_portfolio.py**: Define Portfolio-layer assets:

1. `portfolio_optimization` — depends on `signal_aggregation` and `agent_cross_asset` (for BL views). Wraps `PortfolioOptimizer.optimize_with_bl()` combining Black-Litterman posterior with mean-variance optimization. Returns dict with target weights, instruments, and optimization metadata.

2. `portfolio_sizing` — depends on `portfolio_optimization`. Wraps `PositionSizer.size_portfolio()` with vol_target method. Returns dict with sized positions and strategy attribution.

Both use `@asset(group_name="portfolio")`.

**src/orchestration/assets_risk.py**: Define Risk-layer assets:

1. `risk_var` — depends on `portfolio_sizing`. Wraps `VaRCalculator` computing parametric and Monte Carlo VaR at 95% and 99% confidence levels, plus marginal/component VaR decomposition. Returns VaR results dict.

2. `risk_stress` — depends on `portfolio_sizing`. Wraps `StressTester.run_all_v2()` running all 6 scenarios + reverse stress + historical replay. Returns stress test results dict.

3. `risk_limits` — depends on `portfolio_sizing`, `risk_var`. Wraps `RiskLimitsManagerV2.check_all_v2()` checking all 9 limits and risk budget. Returns limits utilization dict with overall status (OK/WARNING/BREACHED).

All use `@asset(group_name="risk")`.

**src/orchestration/assets_report.py**: Define Report-layer asset:

1. `daily_report` — depends on `signal_monitor`, `portfolio_sizing`, `risk_var`, `risk_stress`, `risk_limits`. This is a placeholder asset that collects outputs from all upstream assets and prepares the context dict for the DailyReportGenerator (which will be implemented in Plan 18-04). For now, it assembles the pipeline results into a structured dict with sections: market_snapshot, regime, agent_views, signals, portfolio, risk, actions. Returns `{"status": "report_context_ready", "sections": 7}`.

Uses `@asset(group_name="report")`.

All asset functions follow the same pattern established in 18-01: try/except wrapping, context.log logging, status dict return. Each function body should be 15-30 lines wrapping the existing business logic modules.
  </action>
  <verify>
Run `python -c "from src.orchestration.assets_signals import *; from src.orchestration.assets_portfolio import *; from src.orchestration.assets_risk import *; from src.orchestration.assets_report import *; print('All downstream asset modules import OK')"` — must succeed.
  </verify>
  <done>
2 Signal assets, 2 Portfolio assets, 3 Risk assets, and 1 Report asset defined as Dagster @asset functions with correct dependency chains connecting to upstream Bronze/Silver/Agent assets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Definitions module with complete asset graph</name>
  <files>
    src/orchestration/definitions.py
  </files>
  <action>
Update `src/orchestration/definitions.py` to register all new assets:

1. Add imports for all 8 new asset functions from the 4 new modules:
   - `from src.orchestration.assets_signals import signal_aggregation, signal_monitor`
   - `from src.orchestration.assets_portfolio import portfolio_optimization, portfolio_sizing`
   - `from src.orchestration.assets_risk import risk_var, risk_stress, risk_limits`
   - `from src.orchestration.assets_report import daily_report`

2. Extend the `all_assets` list to include all 22 assets total (14 from 18-01 + 8 new):
   ```python
   all_assets = [
       # Bronze (6)
       bronze_bcb_sgs, bronze_fred, bronze_yahoo,
       bronze_bcb_ptax, bronze_b3_market_data, bronze_treasury_gov,
       # Silver (3)
       silver_curves, silver_returns, silver_macro,
       # Agents (5)
       agent_inflation, agent_monetary_policy, agent_fiscal,
       agent_fx_equilibrium, agent_cross_asset,
       # Signals (2)
       signal_aggregation, signal_monitor,
       # Portfolio (2)
       portfolio_optimization, portfolio_sizing,
       # Risk (3)
       risk_var, risk_stress, risk_limits,
       # Report (1)
       daily_report,
   ]
   ```

3. Update `daily_pipeline_job` selection to include all 22 assets.

4. The `daily_schedule` remains at 09:00 UTC (06:00 BRT) per user decision.

5. Add a `bronze_only_job` for selective Bronze-only materialization:
   ```python
   bronze_assets = [
       bronze_bcb_sgs, bronze_fred, bronze_yahoo,
       bronze_bcb_ptax, bronze_b3_market_data, bronze_treasury_gov,
   ]
   bronze_job = define_asset_job(
       name="bronze_ingest",
       selection=bronze_assets,
       description="Ingest Bronze layer data only",
   )
   ```

6. Register the additional job in Definitions:
   ```python
   defs = Definitions(
       assets=all_assets,
       schedules=[daily_schedule],
       jobs=[daily_pipeline_job, bronze_job],
   )
   ```
  </action>
  <verify>
Run `python -c "from src.orchestration.definitions import defs; keys = defs.get_asset_graph().all_asset_keys; print(f'Total assets: {len(keys)}'); assert len(keys) == 22, f'Expected 22, got {len(keys)}'; print('Full pipeline graph OK')"` — must show 22 assets.
  </verify>
  <done>
Dagster Definitions module registers all 22 assets (6 Bronze + 3 Silver + 5 Agents + 2 Signals + 2 Portfolio + 3 Risk + 1 Report) with complete dependency graph visible in dagster-webserver UI. Two jobs available: full daily pipeline and Bronze-only ingest. Daily schedule at 06:00 BRT.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.orchestration.definitions import defs; print(f'Assets: {len(defs.get_asset_graph().all_asset_keys)}')"` shows 22
2. The dependency graph flows: Bronze -> Silver -> Agents -> Signals -> Portfolio -> Risk -> Report
3. All imports resolve cleanly
</verification>

<success_criteria>
- 22 total Dagster assets cover the full pipeline from data ingestion to daily report
- Dependency graph is correct: downstream assets only depend on their actual upstream data providers
- Signal assets connect to SignalAggregatorV2 and SignalMonitor from Phase 17
- Portfolio assets connect to PortfolioOptimizer and PositionSizer from Phase 17
- Risk assets connect to VaRCalculator, StressTester, and RiskLimitsManagerV2 from Phase 17
- Report asset collects all upstream outputs into a structured context dict
</success_criteria>

<output>
After completion, create `.planning/phases/18-dagster-orchestration-monitoring-reporting/18-02-SUMMARY.md`
</output>
