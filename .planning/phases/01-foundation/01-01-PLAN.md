---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .gitignore
  - .env.example
  - .env
  - Makefile
  - docker-compose.yml
  - src/__init__.py
  - src/core/__init__.py
  - src/core/config.py
  - src/core/enums.py
  - src/connectors/__init__.py
  - src/transforms/__init__.py
  - src/api/__init__.py
autonomous: true
requirements:
  - INFRA-01
  - INFRA-05

must_haves:
  truths:
    - "docker compose up -d brings up TimescaleDB, Redis, MongoDB, and MinIO with all 4 services reporting healthy (Kafka starts only with --profile full)"
    - "docker compose --profile full up -d additionally brings up Kafka with healthy status"
    - "python -c 'from src.core.config import settings' succeeds and settings object loads all service URLs from .env"
    - "Configuration resolves async_database_url, sync_database_url, redis_url, and mongo_url as computed fields"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Full infrastructure stack with health checks for all 5 services"
      contains: "timescaledb"
    - path: "src/core/config.py"
      provides: "Pydantic-settings configuration with .env support and computed URL fields"
      contains: "class Settings"
    - path: "src/core/enums.py"
      provides: "Shared enumerations for AssetClass, Frequency, Country, etc."
      contains: "class AssetClass"
    - path: "pyproject.toml"
      provides: "Project metadata and all Python dependencies"
      contains: "sqlalchemy"
    - path: ".env.example"
      provides: "Template for environment variables"
      contains: "POSTGRES_HOST"
    - path: "Makefile"
      provides: "Development workflow shortcuts (up, down, migrate, etc.)"
      contains: "docker compose"
  key_links:
    - from: "docker-compose.yml"
      to: ".env"
      via: "Environment variable defaults match between Docker and .env"
      pattern: "POSTGRES_USER.*macro_user"
    - from: "src/core/config.py"
      to: ".env"
      via: "pydantic-settings loads .env file automatically"
      pattern: "env_file.*\\.env"
---

<objective>
Create the project scaffolding, Docker Compose infrastructure stack, and pydantic-settings configuration for the Macro Trading system.

Purpose: Establish the foundational project structure and running infrastructure that all subsequent plans depend on. Without Docker services running and configuration loading, no database work or application code can proceed.

Output: A working Docker Compose stack with 5 services (TimescaleDB, Redis, MongoDB, Kafka, MinIO), project directory structure with all packages, pydantic-settings config loading from .env, shared enumerations, and development workflow via Makefile.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffolding and directory structure</name>
  <files>
    pyproject.toml
    .gitignore
    .env.example
    .env
    src/__init__.py
    src/core/__init__.py
    src/connectors/__init__.py
    src/transforms/__init__.py
    src/api/__init__.py
  </files>
  <action>
    Create the full project scaffolding:

    **pyproject.toml:**
    - Project name: `macro-trading`, Python >=3.11
    - Dependencies (pin minimum versions from RESEARCH.md):
      - `sqlalchemy>=2.0.36`
      - `asyncpg>=0.30.0`
      - `psycopg2-binary>=2.9.10`
      - `alembic>=1.14.0`
      - `pydantic-settings>=2.7.0`
      - `pydantic>=2.10.0`
      - `redis[hiredis]>=5.2.0`
      - `python-dotenv>=1.0.1`
      - `structlog>=24.4.0`
    - Dev dependencies group: `pytest`, `ruff`, `pytest-asyncio`
    - Include `[tool.ruff]` config with line-length=120, target Python 3.11

    **Directory structure:**
    - `src/__init__.py` (empty)
    - `src/core/__init__.py` (empty)
    - `src/connectors/__init__.py` (empty, placeholder for Phase 2)
    - `src/transforms/__init__.py` (empty, placeholder for Phase 5)
    - `src/api/__init__.py` (empty, placeholder for Phase 6)

    **.gitignore:**
    - Standard Python ignores (__pycache__, *.pyc, .venv, dist/, *.egg-info)
    - .env (NOT .env.example)
    - IDE files (.vscode/, .idea/)
    - Docker volumes if local

    **.env.example:**
    - All environment variables with default dev values (matching docker-compose.yml defaults):
      POSTGRES_HOST=localhost, POSTGRES_PORT=5432, POSTGRES_DB=macro_trading, POSTGRES_USER=macro_user, POSTGRES_PASSWORD=macro_pass
      REDIS_HOST=localhost, REDIS_PORT=6379, REDIS_DB=0
      MONGO_HOST=localhost, MONGO_PORT=27017, MONGO_USER=macro_user, MONGO_PASSWORD=macro_pass, MONGO_DB=macro_trading
      MINIO_HOST=localhost, MINIO_PORT=9000, MINIO_ACCESS_KEY=minio_user, MINIO_SECRET_KEY=minio_pass, MINIO_BUCKET=macro-data
      KAFKA_BOOTSTRAP_SERVERS=localhost:9092
      FRED_API_KEY= (empty, user fills in)
      DEBUG=false

    **.env:**
    - Copy of .env.example with same dev defaults (so the project works out of the box locally)

    **Key conventions:**
    - All `__init__.py` files are empty (no re-exports yet; those come when modules are created)
    - The `src/` directory is the Python package root
  </action>
  <verify>
    Run: `python -c "import src; import src.core; print('Package structure OK')"`
    Run: `ls pyproject.toml .gitignore .env.example .env src/__init__.py src/core/__init__.py`
    Both commands succeed without errors.
  </verify>
  <done>
    pyproject.toml exists with all 9 core dependencies. Directory structure has src/core/, src/connectors/, src/transforms/, src/api/ packages. .env.example and .env exist with all service connection variables. .gitignore excludes .env and Python artifacts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Docker Compose stack, pydantic-settings config, and development Makefile</name>
  <files>
    docker-compose.yml
    Makefile
    src/core/config.py
    src/core/enums.py
  </files>
  <action>
    **docker-compose.yml** -- Follow the exact specification from RESEARCH.md (Docker Compose section):
    - `timescaledb` service: image `timescale/timescaledb:2.18.0-pg16`, port 5432, env vars (POSTGRES_DB/USER/PASSWORD=macro_trading/macro_user/macro_pass), named volume `timescaledb_data`, health check via `pg_isready -U macro_user -d macro_trading` with start_period 30s, restart unless-stopped
    - `redis` service: image `redis:7-alpine`, port 6379, named volume `redis_data`, command `redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru`, health check via `redis-cli ping`, restart unless-stopped
    - `mongodb` service: image `mongo:8.0`, port 27017, env vars (MONGO_INITDB_ROOT_USERNAME/PASSWORD=macro_user/macro_pass), named volume `mongodb_data`, health check via `mongosh --eval "db.adminCommand('ping')"` with start_period 20s, restart unless-stopped
    - `kafka` service: image `confluentinc/cp-kafka:7.8.0`, port 9092, KRaft mode config (NODE_ID=1, PROCESS_ROLES=broker,controller, CONTROLLER_QUORUM_VOTERS=1@kafka:9093, all listener config), named volume `kafka_data`, health check via `kafka-broker-api-versions`, **profiles: [full]** (only starts with --profile full), restart unless-stopped
    - `minio` service: image `quay.io/minio/minio:RELEASE.2025-02-18T16-25-55Z`, ports 9000+9001, env vars (MINIO_ROOT_USER/PASSWORD=minio_user/minio_pass), command `server /data --console-address ":9001"`, named volume `minio_data`, health check via `mc ready local`, restart unless-stopped
    - Declare all 5 named volumes at bottom
    - Do NOT use `version: "3.9"` key (deprecated in modern Docker Compose)

    **src/core/config.py** -- Follow RESEARCH.md pydantic-settings pattern exactly:
    - `class Settings(BaseSettings)` with `SettingsConfigDict(env_file=".env", env_file_encoding="utf-8", env_nested_delimiter="__", case_sensitive=False, extra="ignore")`
    - All fields with defaults matching .env.example:
      - Project: project_name, debug
      - Postgres: postgres_host, postgres_port, postgres_db, postgres_user, postgres_password
      - SQLAlchemy pool: db_pool_size=20, db_max_overflow=10, db_pool_pre_ping=True
      - Redis: redis_host, redis_port, redis_db, redis_max_connections=50
      - MongoDB: mongo_host, mongo_port, mongo_user, mongo_password, mongo_db
      - MinIO: minio_host, minio_port, minio_access_key, minio_secret_key, minio_bucket
      - Kafka: kafka_bootstrap_servers
      - API keys: fred_api_key (default empty string)
    - `@computed_field` properties: async_database_url (postgresql+asyncpg://...), sync_database_url (postgresql+psycopg2://...), redis_url (redis://...), mongo_url (mongodb://...?authSource=admin)
    - Module-level singleton: `settings = Settings()`

    **src/core/enums.py** -- Create shared enumerations used across all models:
    - `AssetClass(str, Enum)`: FX, EQUITY_INDEX, COMMODITY, FIXED_INCOME, CRYPTO (keep extensible)
    - `Frequency(str, Enum)`: DAILY, WEEKLY, MONTHLY, QUARTERLY, ANNUAL
    - `Country(str, Enum)`: BR, US (extensible later)
    - `CurveType(str, Enum)`: NOMINAL, REAL, BREAKEVEN, SWAP
    - `FlowType(str, Enum)`: COMMERCIAL, FINANCIAL, SWAP_STOCK, NET
    - `FiscalMetric(str, Enum)`: PRIMARY_BALANCE, NOMINAL_BALANCE, GROSS_DEBT, NET_DEBT, REVENUE, EXPENDITURE
    - Use `str` mixin so enum values are their string names (serializable to DB)

    **Makefile:**
    - `up`: `docker compose up -d` (core services only)
    - `up-full`: `docker compose --profile full up -d` (includes Kafka)
    - `down`: `docker compose down`
    - `down-clean`: `docker compose down -v` (removes volumes)
    - `ps`: `docker compose ps`
    - `logs`: `docker compose logs -f`
    - `migrate`: `alembic upgrade head`
    - `migration`: `alembic revision --autogenerate -m "$(msg)"`
    - `install`: `pip install -e ".[dev]"`
    - `lint`: `ruff check src/`
    - `test`: `pytest tests/ -v`
    - `.PHONY` declaration for all targets

    **Startup verification within task:**
    After creating all files, run `docker compose up -d` and `docker compose ps` to confirm services start. Wait up to 60 seconds for health checks. If Docker is not available, log the issue but do not fail the task (files are still correct).
  </action>
  <verify>
    Run: `docker compose -f /home/user/Macro_Trading/docker-compose.yml config --quiet` (validates compose file syntax)
    Run: `python -c "from src.core.config import settings; print(settings.async_database_url); print(settings.redis_url)"`
    Run: `python -c "from src.core.enums import AssetClass, Frequency; print(AssetClass.FX, Frequency.DAILY)"`
    Run: `docker compose up -d && sleep 30 && docker compose ps` (all 4 default services show "healthy")
    All commands succeed. Config prints valid connection URLs. Docker services are running and healthy.
  </verify>
  <done>
    docker-compose.yml defines 5 services with health checks (Kafka behind "full" profile). Running `docker compose up -d` starts TimescaleDB, Redis, MongoDB, MinIO -- all reporting healthy within 60 seconds. Settings singleton loads from .env and produces valid async_database_url, sync_database_url, redis_url, and mongo_url. Enums define AssetClass, Frequency, Country, CurveType, FlowType, FiscalMetric.
  </done>
</task>

</tasks>

<verification>
1. `docker compose up -d` starts 4 services (TimescaleDB, Redis, MongoDB, MinIO) without errors
2. `docker compose ps` shows all 4 services as "healthy"
3. `docker compose --profile full up -d` additionally starts Kafka (5 total services healthy)
4. `python -c "from src.core.config import settings; assert 'asyncpg' in settings.async_database_url; assert 'psycopg2' in settings.sync_database_url; print('Config OK')"` passes
5. `python -c "from src.core.enums import AssetClass; print(list(AssetClass))"` prints enum members
6. All files exist: pyproject.toml, docker-compose.yml, .env.example, .env, Makefile, src/core/config.py, src/core/enums.py
</verification>

<success_criteria>
- Docker Compose stack starts with 4 services healthy (5 with --profile full)
- pydantic-settings configuration loads from .env with all service URLs computed
- Project structure has src/core/, src/connectors/, src/transforms/, src/api/ packages
- pyproject.toml has all 9 core dependencies declared
- Makefile provides `up`, `down`, `migrate`, `install` targets
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
